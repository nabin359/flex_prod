component 
{
  // ------------------------------------------------------------
  // Envelope helpers (added to match sample formatting)
  // ------------------------------------------------------------
  private struct function newResp() {
    return {
      status: 200,
      headers: { explanation: "" },
      content: { status: "success", message: "", data: [], error: [] }
    };
  }

  private void function addError(
    required struct resp,
    required numeric status,
    required string title,
    required string detail
  ) {
    arrayAppend(arguments.resp.content.error, {
      status: toString(arguments.status),
      title: arguments.title,
      detail: arguments.detail
    });
    arguments.resp.headers.explanation = arguments.title;
    arguments.resp.status = arguments.status;
    arguments.resp.content.status = "fail";
  }

  private void function setJsonHeader() {
    cfheader(name = "Content-Type", value = "application/json; charset=UTF-8");
  }

  // Keep exact/desired key casing when serializing query rows
  private array function queryToArrayWithCase(required query q, required array colNames) {
    var rows = [];
    for (var i = 1; i <= q.recordCount; i++) {
      var row = {};
      for (var c in colNames) {
        row[c] = q[c][i]; // CF is case-insensitive for query column lookup
      }
      arrayAppend(rows, row);
    }
    return rows;
  }

  // Generic fallback (not used by getWeekOptions, but kept for parity with sample)
  private array function queryToArray(required query q) {
    var rows = [];
    for (var i = 1; i <= q.recordCount; i++) {
      arrayAppend(rows, queryGetRow(q, i));
    }
    return rows;
  }


  /**
   * Returns the fiscal‐year week 1..52 rows (FY26–FY27 window)
   * Now formatted like sample (envelope + explicit column casing)
   */
remote any function getWeekOptions()
    returnformat="json"
    produces="application/json"
{
    // -----------------------------------------------------
    // Set JSON response header
    // -----------------------------------------------------
    cfheader(
        name = "Content-Type",
        value = "application/json;charset=UTF-8"
    );

    try {
        // -------------------------------------------------
        // Fiscal-year date ranges
        // -------------------------------------------------
        // FY25: 2024-09-28 (Sat) .. 2025-09-26 (Fri)
        // FY26: 2025-09-27 (Sat) .. 2026-09-25 (Fri)
        // FY27: 2026-09-26 (Sat) .. 2027-09-24 (Fri)
        var startFY26 = createDate(2025, 9, 27);
        var endFY27   = createDate(2027, 9, 24);

        var referenceDates = getStartAndEnd();



        // -------------------------------------------------
        // Query weeks from Master_Calendar for FY26 & FY27
        // -------------------------------------------------
        
        var q = queryExecute(
            "
            WITH Ranked AS (
                   SELECT
                      cal_fy_long     AS fiscalYear,
                      cal_fy_wk       AS week,
                      MIN(cal_date_beg_wk) AS startDate,
                      MAX(cal_date_end_wk) AS endDate
                  FROM PCSV_dw.dbo.Master_Calendar
                  WHERE cal_fy_long IN (2026, 2027)
                    AND cal_date_beg_wk >= :startDate
                    AND cal_date_end_wk <= :endDate
                  GROUP BY
                      cal_fy_long,
                      cal_fy_wk
                
            )
            SELECT
                fiscalYear,
                week,
                startDate,
                endDate
            FROM Ranked
            ORDER BY fiscalYear, week
            ",
            {
                startDate = { value = referenceDates.startDate, cfsqltype = "cf_sql_date" },
                endDate   = { value = referenceDates.endDate,   cfsqltype = "cf_sql_date" }
            },
            { datasource = "pcsv_dw" }
        );

        // -------------------------------------------------
        // Return query directly (ColdFusion serializes to JSON)
        // -------------------------------------------------
        return q;

    } catch (any e) {
        // -------------------------------------------------
        // Handle errors gracefully (return structured JSON)
        // -------------------------------------------------
        var err = {
            error   : true,
            message : "getWeekOptions failed: " & e.message,
            detail  : (structKeyExists(e, "detail") ? e.detail : "")
        };
        return err;
    }
}

  /** CAT server detection – robust short/FQDN match with a one-time log */
  private boolean function isCatServer() output="false" {
    var hostName  = "";
    var shortHost = "";
    var catName   = "";

    try {
      var inet = createObject("java", "java.net.InetAddress");
      hostName  = inet.getLocalHost().getHostName();        // e.g. eagnmnwbc1db.usps.gov OR eagnmnwbc1db
      shortHost = listFirst(hostName, ".");                 // always the short name
    } catch (any __inet) {
      writeLog(file="application", text="isCatServer: hostname lookup failed: #__inet.message#");
      return false;
    }

    try {
      var q = queryExecute("
          SELECT TOP 1 srv_name
          FROM var_servers.dbo.var_servers WITH (NOLOCK)
          WHERE srv_active_ind=1 AND srv_web_ind=1 AND srv_cat_ind=1
        ", {}, { datasource: "var_exec_cdv" });
      if (q.recordCount) catName = trim(q.srv_name[1]);
    } catch (any __db) {
      writeLog(file="application", text="isCatServer: CAT lookup failed: #__db.message# :: #__db.detail#");
      return false;
    }

    // Log what we compare (helps once, then you can remove)
    writeLog(file="application", text="isCatServer check → host=#hostName# short=#shortHost# cat=#catName#");

    // Accept match on short host OR contains either way (handles FQDN vs short)
    return (
      len(catName)
      AND (
        compareNoCase(shortHost, catName) EQ 0
        OR findNoCase(catName, hostName) GT 0
        OR findNoCase(hostName, catName) GT 0
      )
    );
  }

  private struct function getStartAndEnd() {

        var result = {};
        var currentYear = year(now());
        var endYear = currentYear + 2;

        var lastDayOfSeptemberCurrentYear = dateAdd(
            "d",
            -1,
            createDate(currentYear, 10, 1)
        );

        var daysToSubtract = (dayOfWeek(lastDayOfSeptemberCurrentYear) - 7 + 7) % 7;

        var startDate = dateAdd(
            "d",
            -daysToSubtract,
            lastDayOfSeptemberCurrentYear
        );


        var lastDayOfSeptemberEndYear = dateAdd(
            "d",
            -1,
            createDate(endYear, 10, 1)
        );

        var daysToSubtractForFuture = (dayOfWeek(lastDayOfSeptemberEndYear) - 7 + 7) % 7;

        var endDatePlusOne = dateAdd(
            "d",
            -daysToSubtractForFuture,
            lastDayOfSeptemberEndYear
        );

        var endDate = dateAdd(
          "d",
          -1,
          endDatePlusOne
        );

        result.startDate = startDate;
        result.endDate = endDate;

        return result;
  }

  /*
   * INSERT flex-time request + OPTIONAL attachment into FILESTREAM table.
   * Accepts either multipart/form-data (FormData) or JSON.
   * Behavior unchanged.
   */
  function post(
    string facility       = "",
    string craft          = "",
    numeric operation     = 0,         // LDC
    string  operationCode = "",
    numeric hours         = 0,
    string  justification = "",
    date    wk_start      = "",
    date    wk_end        = "",
    any     file          = "",        // multipart field name is "file"
    string  filename      = "",
    string  filetype      = "",
    string  notifyEmail   = ""
  ) access="remote" returnFormat="JSON" returnType="any" output="false" {

    var result = { SUCCESS=true, MESSAGE:"", DETAILS:"", REQUESTID=0, ATTACHMENT_SAVED=false };

    // --- Parse body (JSON vs multipart) ---
    var http = getHTTPRequestData();
    var ct   = lcase( toString( http.headers["Content-Type"] ?: http.headers["content-type"] ?: "" ) );
    var payload = {};

    try {
      if ( findNoCase("application/json", ct) AND len(trim(http.content)) ) {
        payload = deserializeJSON(http.content);
      } else {
        // multipart/form-data → rely on FORM scope
        payload = {
          facility      = len(arguments.facility)      ? arguments.facility      : form.facility,
          craft         = len(arguments.craft)         ? arguments.craft         : form.craft,
          operation     = arguments.operation          ? arguments.operation     : val(form.operation),
          operationCode = len(arguments.operationCode) ? arguments.operationCode : toString(form.operationCode),
          hours         = arguments.hours              ? arguments.hours         : val(form.hours),
          justification = len(arguments.justification) ? arguments.justification : form.justification,
          wk_start      = len(arguments.wk_start)      ? arguments.wk_start      : form.wk_start,
          wk_end        = len(arguments.wk_end)        ? arguments.wk_end        : form.wk_end,
          filename      = len(arguments.filename)      ? arguments.filename      : ( structKeyExists(form,"filename") ? form.filename : "" ),
          filetype      = len(arguments.filetype)      ? arguments.filetype      : ( structKeyExists(form,"filetype") ? form.filetype : "" ),
          notifyEmail   = len(arguments.notifyEmail)   ? arguments.notifyEmail   : ( structKeyExists(form,"notifyEmail") ? form.notifyEmail : "" )
        };
      }
    } catch (any ex) {
      writeLog(file="application", text="Flex post parse error: " & ex.message & " :: " & ex.detail);
      return { SUCCESS=false, MESSAGE="Invalid request payload.", DETAILS=ex.detail };
    }

    var createdByVal = structKeyExists(session,"userACE") ? session.userACE : cgi.remote_user;
    // Normalize DOMAIN\user → user (use Chr(92) = backslash)
    if ( find(Chr(92), createdByVal) ) {
      createdByVal = listLast(createdByVal, Chr(92));
    }

    writeLog(file="application", text="Flex post payload => " & serializeJSON(payload));

    // --- 1) Insert request & get ID ---
    try {
      var insertQ = queryExecute(
        "
          INSERT INTO PCSV_dw.dbo.FlexTimeRequests
            (FacilityID, Craft, LabourDistributionCode, OperationNumber,
             HoursPerWeek, Justification, StartDate, EndDate, CreatedBy)
          VALUES
            (:facilityId, :craft, :ldc, :opnum,
             CAST(:hoursPerWeek AS DECIMAL(9,2)), :justification, :wk_start, :wk_end, :createdBy);

          SELECT CAST(SCOPE_IDENTITY() AS INT) AS NewID;
        ",
        {
          facilityId   : { value=payload.facility,      cfsqltype="cf_sql_varchar" },
          craft        : { value=payload.craft,         cfsqltype="cf_sql_varchar" },
          ldc          : { value=payload.operation,     cfsqltype="cf_sql_integer" },
          opnum        : { value=payload.operationCode, cfsqltype="cf_sql_varchar" },
          hoursPerWeek : { value=payload.hours,         cfsqltype="cf_sql_decimal", scale=2 },
          justification: { value=payload.justification, cfsqltype="cf_sql_varchar" },
          wk_start     : { value=payload.wk_start,      cfsqltype="cf_sql_date" },
          wk_end       : { value=payload.wk_end,        cfsqltype="cf_sql_date" },
          createdBy    : { value=createdByVal,          cfsqltype="cf_sql_varchar" }
        },
        { datasource="pcsv_dw" }
      );

      result.REQUESTID = ( structKeyExists(insertQ, "NewID") AND insertQ.recordCount )
        ? val(insertQ.NewID[1]) : 0;

      if ( result.REQUESTID LTE 0 ) {
        return { SUCCESS=false, MESSAGE="Failed to create request (no ID returned)." };
      }
    } catch (any e) {
      writeLog(file="application", text="Flex insert error: " & e.message & " :: " & e.detail);
      return { SUCCESS=false, MESSAGE=e.message, DETAILS=e.detail };
    }

    // --- 2) OPTIONAL attachment → FILESTREAM table ---
    var hadUpload = false;
    var up = {};
    var tmpPath = "";
    var MAX_BYTES = 10 * 1024 * 1024; // 10 MB

    try {
      if ( findNoCase("multipart/form-data", ct) AND structKeyExists(form, "file") ) {
        up = fileUpload( getTempDirectory(), "file", "*", "makeunique" );
        tmpPath   = up.serverDirectory & "/" & up.serverFile;
        hadUpload = fileExists(tmpPath);
        if ( hadUpload AND up.fileSize GT MAX_BYTES ) {
          fileDelete(tmpPath);
          hadUpload = false;
          writeLog(file="application", text="Flex upload skipped: exceeds 10 MB (" & up.fileSize & " bytes).");
        }
      }
    } catch (any upErr) {
      writeLog(file="application", text="Flex upload error: " & upErr.message & " :: " & upErr.detail);
      hadUpload = false;
      if ( len(tmpPath) AND fileExists(tmpPath) ) fileDelete(tmpPath);
    }

    if ( hadUpload ) {
      try {
        var fileBytes = fileReadBinary( tmpPath );
        fileDelete( tmpPath );

        var saveName = len(payload.filename) ? payload.filename : ( up.clientFile ?: up.serverFile );
        var saveType = len(payload.filetype) ? payload.filetype : ( up.contentType ?: "application/octet-stream" );

        queryExecute(
          "
            INSERT INTO PCSV_dw.dbo.FlexTimeFileStorage
              (FileName, FileType, FileContent, UploadedAt, RequestID, RowGuid)
            VALUES
              (:fn, :ft, :fc, GETDATE(), :rid, NEWID())
          ",
          {
            fn  : { value=left(saveName,255),   cfsqltype="cf_sql_varchar" },
            ft  : { value=left(saveType,100),   cfsqltype="cf_sql_varchar" },
            fc  : { value=fileBytes,            cfsqltype="cf_sql_blob" },
            rid : { value=result.REQUESTID,     cfsqltype="cf_sql_integer" }
          },
          { datasource="pcsv_dw" }
        );

        result.ATTACHMENT_SAVED = true;
      } catch (any insErr) {
        writeLog(file="application", text="Flex filestream insert error: " & insErr.message & " :: " & insErr.detail);
        result.ATTACHMENT_SAVED = false;
      }
    }

    // --- EMAIL: send receipt to the submitter (non-blocking) ---
    try {
      sendSubmitEmail( createdByVal, payload, result );
    } catch (any mailErr) {
      writeLog(
        file = "application",
        text = "FlexService.post outer mail error: " & mailErr.message & " :: " & mailErr.detail
      );
    }
    // --- end EMAIL block ---

    // --- Done ---
    result.SUCCESS = true;
    result.MESSAGE = result.ATTACHMENT_SAVED ? "Request submitted; attachment saved." : "Request submitted; no attachment saved.";
    return result;
  }


  // ----------------------------------------------------------------------
  // Helper: send the submit receipt email (unchanged behavior)
  // ----------------------------------------------------------------------
  private void function sendSubmitEmail(
    required string createdByVal,
    required struct payload,
    required struct result
  ) output="false" {

    // Normalize DOMAIN\user → user (Chr(92) = '\')
    var backslash = Chr(92);
    if ( find(backslash, arguments.createdByVal) ) {
      arguments.createdByVal = listLast(arguments.createdByVal, backslash);
    }

    // 1) Resolve recipient (CSAW)
    var toEmail       = "";
    var submitterName = arguments.createdByVal;

    try {
      var qMailQ = new Query();
      qMailQ.setDatasource("pcsv_dw");
      qMailQ.setSQL("
          SELECT TOP 1
                 NULLIF(LTRIM(RTRIM(user_email)),'') AS userEmail,
                 LTRIM(RTRIM(COALESCE(user_fname,'') + ' ' + COALESCE(user_lname,''))) AS userName
            FROM PCSV_csaw.dbo.csaw_pw
           WHERE user_id = :uid
      ");
      qMailQ.addParam( value = arguments.createdByVal, cfsqltype = "cf_sql_varchar" );
      var qMail = qMailQ.execute().getResult();

      if ( qMail.recordCount ) {
        if ( len(trim(qMail.userEmail[1])) ) { toEmail       = trim(qMail.userEmail[1]); }
        if ( len(trim(qMail.userName[1])) )  { submitterName = trim(qMail.userName[1]); }
      }
    } catch (any __lookupErr) {
      // ignore; fallback below
    }

    if ( NOT len(toEmail) AND structKeyExists(arguments.payload, "notifyEmail") ) {
      toEmail = trim( arguments.payload.notifyEmail );
    }

    // 2) Facility display name (optional)
    var facilityName = "";
    try {
      var qFacQ = new Query();
      qFacQ.setDatasource("pcsv_dw");
      qFacQ.setSQL("
          SELECT TOP 1 B_FIN_NAME
            FROM PCSV_dw.dbo.var_base
           WHERE B_FIN_NBR = ?
      ");
      qFacQ.addParam( value = arguments.payload.facility, cfsqltype = "cf_sql_varchar" );
      var qFac = qFacQ.execute().getResult();
      if ( qFac.recordCount ) { facilityName = qFac.B_FIN_NAME[1]; }
    } catch (any __facErr) {
      // ignore
    }

    // 3) Build reqForEmail (plain struct)
    var reqForEmail = structNew();
    reqForEmail.requestId        = arguments.result.REQUESTID;
    reqForEmail.facilityId       = arguments.payload.facility;
    reqForEmail.facilityName     = facilityName;
    reqForEmail.craft            = arguments.payload.craft;
    reqForEmail.ldc              = arguments.payload.operation;
    reqForEmail.operationNumber  = arguments.payload.operationCode;
    reqForEmail.hours            = arguments.payload.hours;
    reqForEmail.justification    = arguments.payload.justification;
    reqForEmail.startDate        = arguments.payload.wk_start & "";
    reqForEmail.endDate          = arguments.payload.wk_end & "";
    reqForEmail.attachmentSaved  = arguments.result.ATTACHMENT_SAVED;
    reqForEmail.submitterName    = submitterName;
    reqForEmail.submitterId      = arguments.createdByVal;

    // 4) Send (DB Mail → CFMAIL fallback) via your MailService
    try {
      if ( len(toEmail) ) {
        var mailer = createObject("component", "ref.api.v1.toolbox.flex.flexmail").init();
        var ok = mailer.sendFlexSubmission( toEmail, reqForEmail );

        writeLog(
          file = "application",
          text = "FlexService.post mail result id=" & arguments.result.REQUESTID &
                 " to=" & toEmail & " ok=" & ok
        );
      } else {
        writeLog(
          file = "application",
          text = "FlexService.post: no recipient email for submitter " & arguments.createdByVal & "; skipping mail."
        );
      }
    } catch (any __sendErr) {
      writeLog(
        file = "application",
        text = "FlexService.post mail exception id=" & arguments.result.REQUESTID &
               " msg=" & __sendErr.message & " :: " & __sendErr.detail
      );
    }
  }



  /**
   * (Optional) Simple download endpoint for latest file on a request.
   * Behavior unchanged.
   */
  function downloadAttachment( required numeric requestID )
    access="remote" returnFormat="plain" output="true" {

    var q = queryExecute("
      SELECT TOP 1 FileName, FileType, FileContent
      FROM PCSV_dw.dbo.FlexTimeFileStorage
      WHERE RequestID = :rid
      ORDER BY UploadedAt DESC
    ", { rid: { value=arguments.requestID, cfsqltype="cf_sql_integer" } }, { datasource="pcsv_dw" });

    if (!q.recordCount) {
      cfheader(statuscode="404", statustext="Not Found");
      writeOutput("No attachment found for RequestID=" & arguments.requestID);
      return;
    }

    var fn = q.FileName[1];
    var ft = len(q.FileType[1]) ? q.FileType[1] : "application/octet-stream";

    cfheader(name="Content-Type", value=ft);
    cfheader(name="Content-Disposition", value='attachment; filename="' & fn & '"');
    cfcontent(type=ft, variable=q.FileContent[1], reset=true);
  }

  /**
   * Compatibility endpoint for index.js::notifyAfterSubmit().
   * Behavior unchanged (no-op send).
   */
  function sendSubmitEmails( numeric requestId = 0 )
    access="remote" returnFormat="JSON" produces="application/json" output="false" {

    setJsonHeader();
    // Intentionally NO-OP to avoid double-send; post() dispatches the submit receipt.
    return { SUCCESS: true, SENT: false, MESSAGE: "Submission receipt was sent during post()." };
  }

    function getMyFacilities(required string userid) access="remote" returnFormat="json" produces="application/json" {
    cfheader( name="Content-Type", value="application/json;charset=UTF-8" );
    local.result = { success: true, message: "", detail: "" };

    try {
        local.sql ="
            select
            b_fin_name,
            b_area,
            b_area_name,
            b_cluster,
            b_cluster_name,
            b_mpoo,
            b_lead_fin_nbr,
            b_lead_name,
            b_fin_name,
            b_fin_nbr
        FROM (
            SELECT
                csaw1.user_area_code as UserAreaCode,
                csaw1.user_district_code as UserDistrictCode,
                csaw1.user_area as AreaAccessInd,
                csaw1.user_district as DistrictAccessInd,
                csaw1.user_unit as UnitAccessInd,
                csaw1.user_fname as UserFirstName,
                csaw1.user_lname as UserLastName,
                csaw2.user_list
            FROM pcsv_csaw.dbo.csaw_pw csaw1 with(nolock)
                inner join
                    (
                        SELECT
                            csaw.user_id user_id , y.value as 'user_list'
                        FROM pcsv_csaw.dbo.csaw_pw csaw with(nolock)
                cross apply string_split(csaw.user_list,',') y
                WHERE user_id = :user_id
            ) csaw2
                on csaw1.user_id=csaw2.user_id
        ) a
        inner join pcsv_dw.dbo.var_base base with(nolock)
        on a.user_list = b_fin_nbr
        ";

        local.q = queryExecute(
            local.sql,
            {
                user_id: { value: arguments.userid, cfsqltype: "cf_sql_varchar" }
            },
            { datasource: "pcsv_dw" }
        );

        return queryToArray( local.q )
    } catch (any e) {
        local.result.success = false;
        local.result.message = e.message;
        local.result.detail = e.detail;
        return local.result;
    }

    return queryToArray( local.queryResult.getResult() )
}

function getAccess(string userid) access="remote" returnFormat="json" produces="application/json" {
        cfheader( name="Content-Type", value="application/json;charset=UTF-8" );
        
        local.sql = "
            select
                UPPER(user_id) as ACE_ID,
                user_idx as user_idx,
                user_area_code as UserAreaCode,
                user_district_code as UserDistrictCode,
                user_area as AreaAccessInd,
                user_district as DistrictAccessInd,
                user_unit as UnitAccessInd,
                user_fname as UserFirstName,
                user_lname as UserLastName,
                user_email as UserEmail,
                user_pw as user_adhoc_ind,
                CASE
                    WHEN len(user_list) >6 THEN LEFT(user_list, CHARINDEX(',', user_list) -1)
                    ELSE user_list
                end AS FirstFinance
            FROM pcsv_csaw.dbo.csaw_pw with(nolock)
            where user_id = :user_id
        ";

        local.q = queryExecute(
            local.sql,
            {
                user_id: { value: arguments.userid, cfsqltype: "cf_sql_varchar" }
            },
            { datasource: "pcsv_dw" }
        )
        
        return queryToArray( local.q )
    }


}



==================================================



component {

  /**
   * Summary metrics used by the cards and chart (user scope).
   */
  remote any function getDashboardData(required string userid)
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    /** filter condition change (user-scoped) **/
    var q = queryExecute(
      "
      SELECT
        COUNT(*) AS total,
        SUM(CASE WHEN Status='Pending'  THEN 1 ELSE 0 END) AS pending,
        SUM(CASE WHEN Status='Approved' THEN 1 ELSE 0 END) AS approved,
        SUM(CASE WHEN Status='Modify'   THEN 1 ELSE 0 END) AS Modified,
        SUM(CASE WHEN Status='Declined' THEN 1 ELSE 0 END) AS declined
      FROM PCSV_dw.dbo.FlexTimeRequests
      WHERE CreatedBy = :uid
      ",
      { uid: { value: arguments.userid, cfsqltype: "cf_sql_varchar" } },
      { datasource: "pcsv_dw" }
    );

    return {
      TOTAL        : q.total,
      PENDING      : q.Pending,
      APPROVED     : q.Approved,
      MODIFICATION : q.Modified,
      DECLINED     : q.Declined
    };
  }


  /**
   * Header values for banner: facility name, current FY and week (user scope).
   */
  remote any function getHeaderData(required string userid)
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var hdr = {};

    // Facility name for the current user (based on any of their requests)
    var qFac = queryExecute(
      "
      SELECT TOP 1
             cp.user_id,
             vb.B_FIN_NAME AS officeName
        FROM PCSV_csaw.dbo.csaw_pw cp
        JOIN PCSV_dw.dbo.FlexTimeRequests ftr
          ON cp.user_id = ftr.CreatedBy
        JOIN PCSV_dw.dbo.var_base vb
          ON ftr.FacilityID = vb.B_FIN_NBR
       WHERE cp.user_id = :uid
       ORDER BY ftr.CreatedDate DESC
      ",
      { uid: { value: arguments.userid, cfsqltype: "cf_sql_varchar" } },
      { datasource: "pcsv_dw" }
    );

    hdr.officeName = qFac.recordCount ? qFac.officeName[1] : "Unknown Facility";

    // Current FY/week from master calendar
    var qWeek = queryExecute(
      "
      SELECT TOP 1
             cal_fy_long AS fiscalYear,
             cal_fy_wk   AS week
        FROM PCSV_dw.dbo.Master_Calendar
       WHERE :today BETWEEN cal_date_beg_wk AND cal_date_end_wk
       ORDER BY cal_id DESC
      ",
      { today: { value: now(), cfsqltype: "cf_sql_timestamp" } },
      { datasource: "pcsv_dw" }
    );

    if ( qWeek.recordCount ) {
      hdr.fiscalYear = qWeek.fiscalYear[1];
      hdr.week       = qWeek.week[1];
    } else {
      hdr.fiscalYear = "";
      hdr.week       = "";
    }

    return hdr;
  }


  /**
   * Returns rows for the user’s table (only their requests).
   * Dynamically pulls AREA/MPOO-like columns if present on var_base.
   */
  remote any function getFlexRequests(required string userid)
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    // --- Detect optional Area / MPOO columns on var_base safely ---
    var areaCandidates = "AREA,AREA_NAME,AREA_DESC,AREA_NM,AREANAME";
    var mpooCandidates = "MPOO,MPOO_GROUP,MPOO_GRP,MPOO_DESC,MPOO_NAME";
    var quoted = listQualify(areaCandidates & "," & mpooCandidates, "'", ",");
    var cols = queryExecute(
      "
      SELECT UPPER(COLUMN_NAME) AS COL
        FROM INFORMATION_SCHEMA.COLUMNS
       WHERE TABLE_SCHEMA = 'dbo'
         AND TABLE_NAME   = 'var_base'
         AND COLUMN_NAME IN (#quoted#)
      ",
      {},
      { datasource: "pcsv_dw" }
    );

    var areaCol = "NULL";
    var mpooCol = "NULL";
    for ( var r = 1; r <= cols.recordCount; r++ ) {
      var c = cols.COL[r];
      if ( areaCol EQ "NULL" AND listFindNoCase(areaCandidates, c) ) areaCol = "vb." & c;
      if ( mpooCol  EQ "NULL" AND listFindNoCase(mpooCandidates, c) ) mpooCol = "vb." & c;
    }

    var areaExpr = areaCol;
    var mpooExpr = mpooCol;

    var raw = queryExecute(
      "
      SELECT
        ftr.RequestID,
        ftr.FacilityID,
        ftr.Craft,
        ftr.LabourDistributionCode,
        ftr.OperationNumber,
        ftr.HoursPerWeek,
        ftr.Justification,
        ftr.Status,
        ftr.ModifiedBy,
        CONVERT(VARCHAR(10), ftr.StartDate, 23) AS StartDate,
        CONVERT(VARCHAR(10), ftr.EndDate,   23) AS EndDate,
        ftr.CreatedBy,
        cp.user_fname,
        cp.user_lname,
        CONVERT(VARCHAR(19), ftr.CreatedDate, 120) AS CreatedOn,

        vb.B_FIN_NAME AS FacilityName,
        #areaExpr#    AS AreaName,
        #mpooExpr#    AS MPOOGroup,

        -- Latest audit comment (optional)
        fta.Comment     AS LatestComment,
        fta.ChangedBy   AS LatestChangedBy,
        CONVERT(VARCHAR(19), fta.ChangedDate, 120) AS LatestChangedDate,

        CASE
          WHEN ISNULL(ftr.Status,'Pending') = 'Modify'                THEN 0
          WHEN ISNULL(ftr.Status,'Pending') <> 'Pending'              THEN 1
          WHEN ftr.ModifiedBy IS NOT NULL                             THEN 1
          WHEN EXISTS (SELECT 1 FROM PCSV_dw.dbo.FlexTimeAudit a
                        WHERE a.RequestID = ftr.RequestID)            THEN 1
          ELSE 0
        END AS IsLocked

      FROM pcsv_dw.dbo.FlexTimeRequests ftr
      LEFT JOIN PCSV_csaw.dbo.csaw_pw cp
              ON ftr.CreatedBy = cp.user_id
      LEFT  JOIN PCSV_dw.dbo.var_base vb
              ON vb.B_FIN_NBR  = ftr.FacilityID

      -- Latest comment per request
      LEFT JOIN (
        SELECT x.RequestID, x.Comment, x.ChangedBy, x.ChangedDate
          FROM (
            SELECT
              a.RequestID, a.Comment, a.ChangedBy, a.ChangedDate,
              ROW_NUMBER() OVER (PARTITION BY a.RequestID ORDER BY a.ChangedDate DESC) AS rn
            FROM PCSV_dw.dbo.FlexTimeAudit a
          ) x
         WHERE x.rn = 1
      ) fta ON fta.RequestID = ftr.RequestID

      WHERE ftr.CreatedBy = :currentUserAce
      ORDER BY CreatedOn DESC
      ",
      { currentUserAce: { value: arguments.userid, cfsqltype: "cf_sql_varchar" } },
      { datasource: "pcsv_dw" }
    );

    var out = [];
    for ( var i = 1; i <= raw.recordCount; i++ ) {
      arrayAppend(out, {
        REQUESTID              : raw["RequestID"][i],
        FACILITYID             : raw["FacilityID"][i],
        FACILITYNAME           : raw["FacilityName"][i],
        AREA                   : raw["AreaName"][i],
        MPOO                   : raw["MPOOGroup"][i],
        CRAFT                  : raw["Craft"][i],
        LABOURDISTRIBUTIONCODE : raw["LabourDistributionCode"][i],
        OPERATIONNUMBER        : raw["OperationNumber"][i],
        HOURSPERWEEK           : raw["HoursPerWeek"][i],
        JUSTIFICATION          : raw["Justification"][i],
        STATUS                 : raw["Status"][i],
        STARTDATE              : raw["StartDate"][i],
        ENDDATE                : raw["EndDate"][i],
        CREATEDBY              : raw["CreatedBy"][i],
        USER_FNAME             : raw["user_fname"][i],
        USER_LNAME             : raw["user_lname"][i],
        CREATEDON              : raw["CreatedOn"][i],
        LOCKED                 : raw["IsLocked"][i],  // 0 or 1
        COMMENT                : raw["LatestComment"][i],
        CHANGEDBY              : raw["LatestChangedBy"][i],
        CHANGEDDATE            : raw["LatestChangedDate"][i]
      });
    }

    return out;
  }


  /**
   * Returns counts by status for each of the last 15 days.
   */
  remote any function getTrendData15Days()
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var q = queryExecute(
      "
      SELECT
        CONVERT(VARCHAR(10), CreatedDate, 23) AS DayDate,  -- YYYY-MM-DD
        COUNT(*) AS Total,
        SUM(CASE WHEN Status='Pending'  THEN 1 ELSE 0 END) AS Pending,
        SUM(CASE WHEN Status='Approved' THEN 1 ELSE 0 END) AS Approved,
        SUM(CASE WHEN Status='Declined' THEN 1 ELSE 0 END) AS Declined
      FROM PCSV_dw.dbo.FlexTimeRequests
      WHERE CreatedDate >= DATEADD(day, -14, GETDATE())
      GROUP BY CONVERT(VARCHAR(10), CreatedDate, 23)
      ORDER BY DayDate
      ",
      [],
      { datasource: "pcsv_dw" }
    );

    var out = [];
    for ( var i = 1; i <= q.recordCount; i++ ) {
      arrayAppend(out, {
        DayDate  : q.DayDate[i],
        Total    : q.Total[i],
        Pending  : q.Pending[i],
        Approved : q.Approved[i],
        Declined : q.Declined[i]
      });
    }

    return out;
  }


  /**
   * Allow the requester (non-admin) to edit their own Pending request,
   * only if the request has NOT been touched by admin.
   *
   * Accepts form/multipart or application/json.
   */
  remote any function updateUserRequest(
    numeric requestId = 0,
    any     hours     = "",     // optional
    string  justification = "", // optional
    string  startDate = "",     // optional, YYYY-MM-DD
    string  endDate   = "",      // optional, YYYY-MM-DD
    required string userid
  ) returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    // Merge JSON body if present
    var http = getHTTPRequestData();
    var ct   = lcase( toString( http.headers["Content-Type"] ?: http.headers["content-type"] ?: "" ) );
    if ( findNoCase("application/json", ct) AND len(trim(http.content)) ) {
      try {
        var j = deserializeJSON(http.content);
        if ( structKeyExists(j,"requestId") )    arguments.requestId    = val(j.requestId);
        if ( structKeyExists(j,"hours") )        arguments.hours        = j.hours;
        if ( structKeyExists(j,"justification") )arguments.justification= toString(j.justification);
        if ( structKeyExists(j,"startDate") )    arguments.startDate    = toString(j.startDate);
        if ( structKeyExists(j,"endDate") )      arguments.endDate      = toString(j.endDate);
      } catch ( any __e ) { /* ignore parse errors */ }
    }

    var rid = val(arguments.requestId);
    if ( rid LTE 0 ) return { SUCCESS:false, MESSAGE:"requestId is required." };

    // Verify ownership + lock condition
    var row = queryExecute(
      "
      SELECT TOP 1
             CreatedBy,
             ISNULL(Status,'Pending') AS CurrStatus,
             CASE
               WHEN ISNULL(Status,'Pending') = 'Modify' THEN 0
               WHEN ISNULL(Status,'Pending') <> 'Pending' THEN 1
               WHEN ModifiedBy IS NOT NULL THEN 1
               WHEN EXISTS (SELECT 1 FROM PCSV_dw.dbo.FlexTimeAudit a WHERE a.RequestID = :rid) THEN 1
               ELSE 0
             END AS IsLocked
        FROM PCSV_dw.dbo.FlexTimeRequests
       WHERE RequestID = :rid
      ",
      { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
      { datasource: "pcsv_dw" }
    );

    if ( !row.recordCount )                     return { SUCCESS:false, MESSAGE:"Request not found." };
    if ( row.CreatedBy[1] NEQ arguments.userid ) return { SUCCESS:false, MESSAGE:"Not your request." };
    if ( row.IsLocked[1] )                      return { SUCCESS:false, MESSAGE:"Request is locked by admin; cannot modify." };

    // Build dynamic SET clause
    var sets   = [];
    var params = { rid: { value: rid, cfsqltype: "cf_sql_integer" } };

    if ( structKeyExists(arguments,"hours") AND isNumeric(arguments.hours) ) {
      arrayAppend(sets, "HoursPerWeek = :hours");
      params.hours = { value: arguments.hours, cfsqltype: "cf_sql_numeric" };
    }
    if ( len(arguments.justification) ) {
      arrayAppend(sets, "Justification = :justification");
      params.justification = { value: arguments.justification, cfsqltype: "cf_sql_varchar" };
    }
    if ( len(arguments.startDate) ) {
      arrayAppend(sets, "StartDate = :sd");
      params.sd = { value: arguments.startDate, cfsqltype: "cf_sql_date" };
    }
    if ( len(arguments.endDate) ) {
      arrayAppend(sets, "EndDate = :ed");
      params.ed = { value: arguments.endDate, cfsqltype: "cf_sql_date" };
    }

    if ( arrayLen(sets) EQ 0 ) return { SUCCESS:false, MESSAGE:"No updatable fields provided." };

    try {
      queryExecute(
        "UPDATE PCSV_dw.dbo.FlexTimeRequests SET #arrayToList(sets, ', ')# WHERE RequestID = :rid",
        params,
        { datasource: "pcsv_dw" }
      );

      // Flip back to Pending if previous status was Modify
      if ( compareNoCase(row.CurrStatus[1], "Modify") EQ 0 ) {
        queryExecute(
          "
          UPDATE PCSV_dw.dbo.FlexTimeRequests
             SET Status = 'Pending',
                 ModifiedBy = NULL,
                 ModifiedDate = GETDATE()
           WHERE RequestID = :rid
          ",
          { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
          { datasource: "pcsv_dw" }
        );
      }

      var q = queryExecute(
        "
        SELECT
          RequestID, FacilityID, Craft, LabourDistributionCode, OperationNumber,
          HoursPerWeek, Justification, Status,
          CONVERT(VARCHAR(10), StartDate, 23) AS StartDate,
          CONVERT(VARCHAR(10), EndDate,   23) AS EndDate,
          CreatedBy, CONVERT(VARCHAR(19), CreatedDate, 120) AS CreatedOn
        FROM PCSV_dw.dbo.FlexTimeRequests
        WHERE RequestID = :rid
        ",
        { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
        { datasource: "pcsv_dw" }
      );

      if ( !q.recordCount ) return { SUCCESS:false, MESSAGE:"Reload failed." };

      var data = {
        REQUESTID              : q.RequestID[1],
        FACILITYID             : q.FacilityID[1],
        CRAFT                  : q.Craft[1],
        LABOURDISTRIBUTIONCODE : q.LabourDistributionCode[1],
        OPERATIONNUMBER        : q.OperationNumber[1],
        HOURSPERWEEK           : q.HoursPerWeek[1],
        JUSTIFICATION          : q.Justification[1],
        STATUS                 : q.Status[1],
        STARTDATE              : q.StartDate[1],
        ENDDATE                : q.EndDate[1],
        CREATEDBY              : q.CreatedBy[1],
        CREATEDON              : q.CreatedOn[1]
      };

      // --- EMAIL: confirm user edit (non-blocking) ---
      try {
        var createdByAce = ( row.recordCount ? toString(row.CreatedBy[1]) : "" );
        var toEmail = "";
        var uname   = "";

        if ( len(createdByAce) ) {
          var mailQ = queryExecute(
            "
            SELECT TOP 1
                   NULLIF(LTRIM(RTRIM(COALESCE(user_email, email, mail))), '') AS userEmail,
                   LTRIM(RTRIM(COALESCE(user_fname,'') + ' ' + COALESCE(user_lname,''))) AS userName
              FROM PCSV_csaw.dbo.csaw_pw
             WHERE user_id = :uid
            ",
            { uid: { value: createdByAce, cfsqltype: "cf_sql_varchar" } },
            { datasource: "pcsv_dw" }
          );
          if ( mailQ.recordCount ) {
            toEmail = trim(mailQ.userEmail[1] ?: "");
            uname   = trim(mailQ.userName[1]  ?: "");
          }
        }

        if ( len(toEmail) ) {
          var mailer = new ref.api.v1.toolbox.flex.flexmail();
          var reqForEmail = {
            requestId       : q.RequestID[1],
            facilityId      : q.FacilityID[1],
            craft           : q.Craft[1],
            ldc             : q.LabourDistributionCode[1],
            operationNumber : q.OperationNumber[1],
            hours           : q.HoursPerWeek[1],
            justification   : q.Justification[1],
            startDate       : q.StartDate[1],
            endDate         : q.EndDate[1],
            attachmentSaved : false,
            submitterName   : uname
          };
          mailer.sendFlexUserEdited( toEmail = toEmail, req = reqForEmail );
        }
      } catch ( any __mailErr ) {
        writeLog(file="application", text="dashboardservice.updateUserRequest mail error: #__mailErr.message# :: #__mailErr.detail#");
      }

      return { SUCCESS:true, MESSAGE:"Updated.", DATA:data };

    } catch ( any e ) {
      writeLog(file="application", text="updateUserRequest error: " & e.message & " :: " & e.detail);
      return { SUCCESS:false, MESSAGE:e.message, DETAILS:e.detail };
    }
  }


  /**
   * Allow the requester to delete their own Pending request,
   * only if the request has NOT been touched by admin.
   */
  remote any function deleteUserRequest(
    numeric requestId = 0,
    required string userid
  ) returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var rid = val(arguments.requestId);

    // Support JSON body as well
    var http = getHTTPRequestData();
    var ct   = lcase( toString( http.headers["Content-Type"] ?: http.headers["content-type"] ?: "" ) );
    if ( findNoCase("application/json", ct) AND len(trim(http.content)) ) {
      try {
        var j = deserializeJSON(http.content);
        if ( structKeyExists(j,"requestId") ) rid = val(j.requestId);
      } catch ( any __e ) { /* ignore */ }
    }

    if ( rid LTE 0 ) return { SUCCESS:false, MESSAGE:"requestId is required." };

    var row = queryExecute(
      "
      SELECT TOP 1
             CreatedBy,
             ISNULL(Status,'Pending') AS CurrStatus,
             CASE
               WHEN ISNULL(Status,'Pending') = 'Modify' THEN 0
               WHEN ISNULL(Status,'Pending') <> 'Pending' THEN 1
               WHEN ModifiedBy IS NOT NULL THEN 1
               WHEN EXISTS (SELECT 1 FROM PCSV_dw.dbo.FlexTimeAudit a WHERE a.RequestID = :rid) THEN 1
               ELSE 0
             END AS IsLocked
        FROM PCSV_dw.dbo.FlexTimeRequests
       WHERE RequestID = :rid
      ",
      { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
      { datasource: "pcsv_dw" }
    );

    if ( !row.recordCount )                    return { SUCCESS:false, MESSAGE:"Request not found." };
    if ( row.CreatedBy[1] NEQ arguments.userid )return { SUCCESS:false, MESSAGE:"Not your request." };
    if ( row.IsLocked[1] )                     return { SUCCESS:false, MESSAGE:"Request is locked by admin; cannot delete." };

    // Prefetch minimal row to include in email
    var prev = queryExecute(
      "
      SELECT TOP 1
             RequestID, FacilityID, Craft, LabourDistributionCode, OperationNumber,
             HoursPerWeek, CONVERT(VARCHAR(10), StartDate, 23) AS StartDate,
             CONVERT(VARCHAR(10), EndDate,   23) AS EndDate, CreatedBy, Justification
        FROM PCSV_dw.dbo.FlexTimeRequests
       WHERE RequestID = :rid
      ",
      { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
      { datasource: "pcsv_dw" }
    );

    try {
      transaction {
        queryExecute(
          "DELETE FROM PCSV_dw.dbo.FlexTimeFileStorage WHERE RequestID = :rid",
          { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
          { datasource: "pcsv_dw" }
        );

        queryExecute(
          "DELETE FROM PCSV_dw.dbo.FlexTimeRequests WHERE RequestID = :rid",
          { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
          { datasource: "pcsv_dw" }
        );
      }

      // --- EMAIL: confirm user delete (non-blocking) ---
      try {
        var createdByAce = ( prev.recordCount ? toString(prev.CreatedBy[1]) : "" );
        var toEmail = "";
        var uname   = "";

        if ( len(createdByAce) ) {
          var mailQ = queryExecute(
            "
            SELECT TOP 1
                   NULLIF(LTRIM(RTRIM(COALESCE(user_email, email, mail))), '') AS userEmail,
                   LTRIM(RTRIM(COALESCE(user_fname,'') + ' ' + COALESCE(user_lname,''))) AS userName
              FROM PCSV_csaw.dbo.csaw_pw
             WHERE user_id = :uid
            ",
            { uid: { value: createdByAce, cfsqltype: "cf_sql_varchar" } },
            { datasource: "pcsv_dw" }
          );
          if ( mailQ.recordCount ) {
            toEmail = trim(mailQ.userEmail[1] ?: "");
            uname   = trim(mailQ.userName[1]  ?: "");
          }
        }

        if ( len(toEmail) ) {
          var mailer = new ref.api.v1.toolbox.flex.flexmail();
          var reqForEmail = {
            requestId       : prev.RequestID[1],
            facilityId      : prev.FacilityID[1],
            craft           : prev.Craft[1],
            ldc             : prev.LabourDistributionCode[1],
            operationNumber : prev.OperationNumber[1],
            hours           : prev.HoursPerWeek[1],
            justification   : prev.Justification[1],
            startDate       : prev.StartDate[1],
            endDate         : prev.EndDate[1],
            submitterName   : uname,
            submitterId     : createdByAce
          };
          mailer.sendFlexUserEdited( toEmail = toEmail, req = reqForEmail );
        }
      } catch ( any __mailErr ) {
        writeLog(file="application", text="dashboardservice.deleteUserRequest mail error: #__mailErr.message# :: #__mailErr.detail#");
      }

      return { SUCCESS:true, MESSAGE:"Deleted." };

    } catch ( any e ) {
      writeLog(file="application", text="deleteUserRequest error: " & e.message & " :: " & e.detail);
      return { SUCCESS:false, MESSAGE:e.message, DETAILS:e.detail };
    }
  }

   function getMyFacilities(required string userid) access="remote" returnFormat="json" produces="application/json" {
        cfheader( name="Content-Type", value="application/json;charset=UTF-8" );
        local.result = { success: true, message: "", detail: "" };

        try {
            local.sql ="
                select
                b_fin_name,
                b_area,
                b_area_name,
                b_cluster,
                b_cluster_name,
                b_mpoo,
                b_lead_fin_nbr,
                b_lead_name,
                b_fin_name,
                b_fin_nbr
            FROM (
                SELECT
                    csaw1.user_area_code as UserAreaCode,
                    csaw1.user_district_code as UserDistrictCode,
                    csaw1.user_area as AreaAccessInd,
                    csaw1.user_district as DistrictAccessInd,
                    csaw1.user_unit as UnitAccessInd,
                    csaw1.user_fname as UserFirstName,
                    csaw1.user_lname as UserLastName,
                    csaw2.user_list
                FROM pcsv_csaw.dbo.csaw_pw csaw1 with(nolock)
                    inner join
                        (
                            SELECT
                                csaw.user_id user_id , y.value as 'user_list'
                            FROM pcsv_csaw.dbo.csaw_pw csaw with(nolock)
                    cross apply string_split(csaw.user_list,',') y
                    WHERE user_id = :user_id
                ) csaw2
                    on csaw1.user_id=csaw2.user_id
            ) a
            inner join pcsv_dw.dbo.var_base base with(nolock)
            on a.user_list = b_fin_nbr
            ";

            local.q = queryExecute(
                local.sql,
                {
                    user_id: { value: arguments.userid, cfsqltype: "cf_sql_varchar" }
                },
                { datasource: "pcsv_dw" }
            );

            return queryToArray( local.q )
        } catch (any e) {
            local.result.success = false;
            local.result.message = e.message;
            local.result.detail = e.detail;
            return local.result;
        }

        return queryToArray( local.queryResult.getResult() )
    }

    public array function queryToArray( required query data ) {
        var local = StructNew();

        local.Columns = ListToArray( arguments.data.ColumnList );
        local.QueryArray = ArrayNew( 1 );

        for (local.RowIndex = 1; local.RowIndex LTE arguments.data.RecordCount; local.RowIndex = (Local.RowIndex + 1)) {
        local.Row = StructNew();

        for (local.ColumnIndex = 1; local.ColumnIndex LTE ArrayLen( local.Columns ); local.ColumnIndex = (Local.ColumnIndex + 1)) {
            local.ColumnName = local.Columns[local.ColumnIndex];
            local.Row[local.ColumnName] = arguments.data[local.ColumnName][local.RowIndex];
        }

        ArrayAppend( local.QueryArray, local.Row );
        };

        return ( local.QueryArray )
  }


}



===========================================================

component {

  // --- server-side admin check (keep in sync with your front-end list) ---
  private boolean function isAdminUser(required string ace) output="false" {

    // TODO: move to DB later; for now keep it hard-coded
    var ADMIN_WHITELIST = "DG4QJ0,BR5TBB,KWC2RJ";
    return len(ace) AND listFindNoCase(ADMIN_WHITELIST, ace) GT 0;
  }


  /**
   * Summary metrics used by the cards and chart.
   */
  remote any function getDashboardData()
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var q = queryExecute(
      "
      SELECT
        COUNT(*) AS total,
        SUM(CASE WHEN Status='Pending'  THEN 1 ELSE 0 END) AS pending,
        SUM(CASE WHEN Status='Approved' THEN 1 ELSE 0 END) AS approved,
        SUM(CASE WHEN Status='Modify'   THEN 1 ELSE 0 END) AS modified,
        SUM(CASE WHEN Status='Declined' THEN 1 ELSE 0 END) AS declined
      FROM PCSV_dw.dbo.FlexTimeRequests
      ",
      {},
      { datasource = "pcsv_dw" }
    );

    if ( !q.recordCount ) {
      return { TOTAL:0, PENDING:0, APPROVED:0, MODIFICATION:0, DECLINED:0 };
    }

    return {
      TOTAL        : val(q.total[1]),
      PENDING      : val(q.pending[1]),
      APPROVED     : val(q.approved[1]),
      MODIFICATION : val(q.modified[1]),
      DECLINED     : val(q.declined[1])
    };
  }


  /**
   * Returns the rows for the table.
   * NOTE: If you want admins to see ALL requests, remove the WHERE CreatedBy = :currentUserAce.
   */
  remote any function getFlexRequests(required string userid, required numeric year)
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    // show only rows from Jan 1, 2025 onward
    var startFrom = createDate(year, 1, 1);
    var endAt = createDate(year + 1, 1, 1)

    var params  = { startFrom: { value:startFrom, cfsqltype:"cf_sql_date" }, endAt: { value:endAt, cfsqltype:"cf_sql_date" } };
    var isAdmin = isAdminUser(arguments.userid);

    var sql = "
      WITH LatestAudit AS (
        SELECT
          a.RequestID,
          a.Comment,
          a.ChangedBy,
          a.ChangedDate,
          a.OldStatus,
          a.NewStatus,
          ROW_NUMBER() OVER (PARTITION BY a.RequestID ORDER BY a.ChangedDate DESC, a.AuditID DESC) AS rn
        FROM PCSV_dw.dbo.FlexTimeAudit a
      ),
      LatestFile AS (
        SELECT z.RequestID, z.FileId, z.FileName
        FROM (
          SELECT
            f.RequestID, f.FileId, f.FileName, f.UploadedAt,
            ROW_NUMBER() OVER (PARTITION BY f.RequestID ORDER BY f.UploadedAt DESC, f.FileId DESC) AS rn
          FROM PCSV_dw.dbo.FlexTimeFileStorage f
        ) z WHERE z.rn = 1
      )
      SELECT
        ftr.RequestID,
        ftr.FacilityID,
        vb.B_FIN_NAME               AS FacilityName,
        ftr.Craft,
        ftr.LabourDistributionCode,
        ftr.OperationNumber,
        ftr.HoursPerWeek,
        ftr.Justification,
        ftr.Status,
        CONVERT(VARCHAR(10), ftr.StartDate, 23) AS StartDate,
        CONVERT(VARCHAR(10), ftr.EndDate,   23) AS EndDate,
        ftr.CreatedBy,
        cp.user_fname,
        cp.user_lname,
        CONVERT(VARCHAR(19), ftr.CreatedDate, 120) AS CreatedOn,
        la.Comment,
        la.ChangedBy,
        CONVERT(VARCHAR(19), la.ChangedDate, 120)  AS ChangedDate,
        lf.FileId,
        lf.FileName
      FROM pcsv_dw.dbo.FlexTimeRequests AS ftr
      LEFT JOIN PCSV_csaw.dbo.csaw_pw AS cp 
        ON ftr.CreatedBy = cp.user_id
      LEFT JOIN PCSV_dw.dbo.var_base vb
        ON vb.B_FIN_NBR = ftr.FacilityID
      LEFT JOIN LatestAudit la
        ON la.RequestID = ftr.RequestID AND la.rn = 1
      LEFT JOIN LatestFile lf
        ON lf.RequestID = ftr.RequestID
      WHERE ftr.CreatedDate >= :startFrom AND ftr.CreatedDate < :endAt
      ORDER BY ftr.CreatedDate DESC";
  
    var raw = queryExecute(sql, params, { datasource:"pcsv_dw" });

    var cleaned = [];
    for ( var i = 1; i <= raw.recordCount; i++ ) {
      var id     = raw["RequestID"][i];
      var fileId = raw["FileId"][i];
      var fname  = raw["FileName"][i];

      var hasFile        = isNumeric(fileId) AND val(fileId) GT 0;
      var attachmentUrl  = "";
      var attachmentName = "";

      if ( hasFile ) {
        attachmentUrl  = "/ref/api/v1/toolbox/flex/flex.cfc?method=downloadAttachment&requestID=" & id;
        if ( isSimpleValue(fname) AND len(trim(toString(fname))) ) {
          attachmentName = fname;
        }
      }

      arrayAppend(cleaned, {
        REQUESTID              : id,
        FACILITYID             : raw["FacilityID"][i],
        FACILITYNAME           : raw["FacilityName"][i],
        CRAFT                  : raw["Craft"][i],
        LABOURDISTRIBUTIONCODE : raw["LabourDistributionCode"][i],
        OPERATIONNUMBER        : raw["OperationNumber"][i],
        HOURSPERWEEK           : raw["HoursPerWeek"][i],
        JUSTIFICATION          : raw["Justification"][i],
        STATUS                 : raw["Status"][i],
        STARTDATE              : raw["StartDate"][i],
        ENDDATE                : raw["EndDate"][i],
        CREATEDBY              : raw["CreatedBy"][i],
        USER_FNAME             : raw["user_fname"][i],
        USER_LNAME             : raw["user_lname"][i],
        CREATEDON              : raw["CreatedOn"][i],
        COMMENT                : raw["Comment"][i],
        CHANGEDBY              : raw["ChangedBy"][i],
        CHANGEDDATE            : raw["ChangedDate"][i],
        ATTACHMENTURL          : attachmentUrl,
        ATTACHMENTNAME         : attachmentName
      });
    }

    return cleaned;
  }


  /**
   * Header values for banner: facility name, current FY and week.
   * Keeps Master_Calendar as source of truth; if it returns nothing,
   * fallback computes FY start as the last Saturday in September.
   */
  remote any function getHeaderData(required string userid)
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var hdr = {};

    // ---------- Office/Facility name ----------
    var qFac = queryExecute(
      "
      SELECT TOP 1 vb.B_FIN_NAME AS officeName
      FROM PCSV_csaw.dbo.csaw_pw cp
      JOIN PCSV_dw.dbo.FlexTimeRequests ftr ON cp.user_id = ftr.CreatedBy
      JOIN PCSV_dw.dbo.var_base vb          ON ftr.FacilityID = vb.B_FIN_NBR
      WHERE cp.user_id = :uid
      ORDER BY ftr.CreatedDate DESC
      ",
      { uid: { value:arguments.userid, cfsqltype:"cf_sql_varchar" } },
      { datasource:"pcsv_dw" }
    );

    hdr.officeName = qFac.recordCount ? qFac.officeName[1] : "";

    if ( !len(hdr.officeName) ) {
      var qLast = queryExecute(
        "
        SELECT TOP 1 vb.B_FIN_NAME AS officeName
        FROM PCSV_dw.dbo.FlexTimeRequests f
        LEFT JOIN PCSV_dw.dbo.var_base vb ON vb.B_FIN_NBR = f.FacilityID
        ORDER BY f.CreatedDate DESC
        ",
        {},
        { datasource:"pcsv_dw" }
      );
      if ( qLast.recordCount ) hdr.officeName = qLast.officeName[1];
    }
    if ( !len(hdr.officeName) ) hdr.officeName = "Multiple Facilities";

    // ---------- Fiscal Year & Week (today) ----------
    // 1) Primary: strict "between" match using DATE param
    var qWeek = queryExecute(
      "
      SELECT TOP 1 cal_fy_long AS fiscalYear, cal_fy_wk AS week
      FROM PCSV_dw.dbo.Master_Calendar
      WHERE :todayDate BETWEEN cal_date_beg_wk AND cal_date_end_wk
      ORDER BY cal_id DESC
      ",
      { todayDate: { value:now(), cfsqltype:"cf_sql_date" } },
      { datasource:"pcsv_dw" }
    );

    if ( qWeek.recordCount ) {
      hdr.fiscalYear = qWeek.fiscalYear[1];
      hdr.week       = qWeek.week[1];
      return hdr;
    }

    // 2) Fallback from table: pick the latest week whose begin <= today
    var qWeek2 = queryExecute(
      "
      SELECT TOP 1 cal_fy_long AS fiscalYear, cal_fy_wk AS week
      FROM PCSV_dw.dbo.Master_Calendar
      WHERE cal_date_beg_wk <= :todayDate
      ORDER BY cal_date_beg_wk DESC, cal_id DESC
      ",
      { todayDate: { value:now(), cfsqltype:"cf_sql_date" } },
      { datasource:"pcsv_dw" }
    );

    if ( qWeek2.recordCount ) {
      hdr.fiscalYear = qWeek2.fiscalYear[1];
      hdr.week       = qWeek2.week[1];
      return hdr;
    }

    // 3) Last resort: compute USPS FY/Week (last Saturday of September)
    var today    = now();
    var thisYear = year(today);

    var septLast = createDate(thisYear, 9, 30);
    var backDays = ( dayOfWeek(septLast) mod 7 ); // Sat -> 0
    var lastSat  = dateAdd("d", -backDays, septLast);

    var fyStart = (
      today < lastSat
        ? dateAdd("d", -(dayOfWeek(createDate(thisYear-1, 9, 30)) mod 7), createDate(thisYear-1, 9, 30))
        : lastSat
    );

    hdr.fiscalYear = year(fyStart) + 1;

    var todayDateOnly   = parseDateTime( dateFormat(today,   "yyyy-mm-dd") );
    var fyStartDateOnly = parseDateTime( dateFormat(fyStart, "yyyy-mm-dd") );
    var daysIn          = dateDiff("d", fyStartDateOnly, todayDateOnly);
    var weekNum         = 1 + int( daysIn / 7 );

    hdr.week = weekNum;

    return hdr;
  }


  /**
   * Update request status and insert audit row, then email the requester.
   * Returns {SUCCESS, MESSAGE}.
   */
  remote any function updateRequest(required string userid)
    returnFormat="JSON" produces="application/json" output="false" {

    // ---- read payload safely ----
    var payload = {};
    try {
      var http = getHTTPRequestData();
      if ( structKeyExists(http, "content") AND len(trim(http.content)) ) {
        payload = deserializeJSON(http.content);
      }
    } catch ( any __p ) {
      payload = {};
    }

    var reqID   = ( structKeyExists(payload, "requestID") ? val(payload.requestID)   : 0  );
    var newStat = ( structKeyExists(payload, "status")    ? toString(payload.status) : "" );
    var comment = ( structKeyExists(payload, "comment")   ? toString(payload.comment): "" );

    var result = { SUCCESS:false, MESSAGE:"" };

    try {
      transaction {
        // ---- 0) Read current (OLD) status FIRST ----
        var qCur = queryExecute(
          "SELECT TOP 1 Status FROM PCSV_dw.dbo.FlexTimeRequests WHERE RequestID = :rid",
          { rid: { value:reqID, cfsqltype:"cf_sql_integer" } },
          { datasource:"pcsv_dw" }
        );
        if ( !qCur.recordCount ) {
          result.SUCCESS = false;
          result.MESSAGE = "Request not found.";
          return result;
        }
        var oldStat = qCur.Status[1];

        // Idempotent: no change → skip update/audit
        if ( compareNoCase(oldStat, newStat) EQ 0 ) {
          result.SUCCESS = true;
          result.MESSAGE = "No status change.";
          return result;
        }

        // ---- 1) Update status on the canonical row ----
        queryExecute(
          "
          UPDATE PCSV_dw.dbo.FlexTimeRequests
             SET Status       = :newStatus,
                 ModifiedBy   = :user,
                 ModifiedDate = GETDATE()
           WHERE RequestID    = :reqID
          ",
          {
            newStatus : { value:newStat,         cfsqltype:"cf_sql_varchar" },
            user      : { value:arguments.userid, cfsqltype:"cf_sql_varchar" },
            reqID     : { value:reqID,           cfsqltype:"cf_sql_integer" }
          },
          { datasource:"pcsv_dw" }
        );

        // ---- 2) Insert ONE audit row using the captured old/new ----
        queryExecute(
          "
          INSERT INTO PCSV_dw.dbo.FlexTimeAudit
            (RequestID, Comment, ChangedBy, ChangedDate, OldStatus, NewStatus)
          VALUES
            (:reqID, :cmnt, :user, GETDATE(), :oldStatus, :newStatus)
          ",
          {
            reqID     : { value:reqID,           cfsqltype:"cf_sql_integer" },
            cmnt      : { value:comment,         cfsqltype:"cf_sql_varchar" },
            user      : { value:arguments.userid, cfsqltype:"cf_sql_varchar" },
            oldStatus : { value:oldStat,         cfsqltype:"cf_sql_varchar" },
            newStatus : { value:newStat,         cfsqltype:"cf_sql_varchar" }
          },
          { datasource:"pcsv_dw" }
        );
      } // transaction

      // ---- 3) Email requester (unchanged) ----
      try {
        var r = queryExecute(
          "
          SELECT TOP 1
            f.RequestID, f.FacilityID, f.Craft, f.LabourDistributionCode, f.OperationNumber,
            f.HoursPerWeek, f.Justification,
            CONVERT(VARCHAR(10), f.StartDate, 23) AS StartDate,
            CONVERT(VARCHAR(10), f.EndDate,   23) AS EndDate,
            f.CreatedBy,
            vb.B_FIN_NAME AS FacilityName,
            LTRIM(RTRIM(COALESCE(pw.user_fname,'') + ' ' + COALESCE(pw.user_lname,''))) AS UserName,
            NULLIF(LTRIM(RTRIM(pw.user_email)), '') AS UserEmail
          FROM PCSV_dw.dbo.FlexTimeRequests f
          LEFT JOIN PCSV_dw.dbo.var_base vb ON vb.B_FIN_NBR = f.FacilityID
          LEFT JOIN PCSV_csaw.dbo.csaw_pw pw ON pw.user_id   = f.CreatedBy
          WHERE f.RequestID = :rid
          ",
          { rid: { value:reqID, cfsqltype:"cf_sql_integer" } },
          { datasource:"pcsv_dw" }
        );

        if ( r.recordCount ) {
          var toEmail = "";
          if ( structKeyExists(r, "UserEmail") AND len( trim( r.UserEmail[1] ) ) ) {
            toEmail = trim( r.UserEmail[1] );
          }

          if ( len(toEmail) ) {
            var subj = "Flex Time " & newStat & " (ID " & reqID & ")";

            var uname = r.UserName[1]       ?: "";
            var facId = r.FacilityID[1]     ?: "";
            var facNm = r.FacilityName[1]   ?: "";
            var craft = r.Craft[1]          ?: "";
            var ldc   = r.LabourDistributionCode[1] ?: "";
            var op    = r.OperationNumber[1] ?: "";
            var hrs   = r.HoursPerWeek[1]   ?: "";
            var sd    = r.StartDate[1]      ?: "";
            var ed    = r.EndDate[1]        ?: "";

            var parts = [];
            arrayAppend(parts, "<p>Hello" & ( len(uname) ? " " & htmlEditFormat(uname) : "" ) & ",</p>");
            if(newStat == "Modify") {
              arrayAppend(parts, "<p>Your Flex Time request was <b>requested for modification.</b></p>");
            } else {
              arrayAppend(parts, "<p>Your Flex Time request was <b>" & htmlEditFormat(newStat) & "</b></p>");
            }

            if ( len(trim(comment)) ) {
              arrayAppend(parts, "<p><b>Comment</b><br>" & htmlEditFormat(comment) & "</p>");
            }

            var details = "<p>";
            details &= "<b>Facility</b> " & htmlEditFormat(facId);
            if ( len(facNm) ) details &= " - " & htmlEditFormat(facNm);
            if ( len(craft) ) details &= "<br><b>Craft</b> " & htmlEditFormat(craft);
            if ( len(ldc) )   details &= "<br><b>LDC</b> "   & htmlEditFormat(ldc);
            if ( len(op) )    details &= "<br><b>Operation</b> " & htmlEditFormat(op);
            if ( len( hrs & "" ) ) details &= "<br><b>Hours Per Week</b> " & htmlEditFormat( hrs & "" );
            details &= "<br><b>Dates</b> " & htmlEditFormat(sd) & " to " & htmlEditFormat(ed) & "</p>";

            arrayAppend(parts, details);
            arrayAppend(parts, "<p><a href=""https://eagnmnwbp161f.usps.gov/ref/toolbox/flex/dashboard.html"">Open dashboard</a></p>");

            var html = arrayToList(parts, "");

             var mailer = createObject("component", "ref.api.v1.toolbox.flex.flexmail").init();
            var ok = mailer.sendStatusChangeEmail( toEmail, reqID, subj, html ); 
            writeLog(file="application", text="Attempted to send email and result is: " &ok)

            // mail(
            //   to      = toEmail,
            //   from    = "Workhour Efficiency <workhourefficiencysupport@usps.gov>",
            //   subject = subj,
            //   type    = "html"
            // ) {
            //   writeOutput(html);
            // }
          }
        }
      } catch ( any __mailErr ) {
        writeLog(file="application", text="admindashboardservice.updateRequest email error: " & __mailErr.message & " :: " & __mailErr.detail);
      }

      result.SUCCESS = true;
      result.MESSAGE = "Status updated to " & newStat;

    } catch ( any e ) {
      writeLog(file="application", text="admin updateRequest error: " & e.message & " :: " & e.detail);
      result.SUCCESS = false;
      result.MESSAGE = "Error: " & e.message;
    }

    return result;
  }


  /**
   * Update fields for a request (existing behavior preserved).
   */
  remote any function updateRequestFields(
    numeric requestId       = 0,
    string  facility        = "",
    string  craft           = "",
    numeric ldc             = 0,
    string  operationNumber = "",
    string  hours           = "",
    string  justification   = "",
    string  startDate       = "",
    string  endDate         = "",
    string  status          = "",
    required string userid
  ) returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var result = { SUCCESS:false, MESSAGE:"", REQUESTID:0, DATA:{} };

    try {
      var http = getHTTPRequestData();
      var ct   = lcase( toString( http.headers["Content-Type"] ?: http.headers["content-type"] ?: "" ) );

      if ( findNoCase("application/json", ct) AND len(trim(http.content)) ) {
        var body = deserializeJSON(http.content);

        if ( structKeyExists(body, "requestID") AND NOT structKeyExists(body, "requestId") ) {
          body.requestId = body.requestID;
        }

        if ( structKeyExists(body, "requestId") )       requestId       = val(body.requestId);
        if ( structKeyExists(body, "facility") )        facility        = toString(body.facility);
        if ( structKeyExists(body, "craft") )           craft           = toString(body.craft);
        if ( structKeyExists(body, "ldc") )             ldc             = val(body.ldc);
        if ( structKeyExists(body, "operationNumber") ) operationNumber = toString(body.operationNumber);
        if ( structKeyExists(body, "hours") )           hours           = toString(body.hours);
        if ( structKeyExists(body, "justification") )   justification   = toString(body.justification);
        if ( structKeyExists(body, "startDate") )       startDate       = toString(body.startDate);
        if ( structKeyExists(body, "endDate") )         endDate         = toString(body.endDate);
        if ( structKeyExists(body, "status") )          status          = toString(body.status);
      }

      if ( NOT val(requestId) ) {
        result.MESSAGE = "requestId is required.";
        return result;
      }

      var startDateVal = javacast("null", "");
      var endDateVal   = javacast("null", "");

      if ( len(startDate) ) {
        try { startDateVal = parseDateTime(startDate); } catch ( any e ) {}
        if ( NOT isDate(startDateVal) ) startDateVal = lsParseDateTime(startDate);
      }

      if ( len(endDate) ) {
        try { endDateVal = parseDateTime(endDate); } catch ( any e ) {}
        if ( NOT isDate(endDateVal) ) endDateVal = lsParseDateTime(endDate);
      }

      if ( isDate(startDateVal) AND isDate(endDateVal) AND endDateVal < startDateVal ) {
        result.MESSAGE = "End date can’t be before start date.";
        return result;
      }

      if ( len(trim(status)) ) {
        var okStatuses = "Pending,Approved,Declined,Modify";
        if ( listFindNoCase(okStatuses, status) EQ 0 ) {
          result.MESSAGE = "Invalid status. Allowed: #okStatuses#.";
          return result;
        }
      }

      var sets   = [];
      var params = { rid: { value:val(requestId), cfsqltype:"cf_sql_integer" } };

      if ( len(trim(facility)) )        { arrayAppend(sets, "FacilityID = :facility");            params.facility      = { value:facility,        cfsqltype:"cf_sql_varchar" }; }
      if ( len(trim(craft)) )           { arrayAppend(sets, "Craft = :craft");                    params.craft         = { value:craft,           cfsqltype:"cf_sql_varchar" }; }
      if ( val(ldc) GT 0 )              { arrayAppend(sets, "LabourDistributionCode = :ldc");     params.ldc           = { value:val(ldc),        cfsqltype:"cf_sql_integer" }; }
      if ( len(trim(operationNumber)) ) { arrayAppend(sets, "OperationNumber = :opnum");          params.opnum         = { value:operationNumber, cfsqltype:"cf_sql_varchar" }; }
      if ( len(trim(hours)) AND isNumeric(hours) ) {
        arrayAppend(sets, "HoursPerWeek = :hours");
        params.hours = { value:val(hours), cfsqltype:"cf_sql_numeric" };
      }
      if ( len(trim(justification)) )   { arrayAppend(sets, "Justification = :justification");    params.justification = { value:justification,   cfsqltype:"cf_sql_varchar" }; }
      if ( isDate(startDateVal) )       { arrayAppend(sets, "StartDate = :startDate");            params.startDate     = { value:startDateVal,    cfsqltype:"cf_sql_date"    }; }
      if ( isDate(endDateVal) )         { arrayAppend(sets, "EndDate = :endDate");                params.endDate       = { value:endDateVal,      cfsqltype:"cf_sql_date"    }; }
      if ( len(trim(status)) )          { arrayAppend(sets, "Status = :status");                  params.status        = { value:status,          cfsqltype:"cf_sql_varchar" }; }

      if ( arrayLen(sets) EQ 0 ) {
        result.SUCCESS   = true;
        result.MESSAGE   = "No changes detected.";
        result.REQUESTID = val(requestId);
        return result;
      }

      transaction {
        arrayAppend(sets, "ModifiedBy = :modBy");
        arrayAppend(sets, "ModifiedDate = GETDATE()");
        params.modBy = {
          value    :arguments.userid,
          cfsqltype: "cf_sql_varchar"
        };

        queryExecute(
          "UPDATE PCSV_dw.dbo.FlexTimeRequests SET #arrayToList(sets, ', ')# WHERE RequestID = :rid",
          params,
          { datasource:"pcsv_dw" }
        );

        var q = queryExecute(
          "
          SELECT TOP 1
            RequestID, FacilityID, Craft, LabourDistributionCode, OperationNumber,
            HoursPerWeek, Justification, Status,
            CONVERT(VARCHAR(10), StartDate, 23) AS StartDate,
            CONVERT(VARCHAR(10), EndDate,   23) AS EndDate,
            CONVERT(VARCHAR(19), CreatedDate, 120) AS CreatedOn
          FROM PCSV_dw.dbo.FlexTimeRequests
          WHERE RequestID = :rid
          ",
          { rid: { value:val(requestId), cfsqltype:"cf_sql_integer" } },
          { datasource:"pcsv_dw" }
        );
      }

      if ( NOT q.recordCount ) {
        result.SUCCESS = false;
        result.MESSAGE = "Request not found.";
        return result;
      }

      var row = {
        REQUESTID             : q.RequestID[1],
        FACILITYID            : q.FacilityID[1],
        CRAFT                 : q.Craft[1],
        LABOURDISTRIBUTIONCODE: q.LabourDistributionCode[1],
        OPERATIONNUMBER       : q.OperationNumber[1],
        HOURSPERWEEK          : q.HoursPerWeek[1],
        JUSTIFICATION         : q.Justification[1],
        STATUS                : q.Status[1],
        STARTDATE             : q.StartDate[1],
        ENDDATE               : q.EndDate[1],
        CREATEDON             : q.CreatedOn[1]
      };

      result.SUCCESS   = true;
      result.MESSAGE   = "Updated.";
      result.REQUESTID = val(requestId);
      result.DATA      = row;

    } catch ( any e ) {
      writeLog(file="application", text="Admin.updateRequestFields ERROR: " & e.message & " :: " & e.detail);
      result.SUCCESS = false;
      result.MESSAGE = "Server error: " & e.message;
      result.DETAILS = e.detail;
    }

    return result;
  }

  function getMyFacilities(required string userid) access="remote" returnFormat="json" produces="application/json" {
    cfheader( name="Content-Type", value="application/json;charset=UTF-8" );
    local.result = { success: true, message: "", detail: "" };

    try {
        local.sql ="
            select
            b_fin_name,
            b_area,
            b_area_name,
            b_cluster,
            b_cluster_name,
            b_mpoo,
            b_lead_fin_nbr,
            b_lead_name,
            b_fin_name,
            b_fin_nbr
        FROM (
            SELECT
                csaw1.user_area_code as UserAreaCode,
                csaw1.user_district_code as UserDistrictCode,
                csaw1.user_area as AreaAccessInd,
                csaw1.user_district as DistrictAccessInd,
                csaw1.user_unit as UnitAccessInd,
                csaw1.user_fname as UserFirstName,
                csaw1.user_lname as UserLastName,
                csaw2.user_list
            FROM pcsv_csaw.dbo.csaw_pw csaw1 with(nolock)
                inner join
                    (
                        SELECT
                            csaw.user_id user_id , y.value as 'user_list'
                        FROM pcsv_csaw.dbo.csaw_pw csaw with(nolock)
                cross apply string_split(csaw.user_list,',') y
                WHERE user_id = :user_id
            ) csaw2
                on csaw1.user_id=csaw2.user_id
        ) a
        inner join pcsv_dw.dbo.var_base base with(nolock)
        on a.user_list = b_fin_nbr
        ";

        local.q = queryExecute(
            local.sql,
            {
                user_id: { value: arguments.userid, cfsqltype: "cf_sql_varchar" }
            },
            { datasource: "pcsv_dw" }
        );

        return queryToArray( local.q )
    } catch (any e) {
        local.result.success = false;
        local.result.message = e.message;
        local.result.detail = e.detail;
        return local.result;
    }

    return queryToArray( local.queryResult.getResult() )
}

public array function queryToArray( required query data ) {
        var local = StructNew();

        local.Columns = ListToArray( arguments.data.ColumnList );
        local.QueryArray = ArrayNew( 1 );

        for (local.RowIndex = 1; local.RowIndex LTE arguments.data.RecordCount; local.RowIndex = (Local.RowIndex + 1)) {
        local.Row = StructNew();

        for (local.ColumnIndex = 1; local.ColumnIndex LTE ArrayLen( local.Columns ); local.ColumnIndex = (Local.ColumnIndex + 1)) {
            local.ColumnName = local.Columns[local.ColumnIndex];
            local.Row[local.ColumnName] = arguments.data[local.ColumnName][local.RowIndex];
        }

        ArrayAppend( local.QueryArray, local.Row );
        };

        return ( local.QueryArray )
  }

}


==========================================================================


<cfcomponent output="false" hint="Mailer via SQL Server Database Mail with CFMAIL fallback (tag-based)">
  <!-- === CONFIG === -->
  <cfset variables.mailDsn     = "pcsv_dw">
  <cfset variables.profileName = "DB Monitor">
  <cfset variables.smtpFrom    = "Workhour Efficiency <nabin.timsina@usps.gov>">

  <!-- ============================================================= -->
  <!-- init: allow overriding DSN/profile/from, return this for chaining -->
  <!-- ============================================================= -->
  <cffunction name="init" access="public" returntype="any" output="false">
    <cfargument name="mailDsn"     type="string" required="false" default="">
    <cfargument name="profileName" type="string" required="false" default="">
    <cfargument name="smtpFrom"    type="string" required="false" default="">

    <cfif len(arguments.mailDsn)>
      <cfset variables.mailDsn = arguments.mailDsn>
    </cfif>
    <cfif len(arguments.profileName)>
      <cfset variables.profileName = arguments.profileName>
    </cfif>
    <cfif len(arguments.smtpFrom)>
      <cfset variables.smtpFrom = arguments.smtpFrom>
    </cfif>

    <cfreturn this>
  </cffunction>

  <!-- ============================================================= -->
  <!-- Generic send: DB Mail first, CFMAIL fallback. Returns boolean -->
  <!-- ============================================================= -->
  <cffunction name="sendHtml" access="public" returntype="boolean" output="false">
    <cfargument name="toEmail" type="string"  required="true">
    <cfargument name="subject" type="string"  required="true">
    <cfargument name="html"    type="string"  required="true">
    <cfargument name="cc"      type="string"  required="false" default="">
    <cfargument name="bcc"     type="string"  required="false" default="">
    <cfargument name="replyTo" type="string"  required="false" default="">
    <cfargument name="from"    type="string"  required="false" default="#variables.smtpFrom#">

    <cfset var ok       = true>
    <cfset var bodyHtml = arguments.html>

      <cftry>
        <cfmail
          to      ="#arguments.toEmail#"
          from    ="#arguments.from#"
          cc      ="#arguments.cc#"
          bcc     ="#arguments.bcc#"
          subject ="#arguments.subject#"
          type    ="html"
          charset ="utf-8">
          #bodyHtml#
        </cfmail>

        <cflog file="application" text="MailService CFMAIL OK -> #arguments.toEmail# :: #arguments.subject#">
        <cfreturn true>

        <cfcatch type="any">
          <cflog file="application" text="MailService CFMAIL FAIL: #cfcatch.message# :: #cfcatch.detail#">
          <cfreturn false>
        </cfcatch>
      </cftry>

    <cfreturn ok>
  </cffunction>

  <!-- ============================== -->
  <!-- Helpers to build Flex messages -->
  <!-- ============================== -->

  <cffunction name="_safe" access="private" returntype="string" output="false">
    <cfargument name="v" required="true">

    <cfset var s = "">
    <cftry>
      <cfset s = encodeForHtml( toString( arguments.v & "" ) )>
      <cfcatch type="any">
        <cfset s = toString( arguments.v & "" )>
      </cfcatch>
    </cftry>

    <cfreturn s>
  </cffunction>

  <cffunction name="_summarySimple" access="private" returntype="string" output="false">
    <cfargument name="req" type="struct" required="true">

    <cfset var data          = arguments.req>
    <cfset var requestId     = "">
    <cfset var facilityId    = "">
    <cfset var facilityName  = "">
    <cfset var craft         = "">
    <cfset var ldc           = "">
    <cfset var opnum         = "">
    <cfset var hours         = "">
    <cfset var startDate     = "">
    <cfset var endDate       = "">
    <cfset var justification = "">
    <cfset var facDisplay    = "">
    <cfset var h             = "">

    <cfif structKeyExists(data, "requestId")>
      <cfset requestId = _safe(data.requestId)>
    </cfif>
    <cfif structKeyExists(data, "facilityId")>
      <cfset facilityId = _safe(data.facilityId)>
    </cfif>
    <cfif structKeyExists(data, "facilityName")>
      <cfset facilityName = _safe(data.facilityName)>
    </cfif>
    <cfif structKeyExists(data, "craft")>
      <cfset craft = _safe(data.craft)>
    </cfif>
    <cfif structKeyExists(data, "ldc")>
      <cfset ldc = _safe(data.ldc)>
    </cfif>
    <cfif structKeyExists(data, "operationNumber")>
      <cfset opnum = _safe(data.operationNumber)>
    </cfif>
    <cfif structKeyExists(data, "hours")>
      <cfset hours = _safe(data.hours)>
    </cfif>
    <cfif structKeyExists(data, "startDate")>
      <cfset startDate = _safe(data.startDate)>
    </cfif>
    <cfif structKeyExists(data, "endDate")>
      <cfset endDate = _safe(data.endDate)>
    </cfif>
    <cfif structKeyExists(data, "justification")>
      <cfset justification = _safe(data.justification)>
    </cfif>

    <cfset facDisplay = facilityId>
    <cfif len(facilityName)>
      <cfset facDisplay = facDisplay & " - " & facilityName>
    </cfif>

    <cfset h = h & "<b>Request ID:</b> " & requestId & "<br>">
    <cfset h = h & "<b>Facility:</b> " & facDisplay & "<br>">
    <cfset h = h & "<b>Craft:</b> " & craft & "<br>">
    <cfset h = h & "<b>LDC:</b> " & ldc & "<br>">
    <cfset h = h & "<b>Operation number:</b> " & opnum & "<br>">
    <cfset h = h & "<b>Hours/week:</b> " & hours & "<br>">
    <cfset h = h & "<b>Weeks:</b> " & startDate & " to " & endDate & "<br>">

    <cfif len(justification)>
      <cfset h = h & "<br><b>Justification:</b><br>" & justification & "<br>">
    </cfif>

    <cfreturn h>
  </cffunction>

  <cffunction name="_submitHtml" access="private" returntype="string" output="false">
    <cfargument name="req" type="struct" required="true">

    <cfset var url = "https://eagnmnwbc1db.usps.gov/rework/flex_time/dashboard.html">
    <cfset var nm  = "">
    <cfset var h   = "">

    <cfif structKeyExists(arguments.req, "submitterName")>
      <cfset nm = _safe(arguments.req.submitterName)>
    </cfif>

    <cfset h = "<div style='font-family:Segoe UI,Arial,sans-serif'>">

    <cfif len(nm)>
      <cfset h = h & "Hello " & nm & ",<br><br>">
    <cfelse>
      <cfset h = h & "Hello,<br><br>">
    </cfif>

    <cfset h = h & "Your Flex Time request has been <b>submitted</b> and is pending review.<br><br>">
    <!-- <cfset h = h & _summarySimple(arguments.req)> -->
    <cfset h = h & "<br><a href='" & url & "'>Open dashboard</a>">
    <cfset h = h & "</div>">

    <cfreturn h>
  </cffunction>

  <cffunction name="sendFlexSubmission" access="public" returntype="boolean" output="false">
    <cfargument name="toEmail" type="string" required="true">
    <cfargument name="req"     type="struct" required="true">
    <cfargument name="cc"      type="string" required="false" default="">
    <cfargument name="bcc"     type="string" required="false" default="">
    <cfargument name="replyTo" type="string" required="false" default="">
    <cfargument name="from"    type="string" required="false" default="#variables.smtpFrom#">


    <cfset var subjectId  = "">
    <cfset var subject    = "">
    <cfset var htmlBody   = "">
    <cfset var sendResult = false>

    <cfif structKeyExists(arguments.req, "requestId")>
      <cfset subjectId = arguments.req.requestId>
    </cfif>

    <cfset subject  = "Flex Time request submitted (ID " & subjectId & ")">
    <cfset htmlBody = _submitHtml(arguments.req)>

    <!-- Use positional params to avoid any weirdness -->
    <cfset sendResult = sendHtml(
      arguments.toEmail,
      subject,
      htmlBody,
      arguments.cc,
      arguments.bcc,
      arguments.replyTo,
      arguments.from
    )>

    <cfreturn sendResult>
  </cffunction>

  <cffunction name="sendStatusChangeEmail" access="public" returntype="boolean" output="false">
    <cfargument name="toEmail" type="string" required="true">
    <cfargument name="reqID"     type="string" required="true">
    <cfargument name="subject"     type="string" required="true">
    <cfargument name="html"     type="string" required="true">
    <cfargument name="from"    type="string" required="false" default="#variables.smtpFrom#">


  
    <cfset var sendResult = false>


    <!-- Use positional params to avoid any weirdness -->
    <cfset sendResult = sendHtml(
      arguments.toEmail,
      arguments.subject,
      arguments.html,
      arguments.from
    )>

    <cfreturn sendResult>
  </cffunction>
</cfcomponent>




============================================================================


<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flex Time Request</title>

  <!-- Tailwind JIT -->
  <script src="/ref/packages/tailwindcss.browser.4.min.js"></script>


 <!-- Tailwind (internal with CDN fallback) -->
<script>
(function () {
  var s = document.createElement('script');
  s.src = '/ref/packages/tailwindcss.browser.4.min.js';
  s.onerror = function () {
    var cdn = document.createElement('script');
    cdn.src = 'https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4';
    document.head.appendChild(cdn);
  };
  document.head.appendChild(s);
})();
</script>


  <!-- Flowbite -->
  <link href="/ref/styles/flowbite.min.css" rel="stylesheet" />
  <script src="/ref/packages/flowbite.min.js"></script>

  <!-- Axios, Moment, Numeral -->
  <script src="/ref/packages/axios.min.js"></script>
  <script src="/ref/packages/moment.min.js" crossorigin="anonymous"></script>
  <script src="/ref/packages/numeral.min.js" crossorigin="anonymous"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js" crossorigin="anonymous"></script> -->

  <!-- Global CSS -->
  <link rel="stylesheet" href="/ref/styles/global.css" />

  <!-- Vue & App JS -->
  <script type="module" src="/ref/toolbox/flex/index.js"></script>

  <style>
    .usps-blue {
      background-color: #004B87;
    }

    .btn-muted {
      background-color: #3B6E8F;
    }

    .btn-muted:hover {
      background-color: #345e78;
      /* slightly darker for hover */
    }

 [v-cloak] {
      display: none;
    }


  </style>


</head>


<body class="bg-gray-50 text-gray-800" >
  <div id="app" class="max-w-xl mx-auto my-8 p-6 bg-white rounded-2xl shadow-lg" v-cloak>
    <div class="bg-[#3B6E8F] text-white rounded-md shadow-md p-6 mb-6">
      <h1 class="text-3xl font-semibold">📮 Flex Time Request</h1>
    </div>
    <form @submit.prevent="submitRequest" novalidate class="space-y-6">

      <!-- Facility -->
      <div>
        <label for="facility" class="block text-sm font-semibold">Facility</label>
        <select id="facility" v-model="form.facility" required
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option disabled value=""> Select your facility </option>
          <option v-for="row in user.function4_access" :value="row.B_FIN_NBR">{{ row.B_FIN_NAME }} ({{ row.B_FIN_NBR }})
          </option>
        </select>
        <p v-if="errors.facility" class="text-red-600 text-sm mt-1">{{ errors.facility }}</p>
      </div>


      <!-- Craft & LDC together in one 2-column grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Craft -->
        <div>
          <label for="craft" class="block text-sm font-semibold">Craft</label>
          <select id="craft" v-model="form.craft" required
            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            <option disabled value="">Craft</option>
            <option value="clerk">Clerk</option>
            <option value="mailhandler">Mailhandler</option>
          </select>
          <p v-if="errors.craft" class="text-red-600 text-sm mt-1">{{ errors.craft }}</p>
        </div>

        <!-- LDC -->
        <div>
          <label for="operation" class="block text-sm font-semibold">Labor Distribution Code (LDC)</label>
          <select id="operation" v-model="form.operation" required
            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            <option disabled value="">— Select LDC —</option>
            <option v-for="l in filteredLDCs" :key="l.ldc" :value="l.ldc">
              LDC {{ l.ldc }} — {{ l.name }}
            </option>
          </select>
          <p v-if="errors.operation" class="text-red-600 text-sm mt-1">{{ errors.operation }}</p>
        </div>
      </div><!-- ←––– close the 2-column grid here –––→ -->

      <!-- Operation Number (full width) -->
      <div class="mt-6">
        <label for="operationCode" class="block text-sm font-semibold">Operation Number</label>
        <select id="operationCode" v-model="form.operationCode" required
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option disabled value="">— Select operation code —</option>
          
          
          <!-- <option v-for="code in filteredOperationCodes" :key="code" :value="code">
            {{ code }} — {{ operationsList.find(o=>o.code===code).name }}
          </option> -->

            <option
        v-for="opt in filteredOperationOptions"
        :key="opt.code + '|' + opt.name"
        :value="opt.code + '-' + opt.name"
      >
        {{ opt.code }} — {{ opt.name }}
      </option>
          
        </select>

        
        <p v-if="errors.operationCode" class="text-red-600 text-sm mt-1">{{ errors.operationCode }}</p>
      </div>

      <!-- Time requested (full width) -->
      <div class="mt-6">
        <label for="hours" class="block text-sm font-semibold">Daily Time requested (hrs.hundredths)</label>
        <input id="hours" type="number" step="0.01" min="0.01" max="100" v-model.number="form.hours" required
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
        <p v-if="errors.hours" class="text-red-600 text-sm mt-1">{{ errors.hours }}</p>
      </div>

       <!-- Justification + tooltip -->
<div class="mt-6 relative">
  <label for="justification" class="block text-sm font-semibold inline-flex items-center gap-2">
    Justification
    <span
      class="inline-flex items-center justify-center w-4 h-4 text-xs font-bold rounded-full bg-gray-200 text-gray-700 cursor-help"
      data-tooltip-target="justif_tip" data-tooltip-placement="right">i</span>
  </label>
  <div
    id="justif_tip"
    role="tooltip"
    class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip"
  >
    Provide a detailed explanation supporting the requested time value. Each request must be detailed in nature with a mathematical calculation which can be validated. Requests which are not detailed with supporting information will be denied..
    <div class="tooltip-arrow" data-popper-arrow></div>
  </div>

  <textarea
    id="justification"
    v-model="form.justification"
    :maxlength="1000"
    rows="4"
    required
    placeholder="Provide a detailed explanation…"
    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
  ></textarea>
  <p class="text-gray-500 text-xs mt-1">{{ form.justification.length }} / 1000</p>
  <p v-if="errors.justification" class="text-red-600 text-sm mt-1">{{ errors.justification }}</p>
</div>

      <!-- Date Range stays in its own grid if you like two columns—but ensure it’s outside the first grid -->
      <!-- <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6"> -->
      <!-- Start Date -->
      <!-- <div>
      <label for="startDate" class="block text-sm font-semibold">Start Date</label>
      <input id="startDate" type="date" v-model="form.startDate" required
             class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
      <p v-if="errors.startDate" class="text-red-600 text-sm mt-1">{{ errors.startDate }}</p>
    </div> -->
      <!-- End Date -->
      <!-- <div>
      <label for="endDate" class="block text-sm font-semibold">End Date</label>
      <input id="endDate" type="date" v-model="form.endDate" required
             class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
      <p v-if="errors.endDate" class="text-red-600 text-sm mt-1">{{ errors.endDate }}</p>
    </div>
  </div> -->




      <!-- Week Range Selection (paste instead of date inputs) -->
      <div>
        <label for="wk_start" class="block text-sm font-semibold">Start Week</label>
        <select id="wk_start" v-model="form.wk_start" @change="onStartChange"
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500">
          <option disabled value="">-------------</option>
          <option v-for="row in weekOptions" :value="row[2]">Week {{ row[1] }}, {{ row[2] }} (Saturday)</option>
        </select>
        <p v-if="errors.wk_start" class="text-red-600 text-sm mt-1">{{ errors.wk_start }}</p>
      </div>



  


      <div>
        <label for="wk_end" class="block text-sm font-semibold">End Week</label>
        <select id="wk_end" v-model="form.wk_end" @change="onEndChange"
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500">
          <option disabled value="">-------------</option>
          <option v-for="row in weekOptions" :value="row[3]">Week {{ row[1] }}, {{ row[3] }} (Friday)</option>
        </select>
        <p v-if="errors.wk_end" class="text-red-600 text-sm mt-1">{{ errors.wk_end}}</p>
      </div>



      <!-- <div>
  <label for="wk_end" class="block text-sm font-semibold">End Week</label>
  <select
    id="wk_end"
    v-model="form.endWeek"
    @change="onEndChange"
    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500"
  >
    <option disabled value="">------------</option>
    <option v-for="row in weekOptions" :value="row.B_FIN_NBR">{{ row.B_FIN_NAME }} ({{ row.B_FIN_NBR }})</option>

  </select>
  <p v-if="errors.endWeek" class="text-red-600 text-sm mt-1">{{ errors.endWeek }}</p>
</div> -->



      <!-- for hidden tag just below :  -->
      <input type="hidden" id="fy_start" name="fy_start" />
      <input type="hidden" id="fy_end" name="fy_end" />




      <!-- Attachment -->
      <div>
        <label for="attachment" class="block text-sm font-semibold">Attachment (optional, ≤10MB)</label>
        <input
          id="attachment"
          type="file"
          accept=".pdf,.jpg,.jpeg,.png,.txt,.csv,application/pdf,image/jpeg,image/png,text/plain"
          @change="onFileChange"
          class="mt-1 block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4
                file:rounded-lg file:border-0 file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />

        <p class="text-gray-500 text-xs mt-1">{{ form.fileName }}</p>

        <p class="text-xs text-gray-500 mt-1">
          Allowed: PDF, JPG, PNG, TXT, CSV (≤ 10 MB). For Word/Excel/PowerPoint, please upload as PDF.
        </p>

        <p v-if="errors.file" class="text-red-600 text-sm mt-1">{{ errors.file }}</p>
      </div>

      <!-- Submit -->
      <button id="submitBtn" type="submit" class="w-full py-3 text-white font-bold rounded-lg shadow-md transition btn-muted">
        Submit Request
      </button>
    </form>
  </div>

  <!-- Success Modal -->
  <div id="submitModal" tabindex="-1" aria-hidden="true" 
    class="fixed inset-0 flex items-center justify-center bg-black/50 hidden" v-cloak>
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm text-center">
      <h2 class="text-xl font-semibold mb-4">✅ Request Submitted</h2>
      <p class="mb-6">Your flex-time request has been submitted and is under review.</p>
      <button id="closeModal" type="button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Close
      </button>
    </div>
  </div>
</body>

</html>






==========================================================================


import { createApp } from 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.esm-browser.min.js';
import { initFlowbite, Modal } from 'https://esm.sh/flowbite';

createApp({
  data() {
    return {
      serviceFolder: '/ref/api/v1/toolbox/flex/',
      user: {},
      csawUserObject: null,
      myCsawAccess: null,
      facilities: null,
      weekOptions: null,
      
      form: {
        facility: '',
        craft: '',
        operation: '',
        operationCode: '',
        hours: null,
        justification: '',
        wk_start: '',
        wk_end: '',
        file: null,
        fileName: ''
      },
      errors: {},
      submitStatus: '',
      lastRequestId: null,

      // NEW: all possible LDCs with their display names
      ldcList: [
        { ldc: 41, name: 'Unit Distribution — Automated' },
        { ldc: 42, name: 'Customer Services' },
        { ldc: 43, name: 'Unit Distribution — Manual' },
        { ldc: 44, name: 'Post Office Box Distribution' },
        { ldc: 45, name: 'Window Services' },
        { ldc: 48, name: 'Admin/Misc — Mixed' }
      ],

      operationsList: [
        // LDC 41
        { ldc: 41, code: '9050', name: 'ADUS Parcels' },
        { ldc: 41, code: '9100', name: 'ADUS Sunday Parcels' },
        { ldc: 41, code: '9090', name: 'ADUS SCF Volume' },
        { ldc: 41, code: '3150', name: 'SDUS Parcels' },
        { ldc: 41, code: '3170', name: 'SDUS Sunday Parcels' },
        { ldc: 41, code: '3190', name: 'SDUS SCF Volume' },
        { ldc: 41, code: '9080', name: 'ADUS Bundles Volume' },
        { ldc: 41, code: '3180', name: 'SDUS Bundles Volume' },

        // LDC 42 (all codes 6370, different names)
        { ldc: 42, code: '6370', name: 'Postage Due/BRM/MRS/PRS' },
        { ldc: 42, code: '6370', name: 'Processed Letters (BRM)' },
        { ldc: 42, code: '6370', name: 'Processed Flats (BRM)' },
        { ldc: 42, code: '6370', name: 'Processed Parcels (BRM)' },
        { ldc: 42, code: '6370', name: 'Processed Postcards (BRM)' },
        { ldc: 42, code: '6370', name: 'Processed Letters (PD)' },
        { ldc: 42, code: '6370', name: 'Processed Flats (PD)' },
        { ldc: 42, code: '6370', name: 'Processed Parcels (PD)' },
        { ldc: 42, code: '6370', name: 'LDC 42 Flex Time' },
        { ldc: 42, code: '6370', name: 'Merchandise Return Service' },
        { ldc: 42, code: '6370', name: 'Parcel Return Service (PRS)' },

        // LDC 43
        { ldc: 43, code: '1610', name: 'Manual Letter Distribution' },
        { ldc: 43, code: '1720', name: 'Manual Flat Distribution' },
        { ldc: 43, code: '0770', name: 'Sunday Parcels Distribution' },
        { ldc: 43, code: '0790', name: 'Packages/Sprs Distribution' },
        { ldc: 43, code: '0790', name: 'Manual PPVS' },
        { ldc: 43, code: '2410', name: 'F4 Allied Distribution (Clerk)' },
        { ldc: 43, code: '1710', name: 'LDC 43 Allied (Mailhandler)' },
        { ldc: 43, code: '2410', name: 'LDC 43 Flex Time (Clerk)' },
        { ldc: 43, code: '1710', name: 'LDC 43 Flex Time (Mailhandler)' },
        { ldc: 43, code: '2410', name: 'Dock Transfer AM (Clerk)' },
        { ldc: 43, code: '1710', name: 'Dock Transfer AM (Mailhandler)' },
        { ldc: 43, code: '2410', name: 'Tier 1 Allied Distribution (Clerk)' },
        { ldc: 43, code: '1710', name: 'Tier 1 Allied Distribution (Mailhandler)' },
        // { ldc: 43, code: '2410', name: 'LDC 43 Tier 1 Other Time (Clerk)' },
        // { ldc: 43, code: '1710', name: 'LDC 43 Tier 1 Other Time (Mailhandler)' },
        { ldc: 43, code: '2410', name: 'Daily AM Hashing Container (Clerk)' },
        { ldc: 43, code: '1710', name: 'Daily AM Hashing Container (Mailhandler)' },
        // { ldc: 43, code: '0770', name: 'Dynamic Route Spread' },

        // LDC 44.
        
        { ldc: 44, code: '7690', name: 'Box Section' },
        { ldc: 44, code: '7690', name: 'PO Box Manual Letter Volume' },
        { ldc: 44, code: '7690', name: 'PO Box DPS Letter Volume' },
        { ldc: 44, code: '7690', name: 'PO Box Manual Flat Volume' },
        { ldc: 44, code: '7690', name: 'PO Box Parcels' },
        { ldc: 44, code: '7690', name: 'LDC 44 Flex Time' },

        // LDC 45
        { ldc: 45, code: '3550', name: 'Window Services' },
        { ldc: 45, code: '3550', name: 'SSA Transactions' },
        { ldc: 45, code: '3550', name: 'Bulletproof Glass' },
        { ldc: 45, code: '3550', name: 'WOS Ancillary (54%)' },
        { ldc: 45, code: '3550', name: 'Open/Close' },
        { ldc: 45, code: '3550', name: 'SSK Transactions' },
        { ldc: 45, code: '3550', name: 'LDC 45 Flex Time' },

        // LDC 48
        { ldc: 48, code: '7420', name: 'Bulk Mailings' }, //changed it from Average Mailing to Bulk Mailing
        { ldc: 48, code: '7420', name: 'PO Box Accountables' },
        { ldc: 48, code: '7420', name: 'Caller Services (Paid)' },
        { ldc: 48, code: '7420', name: 'MIO On Revenue Pickup' },
        { ldc: 48, code: '5440', name: 'Carrier Accountables (CAGE)' },
        { ldc: 48, code: '7420', name: 'Carrier Accountables (CART)' },
        { ldc: 48, code: '5440', name: 'Carrier Accountables (ON…) CAGE' },
        { ldc: 48, code: '7420', name: 'Carrier Accountables (ON…) CART' },
        { ldc: 48, code: '7420', name: 'CFS/PARS Prep' },
        { ldc: 48, code: '7420', name: 'Collections (Clerk)' },
        { ldc: 48, code: '5590', name: 'Collections (Mailhandler)' },
        { ldc: 48, code: '7420', name: 'Dispatch (Clerk)' },
        { ldc: 48, code: '5590', name: 'Dispatch (Mailhandler)' },
        // { ldc: 48, code: '2280', name: 'Express Mail Delivery (F4)' },
        { ldc: 48, code: '7420', name: 'Firm Holdouts' },
        // { ldc: 48, code: '7420', name: 'LDC 48 Flex Time (Clerk)' },
        // { ldc: 48, code: '5590', name: 'LDC 48 Flex Time (Mailhandler)' },
        { ldc: 48, code: '7420', name: 'My PO Credit' },
        { ldc: 48, code: '6210', name: 'Offsite Travel/Admin' },
        { ldc: 48, code: '7420', name: 'Open & Close Building' }, //changed from supplies & .. to building 
        { ldc: 48, code: '7420', name: 'PO Box Maintenance' },
        { ldc: 48, code: '7420', name: 'Premium Forwarding Service' },
        { ldc: 48, code: '7420', name: 'Remote Forwarding Service' },
        { ldc: 48, code: '7420', name: 'Non AAU Scanning (Clerk)' },   //Changed it from scans to scanning 
        { ldc: 48, code: '5590', name: 'Non AAU Scanning (Mailhandler)' }, //Changed it from scans to scanning 
        { ldc: 48, code: '7420', name: 'SSK Maintenance' },
        { ldc: 48, code: '5580', name: 'TACS (Lead Clerks Only)' },
        { ldc: 48, code: '7420', name: 'Telephone' },
        { ldc: 48, code: '7420', name: 'UBBM' },
        { ldc: 48, code: '5580', name: 'Validate PS Form 1412(s)' },
        { ldc: 48, code: '5580', name: 'Verify Deposit & Transmit' },
        { ldc: 48, code: '7420', name: 'Sunday / Holiday Hub (Clerk)' },
        { ldc: 48, code: '5590', name: 'Sunday / Holiday Hub (Mailhandler)' },
        { ldc: 48, code: '7420', name: 'Scan Where You Band' },
        { ldc: 48, code: '7420', name: 'HCR Seals' },
        { ldc: 48, code: '7420', name: 'Registers' },
        { ldc: 48, code: '7420', name: 'Pouch Setup & Labeling (Clerk)' },
        { ldc: 48, code: '5590', name: 'Pouch Setup & Labeling (Mailhandler)' },
        { ldc: 48, code: '7420', name: 'Dock Transfer PM (Clerk)' },
        { ldc: 48, code: '5590', name: 'Dock Transfer PM (Mailhandler)' },
        // { ldc: 48, code: '7420', name: 'LDC 48 Tier 1 Other Time (Clerk)' },
        // { ldc: 48, code: '5590', name: 'LDC 48 Tier 1 Other Time (Mailhandler)' },
        { ldc: 48, code: '7420', name: 'Daily PM Hashing Container (Clerk)' },
        { ldc: 48, code: '5590', name: 'Daily PM Hashing Container (Mailhandler)' }
      ]
    };
  },

  computed: {
  // which LDCs are allowed by craft?
  filteredLDCs() {
    if (this.form.craft === 'mailhandler')
      return this.ldcList.filter((l) => [43, 48].includes(l.ldc));
    if (this.form.craft === 'clerk')
      return this.ldcList.filter((l) => [41, 42, 43, 44, 45, 48].includes(l.ldc));
    return [];
  },

  // Enforce Craft + LDC rules and then dedupe codes
  filteredOperationCodes() {
    const ldc   = Number(this.form.operation);
    const craft = String(this.form.craft || '').toLowerCase();
    if (!ldc) return [];

    const inLdc = this.operationsList.filter(o => o.ldc === ldc);

    const excludeCodesForMailhandlerByLdc = {
      43: new Set(['1610','1720','2410']),
      48: new Set(['5440','5580','7420'])
    };
    const excludeCodesForClerkByLdc = {
      43: new Set(['1710']),
      48: new Set(['5590'])
    };

    const filtered = inLdc.filter(o => {
      const nm = String(o.name || '').toLowerCase();
      if (craft === 'clerk') {
        if (nm.includes('mailhandler')) return false;
        if (excludeCodesForClerkByLdc[ldc]?.has(o.code)) return false;
        return true;
      }
      if (craft === 'mailhandler') {
        if (nm.includes('clerk')) return false;
        if (excludeCodesForMailhandlerByLdc[ldc]?.has(o.code)) return false;
        return true;
      }
      return true;
    });

    const seen = new Set();
    const codes = [];
    for (const o of filtered) {
      if (!seen.has(o.code)) { seen.add(o.code); codes.push(o.code); }
    }
    return codes;
  },

  // NEW: options for the Operation Number dropdown (used for rendering labels)
  filteredOperationOptions() {
    const ldc   = Number(this.form.operation);
    const craft = String(this.form.craft || '').toLowerCase();
    if (!ldc) return [];

    const inLdc = this.operationsList.filter(o => o.ldc === ldc);

    const excludeCodesForMailhandlerByLdc = {
      43: new Set(['1610','1720','2410']),
      48: new Set(['5440','5580', '7420'])
    };
    const excludeCodesForClerkByLdc = {
      43: new Set(['1710']),
      48: new Set(['5590'])
    };

    const filtered = inLdc.filter(o => {
      const nm = String(o.name || '').toLowerCase();
      if (craft === 'clerk') {
        if (nm.includes('mailhandler')) return false;
        if (excludeCodesForClerkByLdc[ldc]?.has(o.code)) return false;
        return true;
      }
      if (craft === 'mailhandler') {
        if (nm.includes('clerk')) return false;
        if (excludeCodesForMailhandlerByLdc[ldc]?.has(o.code)) return false;
        return true;
      }
      return true;
    });

    if (ldc === 43 || ldc === 48) {
      // show ALL distinct (code,name) combos
      const seen = new Set(); // code|name
      const opts = [];
      for (const o of filtered) {
        const k = `${o.code}|${o.name.toLowerCase()}`;
        if (!seen.has(k)) { seen.add(k); opts.push({ code: o.code, name: o.name }); }
      }
      return opts;
    }

    // other LDCs: keep one per code
    const seenCodes = new Set();
    const opts = [];
    for (const o of filtered) {
      if (!seenCodes.has(o.code)) { seenCodes.add(o.code); opts.push({ code: o.code, name: o.name }); }
    }
    return opts;
  }
},// <— keep this comma because methods: follows






  

  methods: {
    // Authentication & data fetching (unchanged)
    async authenticate() {
      try {
        await axios.get(`/ref/api/v2/authenticate.cfc?method=get`).then((res) => {
          if (res.data) this.user = res.data.data;
        });
        await this.getCsawAccess();
        await this.getMyFacilities();
        await this.loadWeekOptions();
      } catch (e) {
        console.error('Auth error', e);
      }
    },
    async getCsawAccess() {
      try {
        await axios
          .get(
            `${this.serviceFolder}flex.cfc?method=getAccess&userid=${encodeURIComponent(this.userAceid)}`
          )
          .then((res) => {
            if (res.data) this.csawUserObject = res.data;
          });
      } catch (e) {
        console.error('Access error', e);
      }
    },
    async getMyFacilities() {
      try {
        await axios
          .get(
            `${
              this.serviceFolder
            }flex.cfc?method=getMyFacilities&userid=${encodeURIComponent(this.user.ace_id)}`
          )
          .then((res) => {
            if (res.data) this.facilities = res.data;
          });
      } catch (e) {
        console.error('Facilities error', e);
      }
    },

  ensureOperationCodeValid() {
  if (!this.filteredOperationCodes.includes(this.form.operationCode)) {
    this.form.operationCode = '';
  }
},


  isDisallowedForMailhandler48(name, code) {
    const nm = String(name || '').toLowerCase();
    const cd = String(code || '').trim();

    // 1) 7240 Bulk Mailing (accept "bulk mailing" or "bulk mailings")
    if (cd === '7240' && (nm.includes('bulk mailing') || nm.includes('bulk mailings'))) return true;

    // 2) HCR Seals (code may vary)
    if (nm.includes('hcr seals')) return true;

    // 3) Specific 7420 disallows
    if (cd === '7420') {
      if (nm.includes('po box accountables')) return true;
      // handles "Carrier Accountables (Cart)" and "Carrier Accountables (ON..) Cart"
      if (nm.includes('carrier accountables') && nm.includes('cart')) return true;
      if (nm.includes('cfs/pars')) return true;              // matches "CFS/PARS", "CFS/PARS Prep"
      if (nm.includes('premium forwarding service')) return true;
      if (nm.includes('remote forwarding service')) return true;
      if (nm.includes('registers')) return true;
    }

    return false;
  },

//     async loadWeekOptions() {
//   try {
//     const res = await axios.get(`${this.serviceFolder}FlexService.cfc?method=getWeekOptions&returnformat=json`);
//     if (res.data) {
//       const raw = res.data.DATA || res.data.data || [];
//       // raw rows = [ fiscalYear, week, startDate, endDate ]
//       this.weekOptions = raw.map(row => {
//         const startISO = moment(row[2]).startOf('day').format('YYYY-MM-DD');
//         const endISO   = moment(row[3]).startOf('day').format('YYYY-MM-DD');
//         return [row[0], row[1], startISO, endISO];
//       });
//     }
//   } catch (e) {
//     console.error("Couldn't load weeks", e);
//   }
// },

// asDate(v) {
//   if (!v) return null;
//   // Accept ISO, ISO with time, or common US formats just in case
//   const m = moment(v, [
//     moment.ISO_8601, 'YYYY-MM-DD', 'YYYY/MM/DD',
//     'MM/DD/YYYY', 'MMM D, YYYY', 'MMMM D, YYYY'
//   ], true);
//   return m.isValid() ? m.toDate() : null;
// },


async loadWeekOptions() {
  try {
    const res = await axios.get(`${this.serviceFolder}flex.cfc?method=getWeekOptions&returnformat=json`);
    if (res.data) {
      const raw = res.data.DATA || res.data.data || [];
      // accepted server date shapes (strict)
      const FMT = [
        'YYYY-MM-DD',
        'YYYY-MM-DD HH:mm',
        'YYYY-MM-DD HH:mm:ss',
        'YYYY-MM-DD HH:mm:ss.SSS',
        'YYYY-MM-DDTHH:mm:ssZ',
        'YYYY-MM-DDTHH:mm:ss.SSSZ',
        'MM/DD/YYYY' // just in case
      ];
      const toISO = (v) => {
        if (!v) return '';
        // numbers → epoch (sec or ms)
        if (typeof v === 'number') {
          const ms = v < 1e12 ? v * 1000 : v;
          return moment(ms).format('YYYY-MM-DD');
        }
        // strings → try strict against common SQL/ISO shapes
        let m = moment(v, FMT, true);
        if (!m.isValid()) m = moment.parseZone(v); // handles ISO with offsets
        return m.isValid() ? m.format('YYYY-MM-DD') : '';
      };

      // raw row: [fiscalYear, week, startDate, endDate]
      this.weekOptions = raw.map(row => {
        const startISO = toISO(row[2]);
        const endISO   = toISO(row[3]);
        return [row[0], row[1], startISO, endISO];
      });
    }
  } catch (e) {
    console.error("Couldn't load weeks", e);
  }
},




asDate(v) {
  if (!v) return null;
  const FMT = [
    'YYYY-MM-DD',
    'YYYY-MM-DD HH:mm',
    'YYYY-MM-DD HH:mm:ss',
    'YYYY-MM-DD HH:mm:ss.SSS',
    'YYYY-MM-DDTHH:mm:ssZ',
    'YYYY-MM-DDTHH:mm:ss.SSSZ',
  ];
  // Prefer strict known formats; fall back to parseZone for ISO with offset
  let m = moment(v, FMT, true);
  if (!m.isValid()) m = moment.parseZone(v);
  return m.isValid() ? m.toDate() : null;
},



onStartChange() {
  const start = this.asDate(this.form.wk_start);
  const end   = this.asDate(this.form.wk_end);
  if (start && end && end < start) {
    // Nudge end up to start if user previously picked an earlier week
    this.form.wk_end = this.form.wk_start;
  }
  this.errors.wk_end = '';
},

onEndChange() {
  const start = this.asDate(this.form.wk_start);
  const end   = this.asDate(this.form.wk_end);
  if (start && end && end < start) {
    this.errors.wk_end = 'End date can’t be before start date.';
  } else {
    this.errors.wk_end = '';
  }
},


    onFileChange(e) {
  const file = e.target.files[0];
  if (!file) {
    this.form.file = null;
    this.form.fileName = '';
    this.errors.file = '';
    return;
  }

  const maxBytes = 10 * 1024 * 1024;
  if (file.size > maxBytes) {
    this.errors.file = 'File must be 10 MB or smaller.';
    this.form.file = null;
    this.form.fileName = '';
    return;
  }

  // Types we handle server-side without third-party tools
  const okMimes = new Set([
    'application/pdf', 'image/jpeg', 'image/png', 'text/plain'
  ]);
  const okExts = ['.pdf','.jpg','.jpeg','.png','.txt','.csv'];

  const nameLower = file.name.toLowerCase();
  const hasOkExt  = okExts.some(ext => nameLower.endsWith(ext));
  const hasOkMime = okMimes.has(file.type);

  if (!hasOkExt && !hasOkMime) {
    this.errors.file = 'Unsupported type. Please upload PDF, JPG, PNG, TXT, or CSV (Office files should be saved as PDF).';
    this.form.file = null;
    this.form.fileName = '';
    return;
  }

  this.errors.file = '';
  this.form.file = file;
  this.form.fileName = file.name;

    },
    validate() {
  this.errors = {};
  if (!this.form.facility)      this.errors.facility = 'Please select a facility.';
  if (!this.form.craft)         this.errors.craft = 'Please select a craft.';
  if (!this.form.operation)     this.errors.operation = 'Please select an operation.';
  if (!this.form.operationCode) this.errors.operationCode = 'Please select an operation number.';
  if (!this.form.hours || this.form.hours < 0.01 || this.form.hours > 100)
    this.errors.hours = 'Hours must be between 0.01 and 100';
  if (!this.form.justification || !this.form.justification.trim().length)
    this.errors.justification = 'Justification is required.';
  if (!this.form.wk_start) this.errors.wk_start = 'Start date required.';
  if (!this.form.wk_end)   this.errors.wk_end   = 'End date required.';

  const start = this.asDate(this.form.wk_start);
  const end   = this.asDate(this.form.wk_end);
  if (start && end && end < start) {
    this.errors.wk_end = 'End date can’t be before start date.';
  }

  return Object.keys(this.errors).length === 0;
},

async notifyAfterSubmit() {
  try {
    if (!this.lastRequestId) return;
    const res = await axios.post(
      `${this.serviceFolder}flex.cfc?method=sendSubmitEmails&returnformat=json`,
      { requestId: this.lastRequestId || 0 },
      { validateStatus: () => true } // <-- fixed spelling
    );
    console.log('sendSubmitEmails =>', res.status, res.data);
  } catch (e) {
    console.error('notifyAfterSubmit failed', e);
  }
},

    async submitRequest() {
      if (!this.validate()) return;
      // Disable the submit button using DOM manipulation
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) submitBtn.disabled = true;

      const payload = new FormData();
      Object.entries(this.form).forEach(([k, v]) => {
        if (k === 'file' && v) {
          // payload.append('filename', this.form.file.name);
          // payload.append('filetype', this.form.file.type);
          // payload.append('filecontent', this.form.file.TODO); //

          payload.append('file', this.form.file, this.form.file.name);     // real bytes
          payload.append('filename', this.form.file.name);                  // metadata
          payload.append('filetype', this.form.file.type || 'application/pdf');

        } else if (k !== 'fileName') payload.append(k, v);
      });

      // Optional: give the server a direct email for the submitter
if (this.user?.email)        payload.append('notifyEmail', this.user.email);
else if (this.user?.mail)    payload.append('notifyEmail', this.user.mail);
else if (this.user?.user_email) payload.append('notifyEmail', this.user.user_email);

      try {
        const response = await axios.post(
          `${this.serviceFolder}flex.cfc?method=post&returnformat=json`,
          payload,
          // { headers: { 'Content-Type': 'application/json' } }
        );
        this.submitStatus = 'Request submitted successfully!';
        if (response.data['SUCCESS'] === true) {

           this.lastRequestId = response.data.REQUESTID || null;
          document.getElementById('submitModal').classList.remove('hidden');
          // reset the form

          this.form = {
            facility: '',
            craft: '',
            operation: '',
            operationCode: '',
            hours: null,
            justification: '',
            wk_start: '',
            wk_end: '',
            file: null,
            fileName: ''
          };
        } else {
          // display failure modal
          document.getElementById('failureModal').classList.remove('hidden');
        }
      } catch (err) {
        console.error(err);
        this.submitStatus = 'Submission failed, please try again.';
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
      // Re-enable the button
    }
  },

  watch: {
    'form.craft'()    { this.ensureOperationCodeValid(); },
'form.operation'(){ this.ensureOperationCodeValid(); },
  },
  
  mounted() {
    console.clear();
    initFlowbite();
    this.authenticate();
    console.log('App mounted', this);
    document.getElementById('closeModal').addEventListener('click', async () => {
  document.getElementById('submitModal').classList.add('hidden');

  // ⬇️ fire the emails
  await this.notifyAfterSubmit();

  // then navigate to dashboard
  window.location.href = 'https://eagnmnwbp161f.usps.gov/ref/toolbox/flex/dashboard.html';
});
  }
}).mount('#app');







=======================================================================


<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flex Time Dashboard</title>

  <!-- Tailwind JIT -->
  <script src="/ref/packages/tailwindcss.browser.4.min.js"></script>
  <!-- Flowbite -->
  <link href="/ref/styles/flowbite.min.css" rel="stylesheet" />
  <script src="/ref/packages/flowbite.min.js"></script>

  <!-- Axios, Moment, Numeral -->
  <script src="/ref/packages/axios.min.js"></script>
  <script src="/ref/packages/moment.min.js" crossorigin="anonymous"></script>
  <script src="/ref/packages/numeral.min.js" crossorigin="anonymous"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js" crossorigin="anonymous"></script> -->

  <link rel="stylesheet" href="/ref/styles/global.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      background: #f1f5f9;
      /* font-family: sans-serif; */
    }

    /* #dashboardApp {

      width: 100%;
      max-width: 100%;
      margin-left: 0;
      margin-right:0;

    } */
    /* Fixed header bar */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      z-index: 50;
    }

    /* Card look */
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }

    /* Chart height compact so Summary + Chart are visible together */
    .chart-wrap { height: 14rem; }

    /* Ensure main content sits below header */
    main {
      padding-top: 5rem;
    }

    /* USPS brand color */
    .usps-blue {
      background-color: #3B6E8F;
    }

    /* Hover on table rows */
    table tbody tr:hover {
      background: #f9fafb;
    }



/* ===== Admin-style table & filter UI ===== */
.tbl-wrap { overflow: auto; position: relative }
table { width:100%; border-collapse: separate; border-spacing: 0; }
thead th { position: sticky; top: 0; z-index: 1; }
thead th .th-inner { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
thead th button.filter-btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:22px; height:22px; border-radius:6px;
  background: rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.28);
}
thead th button.filter-btn:hover{ background: rgba(255,255,255,0.2); }

thead th, tbody td { padding:.55rem .65rem; }
tbody tr:nth-child(odd){ background:#fbfdff; }
tbody tr:hover{ background:#f5f9ff; }

/* Column widths (match admin so headers fit) */
th.col-id,          td.col-id          { width: 70px; }
th.col-facility,    td.col-facility    { width: 110px; }
th.col-facname,     td.col-facname     { width: 220px; }
th.col-hours,       td.col-hours       { width: 90px; }
th.col-craft,       td.col-craft       { width: 120px; }
th.col-ldc,         td.col-ldc         { width: 130px; }
th.col-opnum,       td.col-opnum       { width: 140px; }
th.col-just,        td.col-just        { width: 260px; }
th.col-start,       td.col-start       { width: 120px; }
th.col-end,         td.col-end         { width: 120px; }
th.col-userid,      td.col-userid      { width: 140px; }
th.col-username,    td.col-username    { width: 170px; }
th.col-on,          td.col-on          { width: 160px; }
th.col-status,      td.col-status      { width: 130px; }
th.col-comment,     td.col-comment     { width: 260px; }
th.col-actions,     td.col-actions     { width: 150px; }

.cell-ellipsis{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Status chips (same look as admin) */
.chip { display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; font-weight:600; }
.chip-pending { background:#dbeafe; color:#1e3a8a; }
.chip-approved{ background:#dcfce7; color:#14532d; }
.chip-declined{ background:#fee2e2; color:#7f1d1d; }
.chip-modify  { background:#fef3c7; color:#92400e; }
.chip-default { background:#f3f4f6; color:#111827; }

/* Filter popover */
.filter-pop{
  position:absolute; z-index:60;
  background:#fff; border:1px solid #e5e7eb; border-radius:10px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
  width:260px; padding:12px; animation:pop .12s ease;
}
.filter-pop h4{ font-size:12px; font-weight:700; margin:2px 0 8px; color:#374151; letter-spacing:.02em; }
.filter-pop .row{ display:flex; gap:8px; margin-top:10px; }
@keyframes pop{ from{ transform:translateY(-3px); opacity:0; } to{ transform:translateY(0); opacity:1; } }

/* Compact/Shrink */
.compact table { font-size:12px; }
.shrink { transform:scale(0.93); transform-origin:top left; width:107.5%; }


 

    [v-cloak] {
      display: none;
    }




  </style>
</head>

<body>
  <div id="dashboardApp" class="w-full p-6 border-gray-300 rounded-lg" v-cloak>

    <!-- Top Nav -->
    <header>
      <div class="w-full px-14 py-0 flex items-center justify-between">
        <!-- Left: Logo + Title -->
        <div class="flex items-center space-x-2">
          <a href="https://eagnmnwbp161f.usps.gov/" class="flex items-center space-x-2 hover:opacity-80 transition">
            <img src="https://eagnmnwbp161f.usps.gov/rework/assets/EIR_logo_color.png" alt="EIR Logo"
              class="h-16 w-16 object-contain">
            <span class="text-2xl font-semibold text-gray-700">| Workhour Analytics</span>
          </a>
        </div>

        <!-- Right: New Request + User -->
        <div class="flex items-center justify-between space-x-6">
          <a href="/ref/toolbox/flex/index.html"
            class="px-4 py-2 bg-[#3B6E8F] text-white rounded-lg font-semibold shadow hover:bg-blue-500 transition">
            + New Flex Request
          </a>
          <div v-if="userDisplayHeader" class="flex items-center space-x-4 text-lg text-gray-700 font-medium">
            {{ userDisplayHeader }}
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 w-full">
      <div class="w-full px-6">

        <!-- Breadcrumb -->
        <nav class="text-gray-600 text-md font-semibold rounded-2xl card shadow-md p-6 mb-6 -mt-12" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
            <li>
              <a href="https://eagnmnwbp161f.usps.gov/" class="flex items-center hover:text-blue-700 transition">
                <svg class="w-4 h-4 mr-1 text-gray-700" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 12l9-9 9 9M9 21V10h6v11" />
                </svg>
                WEMS Home
              </a>
            </li>
            <li>
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 5l7 7-7 7" />
              </svg>
            </li>
            <li class="text-blue-800 font-semibold">Flex Time Dashboard</li>
          </ol>
        </nav>

        <!-- Info Banner -->
        <!-- <div class="usps-blue text-white rounded-md shadow-md p-10 mb-6">
          <h1 class="text-3xl font-semibold">Flex Time Request</h1>
          <p class="text-md mt-1" v-if="officeName && fiscalYear && week">
            Office/Facility: {{ officeName }}
            <span class="hidden sm:inline"> - </span>
            Fiscal Year: {{ fiscalYear }}, Week: {{ week }}
          </p>
        </div> -->

        <!-- Info Banner (identical to admin) -->
      <div class="usps-blue text-white rounded-xl shadow-md p-8 mb-6 relative" ref="bannerWrap">
        <h1 class="text-3xl font-bold tracking-tight">Flex Time Request</h1>

        <p class="mt-2 text-base flex flex-wrap items-center gap-2">
          <span class="font-semibold">Office/Facility:</span>
          <span class="font-semibold">{{ officeName || '—' }}</span>

          <!-- Show the picker when user has more than 1 facility -->
          <button
            v-if="facilities.length > 1"
            type="button"
            class="ml-2 inline-flex items-center px-2 py-1 text-xs font-semibold rounded bg-white/15 hover:bg-white/25"
            @click.stop="openBannerMenu($event)"
            title="View all facilities"
          >
            View all ({{ facilities.length }})
          </button>

          <span class="hidden sm:inline">&nbsp;&nbsp;•&nbsp;&nbsp;</span>
          <span class="font-semibold">Fiscal Year:</span> <span class="font-semibold">{{ fiscalYear || '—' }}</span>

          <span class="hidden sm:inline">&nbsp;&nbsp;•&nbsp;&nbsp;</span>
          <span class="font-semibold">Week:</span> <span class="font-semibold">{{ week || '—' }}</span>
        </p>

        <!-- Facilities popover (anchored to the banner) -->
        <div
          v-if="bannerMenu.open"
          ref="bannerMenuRef"
          class="absolute z-[100] bg-white text-gray-800 rounded-lg shadow-2xl border border-gray-200 w-80 p-3"
          :style="{ top: bannerMenu.y + 'px', left: bannerMenu.x + 'px' }"
        >
          <div class="text-sm font-semibold text-gray-600 mb-2">Your Facilities</div>
          <ul class="max-h-64 overflow-auto divide-y divide-gray-100">
            <li v-for="f in facilities" :key="f.B_FIN_NBR" class="py-2">
              <button
                class="w-full text-left hover:bg-gray-50 rounded px-2 py-1"
                @click="gotoFacility(f)"
                :title="(f.B_FIN_NAME || '') + ' (' + (f.B_FIN_NBR || '') + ')'"
              >
                <div class="text-sm font-medium">{{ f.B_FIN_NAME }}</div>
                <div class="text-xs text-gray-500">FIN: {{ f.B_FIN_NBR }}</div>
              </button>
            </li>
          </ul>
          <div class="mt-2 text-right">
            <button class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200" @click="bannerMenu.open=false">Close</button>
          </div>
        </div>
      </div>






        <!-- Summary -->
        <section class="bg-white rounded-2xl shadow-md p-6 mb-6 border-0 border-blue-700">
          <h2 class="text-lg font-semibold text-gray-700 mb-4">Summary</h2>
          <div class="flex flex-wrap justify-between gap-4">
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Total Requests</div>
              <div class="text-2xl font-bold">{{ metrics.TOTAL }}</div>
            </div>
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Pending</div>
              <div class="text-2xl font-bold">{{ metrics.PENDING }}</div>
            </div>
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Approved</div>
              <div class="text-2xl font-bold">{{ metrics.APPROVED }}</div>
            </div>

             <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Request Modification</div>
              <div class="text-2xl font-bold">{{ metrics.MODIFICATION }}</div>
            </div>

            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Declined</div>
              <div class="text-2xl font-bold">{{ metrics.DECLINED }}</div>
            </div>
          </div>
        </section>

     


         <!-- Single Chart -->
        <div class="card p-6 mb-8">
          <h2 class="text-xl font-semibold text-blue-800 mb-2">Request Status Chart</h2>
          <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
        </div>


            <!-- <div class="bg-white rounded-2xl shadow-md p-6">
      <h2 class="text-xl font-semibold text-blue-800 mb-2">Last 7 Days Trend</h2>
      <canvas id="trendChart" height="150"></canvas> -->

            <!-- Trend Data Table -->
            <!-- <table class="min-w-full table-auto mt-4">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-4 py-2 text-left text-sm font-semibold">Date</th>
            <th class="px-4 py-2 text-left text-sm font-semibold">Count</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="item in trendData" :key="item.date" class="border-t hover:bg-gray-50">
              <td class="px-4 py-2">{{ item.date }}</td>
              <td class="px-4 py-2">{{ item.count }}</td>
            </tr>
          </tbody>
        </table>
      </div> -->





              <!-- Requests Table -->
              <!-- <div class="bg-white rounded-2xl shadow-md p-6 overflow-x-auto mb-8">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-xl font-semibold text-blue-800">All Flex-Time Requests</h2>

                  <button @click="exportTableToCSV"
                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                    📥 Export to Excel
                  </button>



                </div>
                <table class="min-w-full table-auto">
                  <thead class="bg-blue-50">
                    <tr>
                      <th class="px-4 py-2 text-left text-sm font-semibold">ID</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Facility</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Hours</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Craft</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Labour Distribution Code</th>
                      
                      <th class="px-4 py-2 text-left text-sm font-semibold">Operation Number</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Justification</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Start</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">End</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">USER ID</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">User Name</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">On</th>
                      
                      <th class="px-4 py-2 text-left text-sm font-semibold">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="req in flexRequests" :key="req.REQUESTID" class="border-t hover:bg-gray-50">
                      <td class="px-4 py-2">{{ req.REQUESTID }}</td>
                      <td class="px-4 py-2">{{ req.FACILITYID }}</td>
                      <td class="px-4 py-2">{{ req.HOURSPERWEEK }}</td>
                      <td class="px-4 py-2">{{ req.CRAFT }}</td>
                      <td class="px-4 py-2">{{ req.LABOURDISTRIBUTIONCODE }}</td>
                      <td class="px-4 py-2">{{ req.OPERATIONNUMBER }}</td>
                      <td class="px-4 py-2">{{ req.JUSTIFICATION }}</td>
                      <td class="px-4 py-2">{{ req.STARTDATE }}</td>
                      <td class="px-4 py-2">{{ req.ENDDATE }}</td>
                      <td class="px-4 py-2">{{ req.CREATEDBY }}</td>
                      <td class="px-4 py-2">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td>
                      <td class="px-4 py-2">{{ req.CREATEDON }}</td>
                      
                      
                    
                      <td class="px-4 py-2">
        <div class="flex items-center gap-2">
          <button
            class="px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed"
            @click.prevent="openEdit(req)"
            :disabled="isLocked(req)"
            title="Edit this request"
          >
            Edit
          </button>

          <button
            class="px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed"
            @click.prevent="confirmDelete(req)"
            :disabled="isLocked(req)"
            title="Delete this request"
          >
            Delete
          </button>
        </div>
        <div v-if="isLocked(req)" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
          Locked by admin
        </div>
      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

            </div>
          </main>

          
          
          


      <div v-if="showEditModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Edit Request #{{ editForm.requestId }}</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
              <label class="font-semibold">Craft</label>
              <select v-model="editForm.craft" class="w-full border rounded p-2">
                <option>clerk</option>
                <option>mailhandler</option>
              </select>
            </div>
            
            <div>
              <label class="font-semibold">LDC</label>
              <input v-model.number="editForm.ldc" class="w-full border rounded p-2" />
            </div>
            <div>
              <label class="font-semibold">Operation #</label>
              <input v-model="editForm.operationNumber" class="w-full border rounded p-2" />
            </div>

            <div>
              <label class="block text-sm font-medium">Hours / Week</label>
              <input type="number" step="0.01" min="0.01" max="100" v-model.number="editForm.hours" class="mt-1 w-full border rounded p-2">
            </div>
            <div>
              <label class="block text-sm font-medium">Start Date</label>
              <input type="date" v-model="editForm.startDate" class="mt-1 w-full border rounded p-2">
            </div>
            <div>
              <label class="block text-sm font-medium">End Date</label>
              <input type="date" v-model="editForm.endDate" class="mt-1 w-full border rounded p-2">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium">Justification</label>
              <textarea rows="4" v-model="editForm.justification" class="mt-1 w-full border rounded p-2"></textarea>
            </div>
          </div>

          <div class="flex items-center justify-end gap-2 mt-6">
            <button class="px-4 py-2 rounded border" @click="showEditModal=false">Cancel</button>
            <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @click="saveEdit">Save</button>
          </div>

          <p v-if="editStatus" class="mt-3 text-sm" :class="editStatusOK ? 'text-green-700':'text-red-700'">
            {{ editStatus }}
          </p>
        </div> -->



<div class="card p-4 mb-8" :class="[{ compact: compactView }, { shrink: shrinkToFit }]">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-xl font-semibold text-blue-800">All Flex-Time Requests</h2>
    <div class="flex items-center gap-3">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="compactView"/>
        <span>Compact view</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="shrinkToFit"/>
        <span>Shrink to fit</span>
      </label>

      <button @click="exportTableToCSV"
              class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
        📥 Export to CSV
      </button>
    </div>
  </div>

  <div class="tbl-wrap relative" ref="tblWrap">
    <table>
      <thead>
        <tr style="background:#3B6E8F; color:#fff;">
          <th class="col-id">
            <div class="th-inner">
              <span class="font-semibold">ID</span>
              <button class="filter-btn" @click.stop="openFilterMenu('REQUESTID', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-facility">
            <div class="th-inner">
              <span class="font-semibold">Facility</span>
              <button class="filter-btn" @click.stop="openFilterMenu('FACILITYID', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <!-- NEW: Facility Name -->
          <th class="col-facname">
            <div class="th-inner">
              <span class="font-semibold">Facility Name</span>
              <button class="filter-btn" @click.stop="openFilterMenu('FACILITYNAME', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <th class="col-hours">
            <div class="th-inner">
              <span class="font-semibold">Hours</span>
              <button class="filter-btn" @click.stop="openFilterMenu('HOURSPERWEEK', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-craft">
            <div class="th-inner">
              <span class="font-semibold">Craft</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CRAFT', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-ldc">
            <div class="th-inner">
              <span class="font-semibold">LDC</span>
              <button class="filter-btn" @click.stop="openFilterMenu('LABOURDISTRIBUTIONCODE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-opnum">
            <div class="th-inner">
              <span class="font-semibold">Operation #</span>
              <button class="filter-btn" @click.stop="openFilterMenu('OPERATIONNUMBER', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-just">
            <div class="th-inner">
              <span class="font-semibold">Justification</span>
              <button class="filter-btn" @click.stop="openFilterMenu('JUSTIFICATION', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-start">
            <div class="th-inner">
              <span class="font-semibold">Start</span>
              <button class="filter-btn" @click.stop="openFilterMenu('STARTDATE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-end">
            <div class="th-inner">
              <span class="font-semibold">End</span>
              <button class="filter-btn" @click.stop="openFilterMenu('ENDDATE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-userid">
            <div class="th-inner">
              <span class="font-semibold">USER ID</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CREATEDBY', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-username">
            <div class="th-inner">
              <span class="font-semibold">User Name</span>
              <button class="filter-btn" @click.stop="openFilterMenu('USER_NAME', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-on">
            <div class="th-inner">
              <span class="font-semibold">On</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CREATEDON', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <!-- NEW: Status & Comment -->
          <th class="col-status">
            <div class="th-inner">
              <span class="font-semibold">Status</span>
              <button class="filter-btn" @click.stop="openFilterMenu('STATUS', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-comment">
            <div class="th-inner">
              <span class="font-semibold">Comment</span>
              <button class="filter-btn" @click.stop="openFilterMenu('COMMENT', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <th class="col-actions"><span class="font-semibold">Actions</span></th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="req in filteredRequests" :key="req.REQUESTID" class="border-top">
          <td class="col-id">{{ req.REQUESTID }}</td>
          <td class="col-facility">{{ req.FACILITYID }}</td>
          <td class="col-facname cell-ellipsis" :title="req.FACILITYNAME">{{ req.FACILITYNAME }}</td>
          <td class="col-hours">{{ req.HOURSPERWEEK }}</td>
          <td class="col-craft">{{ req.CRAFT }}</td>
          <td class="col-ldc">{{ req.LABOURDISTRIBUTIONCODE }}</td>
          <td class="col-opnum">{{ req.OPERATIONNUMBER }}</td>
          <td class="col-just cell-ellipsis" :title="req.JUSTIFICATION">{{ req.JUSTIFICATION }}</td>
          <td class="col-start">{{ req.STARTDATE }}</td>
          <td class="col-end">{{ req.ENDDATE }}</td>
          <td class="col-userid">{{ req.CREATEDBY }}</td>
          <td class="col-username">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td>
          <td class="col-on">{{ req.CREATEDON }}</td>

          <!-- Status chip (admin style) -->
          <td class="col-status">
            <span :class="statusClass(req.STATUS)">{{ req.STATUS }}</span>
          </td>
          <!-- Latest comment (if any) -->
          <td class="col-comment cell-ellipsis" :title="req.COMMENT || ''">{{ req.COMMENT }}</td>

          <td class="col-actions">
            <div class="flex items-center gap-2">
              <button
  type="button"
  class="px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed"
  @click.stop.prevent="onEditClick(req)"
  :disabled="isLocked(req)"
  title="Edit this request"
>
  Edit
</button>

              <button
                class="px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed"
                @click.prevent="confirmDelete(req)"
                :disabled="isLocked(req)"
                title="Delete this request"
              >Delete</button>
            </div>
            <div v-if="isLocked(req)" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
              Locked by admin
            </div>
          </td>
        </tr>
      </tbody>
    </table>




    <!-- Excel-style filter popover -->
    <div v-if="filterMenu.open"
         class="filter-pop"
         :style="{ left: filterMenu.x + 'px', top: filterMenu.y + 'px' }"
         ref="filterMenuRef">
      <h4>Filter: {{ filterMenu.field }}</h4>

      <!-- STATUS gets an exact-match dropdown -->
      <template v-if="filterMenu.field === 'STATUS'">
        <select
          class="w-full border rounded px-2 py-1 text-sm"
          :value="filters.STATUS"
          @change="onStatusChange($event)">
          <option value="">(All)</option>
          <option v-for="opt in statusOptions" :key="opt" :value="opt">{{ opt }}</option>
        </select>
      </template>

      <!-- Others = contains text -->
      <template v-else>
        <input v-model="filters[filterMenu.field]"
               class="w-full border rounded px-2 py-1 text-sm"
               placeholder="Type to filter…">
      </template>

      <div class="row">
        <button class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200"
                @click.stop="clearFilter(filterMenu.field)">
          Clear
        </button>
        <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                @click.stop="filterMenu.open=false">
          Close
        </button>
      </div>
    </div>
  </div>
</div>


<div v-if="showEditModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
    <h3 class="text-lg font-semibold mb-4">Edit Request #{{ editForm.requestId }}</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium">Hours / Week</label>
        <input type="number" step="0.01" min="0.01" max="100"
               v-model.number="editForm.hours" class="mt-1 w-full border rounded p-2">
      </div>


      <!-- <div>
        <label class="block text-sm font-medium">Start Date</label>
        <input type="date" v-model="editForm.startDate" class="mt-1 w-full border rounded p-2">
      </div>
      <div>
        <label class="block text-sm font-medium">End Date</label>
        <input type="date" v-model="editForm.endDate" class="mt-1 w-full border rounded p-2">
      </div> -->

      <!-- Start Week (Saturday) -->
      <div>
        <label for="wk_start_edit" class="block text-sm font-medium">Start Week</label>
        <select
          id="wk_start_edit"
          v-model="editForm.wk_start"
          @change="onEditStartChange"
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
        >
          <option disabled value="">-------------</option>
          <option v-for="row in weekOptions" :key="row[0]+'-'+row[1]+'-s'"
                  :value="row[2]">Week {{ row[1] }}, {{ row[2] }} (Saturday)</option>
        </select>
      </div>

      <!-- End Week (Friday) -->
    <div>
      <label for="wk_end_edit" class="block text-sm font-medium">End Week</label>
      <select
        id="wk_end_edit"
        v-model="editForm.wk_end"
        @change="onEditEndChange"
        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
      >
        <option disabled value="">-------------</option>
        <option v-for="row in weekOptions" :key="row[0]+'-'+row[1]+'-e'"
                :value="row[3]">Week {{ row[1] }}, {{ row[3] }} (Friday)</option>
      </select>
    </div>

    <!-- Read-only confirmation of the concrete dates that will be saved -->
    <div class="md:col-span-2 text-xs text-gray-600">
      Start: <span class="font-medium">{{ editForm.startDate }}</span>
      &nbsp;•&nbsp;
      End: <span class="font-medium">{{ editForm.endDate }}</span>
    </div>



      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Justification</label>
        <textarea rows="4" v-model="editForm.justification"
                  class="mt-1 w-full border rounded p-2"></textarea>
      </div>
    </div>

    <div class="flex items-center justify-end gap-2 mt-6">
      <button class="px-4 py-2 rounded border" @click="showEditModal=false">Cancel</button>
      <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @click="saveEdit">Save</button>
    </div>

    <p v-if="editStatus" class="mt-3 text-sm"
       :class="editStatusOK ? 'text-green-700':'text-red-700'">
      {{ editStatus }}
    </p>
  </div>
</div>



</div>



  </div>


  

  <!-- Dashboard script -->
  <script type="module" src="/ref/toolbox/flex/dashboard.js"></script>
</body>

</html>



=========================================================================================================================


import { createApp } from 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.esm-browser.min.js';

createApp({
  data() {
    return {
      serviceFolder: '/ref/api/v1/toolbox/flex/',
      metrics: { TOTAL: 0, PENDING: 0, APPROVED: 0, MODIFICATION: 0, DECLINED: 0 },

      statusChart: null,            // (already used for the bar)
  statusOptions: [],            // dropdown list for STATUS
  filters: {
  REQUESTID: '',
  FACILITYID: '',
  FACILITYNAME: '',
  HOURSPERWEEK: '',
  CRAFT: '',
  LABOURDISTRIBUTIONCODE: '',
  OPERATIONNUMBER: '',
  JUSTIFICATION: '',
  STARTDATE: '',
  ENDDATE: '',
  CREATEDBY: '',
  USER_NAME: '',
  CREATEDON: '',
  STATUS: '',
  COMMENT: ''
},
compactView: true,            // NEW: default like admin
shrinkToFit: false,           // NEW
filterMenu: { open:false, field:'', x:0, y:0 }, // NEW

facilityData: [],
trendData: [],
flexRequests: [],
userDisplayHeader: '',
officeName: '',
fiscalYear: '',
week:'',

facilities: [],                       // list of facilities user can access
bannerMenu: { open:false, x:0, y:0 }, // banner popover placement
userAceid: '',
selectedRequest: null,
weekOptions: [],
showEditModal: false,
editForm: { requestId: null, hours: null, justification: '', startDate: '', endDate: '', wk_start: '', wk_end:'' },
editStatus: '',
editStatusOK: false
    };
  },


computed: {
  filteredRequests() {
    const rows = Array.isArray(this.flexRequests) ? this.flexRequests : [];
    const f = this.filters;
    const match = (val, filter) =>
      !filter || String(val ?? '').toLowerCase().includes(String(filter).toLowerCase());

    return rows.filter((r) => {
      if (!r || typeof r !== 'object') return false;
      const userName = `${r.USER_FNAME || ''} ${r.USER_LNAME || ''}`.trim();

      return (
        match(r.REQUESTID,               f.REQUESTID) &&
        match(r.FACILITYID,              f.FACILITYID) &&
        match(r.FACILITYNAME,            f.FACILITYNAME) &&
        match(r.HOURSPERWEEK,            f.HOURSPERWEEK) &&
        match(r.CRAFT,                   f.CRAFT) &&
        match(r.LABOURDISTRIBUTIONCODE,  f.LABOURDISTRIBUTIONCODE) &&
        match(r.OPERATIONNUMBER,         f.OPERATIONNUMBER) &&
        match(r.JUSTIFICATION,           f.JUSTIFICATION) &&
        match(r.STARTDATE,               f.STARTDATE) &&
        match(r.ENDDATE,                 f.ENDDATE) &&
        match(r.CREATEDBY,               f.CREATEDBY) &&
        match(userName,                  f.USER_NAME) &&
        match(r.CREATEDON,               f.CREATEDON) &&
        (!f.STATUS || String(r.STATUS || '').toLowerCase() === f.STATUS.toLowerCase()) &&
        match(r.COMMENT,                 f.COMMENT)
      );
    });
  }
},





  methods: {
    // Authentication & data fetching (unchanged)
    // async authenticate() {
    //   try {
    //     await axios.get(`/ref/api/v1/authenticate.cfc?method=getUserAuth`).then((res) => {
    //       console.log('response data: ', res.data);
    //       if (res.data) {
    //         this.userDisplayHeader = `${res.data.first} ${
    //           res.data.last
    //         } (${res.data.aceid.toUpperCase()})`;
    //       }
    //     });
    //   } catch (e) {
    //     console.error('Auth error', e);
    //   }
    // },


   
      async authenticate() {
  try {
    const res = await axios.get(`/ref/api/v1/authenticate.cfc?method=getUserAuth`);
    if (res.data) {
      this.userDisplayHeader = `${res.data.first} ${res.data.last} (${res.data.aceid.toUpperCase()})`;
      this.userAceid = res.data.aceid || '';
      if (this.userAceid) await this.getMyFacilities(); // load facilities for banner
    }
  } catch (e) {
    console.error('Auth error', e);
  }
},


async getMyFacilities() {
  try {
    const res = await axios.get(
      `${this.serviceFolder}dashboard.cfc?method=getMyFacilities&userid=${encodeURIComponent(this.userAceid)}`
    );
    this.facilities = Array.isArray(res.data) ? res.data : [];

    // If server header doesn't give us officeName and there is only one facility, show it
    if ((!this.officeName || !this.officeName.trim()) && this.facilities.length === 1) {
      const f = this.facilities[0];
      this.officeName = f.B_FIN_NAME || this.officeName;
    }
  } catch (e) {
    console.error('Facilities error', e);
    this.facilities = [];
  }
},


async loadWeekOptions() {
  try {
    const res = await axios.get(`${this.serviceFolder}flex.cfc?method=getWeekOptions&returnformat=json`);
    if (res.data) {
      const raw = res.data.DATA || res.data.data || [];
      const FMT = [
        'YYYY-MM-DD',
        'YYYY-MM-DD HH:mm',
        'YYYY-MM-DD HH:mm:ss',
        'YYYY-MM-DD HH:mm:ss.SSS',
        'YYYY-MM-DDTHH:mm:ssZ',
        'YYYY-MM-DDTHH:mm:ss.SSSZ',
        'MM/DD/YYYY'
      ];
      const toISO = (v) => {
        if (!v) return '';
        if (typeof v === 'number') {
          const ms = v < 1e12 ? v * 1000 : v;
          return moment(ms).format('YYYY-MM-DD');
        }
        let m = moment(v, FMT, true);
        if (!m.isValid()) m = moment.parseZone(v);
        return m.isValid() ? m.format('YYYY-MM-DD') : '';
      };
      // raw row: [fiscalYear, week, startDate, endDate]
      this.weekOptions = raw.map(row => [row[0], row[1], toISO(row[2]), toISO(row[3])]);
    }
  } catch (e) {
    console.error("Couldn't load weeks", e);
    this.weekOptions = [];
  }
},



asDate(v) {
  if (!v) return null;
  const FMT = [
    'YYYY-MM-DD',
    'YYYY-MM-DD HH:mm',
    'YYYY-MM-DD HH:mm:ss',
    'YYYY-MM-DD HH:mm:ss.SSS',
    'YYYY-MM-DDTHH:mm:ssZ',
    'YYYY-MM-DDTHH:mm:ss.SSSZ'
  ];
  let m = moment(v, FMT, true);
  if (!m.isValid()) m = moment.parseZone(v);
  return m.isValid() ? m.toDate() : null;
},

onEditStartChange() {
  // keep startDate mirrored to wk_start
  this.editForm.startDate = this.editForm.wk_start || '';
  const s = this.asDate(this.editForm.wk_start);
  const e = this.asDate(this.editForm.wk_end);
  if (s && e && e < s) {
    // nudge end up to start
    this.editForm.wk_end   = this.editForm.wk_start;
    this.editForm.endDate  = this.editForm.wk_end;
  }
},

onEditEndChange() {
  // keep endDate mirrored to wk_end
  this.editForm.endDate = this.editForm.wk_end || '';
  const s = this.asDate(this.editForm.wk_start);
  const e = this.asDate(this.editForm.wk_end);
  if (s && e && e < s) {
    // show a quick guard; you can style/message if you want
    this.editForm.wk_end  = this.editForm.wk_start;
    this.editForm.endDate = this.editForm.wk_end;
  }
},



    async fetchDashboard() {
      try {
        const res = await axios.get(
          `${this.serviceFolder}dashboard.cfc?method=getDashboardData&userid=${encodeURIComponent(this.userAceid)}`
        );
        this.metrics = res.data;
        this.renderChart();
      } catch (e) {
        console.error('Dashboard load error', e);
      }
    },


    async fetchHeaderData() {
  try {
    const res = await axios.get(
      `${this.serviceFolder}dashboard.cfc?method=getHeaderData&userid=${encodeURIComponent(this.userAceid)}`
    );
    this.officeName = res.data.officeName || this.officeName || '';
    this.fiscalYear = res.data.fiscalYear || '';
    this.week       = res.data.week || '';

    // client fallback if needed
    if (!this.fiscalYear || !this.week) {
      const x = this.computeClientFYWeek();
      if (!this.fiscalYear) this.fiscalYear = x.fy;
      if (!this.week)       this.week       = x.week;
    }
  } catch (e) {
    console.error('Header load error', e);
    const x = this.computeClientFYWeek();
    // fallback if network error
    if (!this.fiscalYear) this.fiscalYear = x.fy;
    if (!this.week)       this.week       = x.week;
  }
},


openBannerMenu(evt) {
  const wrap = this.$refs.bannerWrap;
  if (!wrap) return;
  const b = evt.currentTarget.getBoundingClientRect();
  const w = wrap.getBoundingClientRect();
  // position relative to banner
  this.bannerMenu.x = (b.left - w.left);
  this.bannerMenu.y = (b.bottom - w.top) + 6;
  this.bannerMenu.open = true;
  evt.stopPropagation();
},
gotoFacility(f) {
  if (!f) return;

  // update banner text
  this.officeName = f.B_FIN_NAME || this.officeName;
  // optional: if you later add filters on dashboard, set them here
  // e.g., this.filters.FACILITYID = String(f.B_FIN_NBR || '');
  if (this.filters && Object.prototype.hasOwnProperty.call(this.filters, 'FACILITYID')) {
    this.filters.FACILITYID = String(f.B_FIN_NBR || '');
  }
  this.bannerMenu.open = false;
},
_onDocClickBanner(e) {
  if (!this.bannerMenu.open) return;
  const pop = this.$refs.bannerMenuRef;
  if (pop && pop.contains(e.target)) return; // clicks inside popover keep it open
  // ignore clicks on the trigger itself
  if (e.target && e.target.closest && e.target.closest('[title="View all facilities"]')) return;
  this.bannerMenu.open = false;
},



   computeClientFYWeek() {
  const today = new Date();
  const y = today.getFullYear();

  const sept30 = new Date(y, 8, 30); // Sep
  const dow = sept30.getDay();       // 0=Sun..6=Sat
  const backDays = (dow === 6 ? 0 : (dow + 1)); // days since Saturday
  const lastSat = new Date(sept30); lastSat.setDate(sept30.getDate() - backDays);

  let fyStart = lastSat;
  if (today < lastSat) {
    const prevSept30 = new Date(y - 1, 8, 30);
    const prevDow = prevSept30.getDay();
    const prevBack = (prevDow === 6 ? 0 : (prevDow + 1));
    fyStart = new Date(prevSept30); fyStart.setDate(prevSept30.getDate() - prevBack);
  }

  const fy = fyStart.getFullYear() + 1;

  const startUTC = Date.UTC(fyStart.getFullYear(), fyStart.getMonth(), fyStart.getDate());
  const todayUTC = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
  const days = Math.floor((todayUTC - startUTC) / (1000 * 60 * 60 * 24));
  const week = 1 + Math.floor(days / 7);

  return { fy, week };
},


// ADD inside methods:{ ... }
async saveEdit() {
  try {
    const rid = this.editForm.requestId;
    if (!rid) {
      this.editStatusOK = false;
      this.editStatus = 'Missing RequestID.';
      return;
    }

    // Normalize fields only if provided/changed
    const toISO = (v) => (v ? String(v).slice(0, 10) : '');
    const numOrEmpty = (v) => (v === null || v === undefined || v === '' ? '' : String(v));

    const fd = new FormData();
    fd.append('requestId', String(rid));

    // Only append fields the user actually edited; CF won't update missing ones
    if (this.editForm.hours !== null && this.editForm.hours !== undefined && this.editForm.hours !== '') {
      fd.append('hours', numOrEmpty(this.editForm.hours));
    }
    if (this.editForm.justification && this.editForm.justification.trim().length) {
      fd.append('justification', this.editForm.justification.trim());
    }
    if (this.editForm.startDate) {
      fd.append('startDate', toISO(this.editForm.startDate)); // YYYY-MM-DD
    }
    if (this.editForm.endDate) {
      fd.append('endDate', toISO(this.editForm.endDate));     // YYYY-MM-DD
    }

    // Send as multipart/form-data (CF classic path)
    const url = `${this.serviceFolder}dashboard.cfc?method=updateUserRequest&returnformat=json&userid=${encodeURIComponent(this.userAceid)}`;
    const res = await axios.post(url, fd, { validateStatus: () => true });

    console.log('updateUserRequest →', res.status, res.data);

    // Surface server errors clearly
    if (res.status !== 200 || !res.data || res.data.SUCCESS !== true) {
      const msg = (res.data && (res.data.MESSAGE || res.data.DETAILS)) || `Save failed (HTTP ${res.status})`;
      this.editStatusOK = false;
      this.editStatus = msg;
      alert(msg); // make it obvious in UI
      return;
    }

    // Success → patch the row from the authoritative server payload
    const data = res.data.DATA || {};
    const idx = this.flexRequests.findIndex(r => r.REQUESTID === data.REQUESTID);
    if (idx >= 0) this.flexRequests[idx] = { ...this.flexRequests[idx], ...data };

    this.editStatusOK = true;
    this.editStatus = 'Saved.';
    this.showEditModal = false;
  } catch (e) {
    console.error('saveEdit error', e);
    this.editStatusOK = false;
    this.editStatus = 'Save failed.';
    alert('Save failed. See console for details.');
  }
},

    //New line below
    // async fetchDashboard(){
    //   try {
    //     const res = await axios.get(
    //       `${this.serviceFolder}dashboardservice.cfc?method=getDashboardData`
    //     );

    //     //unpacking everything
    //     const data = res.data;
    //     this.metrics = data.metrics;
    //     this.facilityData = data.facilityData;
    //     this.trendData = data.trendData;

    //     //now draw both charts
    //     this.renderCharts();

    //   }catch (e) {
    //     console.error('Dashboard load error', e);
    //   }

    //   },

    // async fetchFlexRequests() {
    //   try {
    //     const res = await axios.get(
    //       `${this.serviceFolder}dashboardservice.cfc?method=getFlexRequests`
    //     );
    //     console.log('Requests', res.data);
    //     this.flexRequests = res.data;
    //   } catch (e) {
    //     console.error('Error loading request', e);
    //   }
    // },



    async fetchFlexRequests() {
  try {
    const res = await axios.get(`${this.serviceFolder}dashboard.cfc?method=getFlexRequests&userid=${encodeURIComponent(this.userAceid)}`);
    const rows = Array.isArray(res.data) ? res.data : [];
    this.flexRequests = rows.filter(r => r && typeof r === 'object');

    // Build status dropdown values
    this.statusOptions = Array.from(
      new Set(this.flexRequests.map(r => r.STATUS).filter(Boolean))
    ).sort();
  } catch (e) {
    console.error('Error loading request', e);
    this.flexRequests = [];
    this.statusOptions = [];
  }
},


    // ---------- chart (includes Modify) ----------
    renderChart() {
      const el = document.getElementById('trendChart');
      if (!el) return;
      const ctx = el.getContext('2d');
      if (this.statusChart) { this.statusChart.destroy(); this.statusChart = null; }

      const { TOTAL, PENDING, APPROVED, MODIFICATION, DECLINED } = this.metrics;

      this.statusChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['TOTAL', 'PENDING', 'APPROVED', 'MODIFY', 'DECLINED'],
          datasets: [{
            label: 'Number of Requests',
            data: [TOTAL, PENDING, APPROVED, MODIFICATION, DECLINED],
            backgroundColor: [
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 99, 132, 0.8)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1,
            borderRadius: 8,
            barPercentage: 0.6,
            categoryPercentage: 0.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Request Trend', font: { size: 18, weight: '500' } },
            legend: { display: false }
          },
          scales: {
            x: { grid: { display: false }, ticks: { font: { size: 13 } } },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)', borderDash: [3, 3] },
              ticks: { stepSize: 10, font: { size: 12 } }
            }
          }
        }
      });
    },



    // Status chip class (same mapping as admin)
statusClass(status) {
  switch ((status || '').toString()) {
    case 'Approved': return 'chip chip-approved';
    case 'Pending':  return 'chip chip-pending';
    case 'Declined': return 'chip chip-declined';
    case 'Modify':   return 'chip chip-modify';
    default:         return 'chip chip-default';
  }
},

// Excel-style filter menu placement (anchor to .tbl-wrap)
openFilterMenu(field, evt) {
  const btn = evt.currentTarget;
  const container = this.$refs.tblWrap;
  if (!btn || !container) return;

  const b = btn.getBoundingClientRect();
  const c = container.getBoundingClientRect();

  // account for shrink scaling
  const scaleX = (c.width  / container.clientWidth)  || 1;
  const scaleY = (c.height / container.clientHeight) || 1;

  let x = (b.left - c.left) / scaleX + container.scrollLeft;
  const y = (b.bottom - c.top) / scaleY + container.scrollTop + 6;

  // keep inside container
  const menuWidth = 260;
  const maxX = container.scrollLeft + container.clientWidth - menuWidth - 8;
  if (x > maxX) x = Math.max(container.scrollLeft, maxX);

  this.filterMenu = { open:true, field, x, y };
  evt.stopPropagation();
},
onStatusChange(e){
  const val = (e && e.target) ? e.target.value : '';
  this.filters.STATUS = String(val || '');
  this.filterMenu.open = false;
},
clearFilter(field){
  this.filters[field] = '';
  this.filterMenu.open = false;
},
onDocClick(e){
  const pop = this.$refs.filterMenuRef;
  if (!pop) { this.filterMenu.open = false; return; }
  if (!pop.contains(e.target)) this.filterMenu.open = false;
},
onContainerScroll(){ if (this.filterMenu.open) this.filterMenu.open = false; },
onWinResize(){ if (this.filterMenu.open) this.filterMenu.open = false; },


/**
 * Fetch 15-day status trends and render the line chart.
 */
// async fetchTrendData15Days() {
//   try {
//     const res = await axios.get(
//       `${this.serviceFolder}dashboardservice.cfc?method=getTrendData15Days`
//     );
//     this.trendData15Days = res.data;
//     this.renderTrendLineChart();
//   } catch (e) {
//     console.error('Trend data load error', e);
//   }
// },


/**
 * Renders a multi-series line chart into #facilityChart
 */
// renderTrendLineChart() {
//   if (!this.trendData15Days.length) return;
//   const labels = this.trendData15Days.map(r => r.DayDate);
//   const totals    = this.trendData15Days.map(r => r.Total);
//   const pending   = this.trendData15Days.map(r => r.Pending);
//   const approved  = this.trendData15Days.map(r => r.Approved);
//   const declined  = this.trendData15Days.map(r => r.Declined);

//   const ctx = document.getElementById('facilityChart').getContext('2d');
//   // destroy old chart if exists
//   if (this.trendLineChart) this.trendLineChart.destroy();

//   this.trendLineChart = new Chart(ctx, {
//     type: 'line',
//     data: {
//       labels,
//       datasets: [
//         {
//           label: 'Total',
//           data: totals,
//           borderWidth: 2,
//           tension: 0.3
//         },
//         {
//           label: 'Pending',
//           data: pending,
//           borderWidth: 2,
//           tension: 0.3
//         },
//         {
//           label: 'Approved',
//           data: approved,
//           borderWidth: 2,
//           tension: 0.3
//         },
//         {
//           label: 'Declined',
//           data: declined,
//           borderWidth: 2,
//           tension: 0.3
//         }
//       ]
//     },
//     options: {
//       responsive: true,
//       plugins: {
//         legend: { position: 'top' },
//         title: {
//           display: false
//         }
//       },
//       scales: {
//         x: {
//           ticks: { maxRotation: 0 },
//           title: { display: true, text: 'Date' }
//         },
//         y: {
//           beginAtZero: true,
//           title: { display: true, text: 'Count' }
//         }
//       }
//     }
//   });
// },


isLocked(req) {
  if (!req) return true;
  // Allow editing while Pending or Modify, regardless of audit history
  if (req.STATUS === 'Pending' || req.STATUS === 'Modify') return false;
  // Otherwise fall back to server-provided lock flag
  return !!(req.LOCKED === 1 || req.LOCKED === true);
},


// openEdit(req) {
//   try {
//     if (!req) return;
//     if (this.isLocked(req)) return;

//     // show the modal first so even if data massaging fails, user sees something
//     this.showEditModal = true;

//     const numOrNull = (v) => (v === null || v === undefined || v === '') ? null : Number(v);
//     const toDate10   = (v) => (v && typeof v === 'string') ? v.slice(0, 10) : (v || '');

//     // keep a reference for Save
//     this.selectedRequest = req;

//     // initialize edit form defensively
//     this.editForm = {
//       requestId:     req.REQUESTID,
//       hours:         numOrNull(req.HOURSPERWEEK) ?? 0,
//       justification: (req.JUSTIFICATION || ''),
//       startDate:     toDate10(req.STARTDATE),
//       endDate:       toDate10(req.ENDDATE)
//     };

//     // clear any old status messages
//     this.editStatus   = '';
//     this.editStatusOK = false;

//     // focus first input after modal mounts (optional)
//     this.$nextTick(() => {
//       const first = document.querySelector('input[type="number"], textarea');
//       if (first) first.focus();
//     });
//   } catch (e) {
//     console.error('openEdit error:', e);
//     this.editStatus   = 'Unable to open editor.';
//     this.editStatusOK = false;
//     // ensure modal is visible even if something threw
//     this.showEditModal = true;
//   }
// },


openEdit(req) {
  try {
    if (!req) return;
    if (this.isLocked(req)) return;

    this.showEditModal = true;

    const numOrNull = (v) => (v === null || v === undefined || v === '') ? null : Number(v);
    const toDate10  = (v) => (v && typeof v === 'string') ? v.slice(0, 10) : (v || '');

    this.selectedRequest = req;

    this.editForm = {
      requestId:     req.REQUESTID,
      hours:         numOrNull(req.HOURSPERWEEK) ?? 0,
      justification: (req.JUSTIFICATION || ''),
      startDate:     toDate10(req.STARTDATE), // existing ISO
      endDate:       toDate10(req.ENDDATE),   // existing ISO
      wk_start:      toDate10(req.STARTDATE), // NEW: seed the selects to match
      wk_end:        toDate10(req.ENDDATE)    // NEW
    };

    this.editStatus   = '';
    this.editStatusOK = false;

    this.$nextTick(() => {
      const first = document.querySelector('input[type="number"], textarea');
      if (first) first.focus();
    });
  } catch (e) {
    console.error('openEdit error:', e);
    this.editStatus   = 'Unable to open editor.';
    this.editStatusOK = false;
    this.showEditModal = true;
  }
},






// onEditClick(req) {
//   // Quick visibility/log to prove the handler is firing
//   try { console.log('Edit clicked:', req?.REQUESTID, 'locked?', this.isLocked(req)); } catch(_) {}

//   // Call your existing logic
//   this.openEdit(req);

//   // Safety net: even if openEdit hit a minor issue, ensure the modal shows
//   if (!this.showEditModal) {
//     this.showEditModal = true;
//   }
// },

async onEditClick(req) {
  try { console.log('Edit clicked:', req?.REQUESTID, 'locked?', this.isLocked(req)); } catch(_){}
  if (!this.weekOptions || !this.weekOptions.length) {
    await this.loadWeekOptions();
  }
  this.openEdit(req);
  if (!this.showEditModal) this.showEditModal = true;
},





confirmDelete(req) {
  if (this.isLocked(req)) return;
  const ok = window.confirm(`Delete request #${req.REQUESTID}? This cannot be undone.`);
  if (!ok) return;
  this.deleteRequest(req);
},

async deleteRequest(req) {
  const fd = new FormData();
  fd.append('requestId', req.REQUESTID);

  try {
    const res = await axios.post(
      `${this.serviceFolder}dashboard.cfc?method=deleteUserRequest&returnformat=json&userid=${encodeURIComponent(this.userAceid)}`,
      fd,
      { validateStatus: () => true }
    );

    if (res.status === 200 && res.data && res.data.SUCCESS) {
      this.flexRequests = this.flexRequests.filter(r => r.REQUESTID !== req.REQUESTID);
    } else {
      console.log("failed response is: " + JSON.stringify(res.data?.MESSAGE))
      alert(res.data?.MESSAGE || `Delete failed (HTTP ${res.status})`);
    }
  } catch (err) {
    console.error(err);
    alert('Delete failed.');
  }
},



    exportTableToCSV() {
      // CSV Headers
      const headers = ['ID', 'Facility', 'Hours', 'Start', 'End', 'By', 'On'];

      // Extract data from flexRequests array
      const rows = this.flexRequests.map((req) => [
        req.REQUESTID,
        req.FACILITYID,
        req.HOURSPERWEEK,
        req.STARTDATE,
        req.ENDDATE,
        req.CREATEDBY,
        req.CREATEDON
      ]);

      // Convert to CSV format
      const csvContent = [
        headers.join(','), // header row
        ...rows.map((row) =>
          row
            .map((cell) => {
              const text = String(cell).replace(/"/g, '""');
              return `"${text}"`;
            })
            .join(',')
        )
      ].join('\r\n');

      // Create and trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const downloadLink = document.createElement('a');
      downloadLink.href = url;
      downloadLink.setAttribute('download', 'flex-time-requests.csv');
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
      URL.revokeObjectURL(url);
    }
  },
  async mounted() {

    document.addEventListener('click', this._onDocClickBanner);
      document.addEventListener('click', this.onDocClick);  



      
      console.clear();
    this.authenticate().then(() => {
      this.fetchHeaderData(); // ensure banner shows FY/Week on load
      this.loadWeekOptions();
      this.fetchDashboard();
      this.fetchFlexRequests();
    });

     // keep popover sane on scroll/resize (NEW)
  const cont = this.$refs.tblWrap;
  if (cont) cont.addEventListener('scroll', this.onContainerScroll, { passive:true });
  window.addEventListener('resize', this.onWinResize, { passive:true });

  window.addEventListener('error', (e) => console.error('GlobalError:', e.error || e.message));
window.addEventListener('unhandledrejection', (e) => console.error('UnhandledRejection:', e.reason));
  },

  beforeUnmount() {
  document.removeEventListener('click', this._onDocClickBanner);

      document.removeEventListener('click', this.onDocClick);
const cont = this.$refs.tblWrap;
if (cont) cont.removeEventListener('scroll', this.onContainerScroll);
window.removeEventListener('resize', this.onWinResize);

},

}).mount('#dashboardApp');



===================================================================================



<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flex Time Admin Dashboard</title>

  <!-- Tailwind JIT -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Axios, Vue (ESM), Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Global CSS -->
  <link rel="stylesheet" href="/ref/styles/global.css" />

   <style>
    body { margin: 0; background: #f1f5f9; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* Header bar */
    header {
      position: fixed; top: 0; left: 0; right: 0;
      background: #fff; border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0,0,0,.05); z-index: 50;
    }
    main { padding-top: 5rem; }

    .usps-blue { background-color: #3B6E8F; }

    /* Card look */
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }

    /* Chart height compact so Summary + Chart are visible together */
    .chart-wrap { height: 14rem; }

    /* Table improvements */
    .tbl-wrap { overflow: auto; position: relative }
    table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    thead th { position: sticky; top: 0; z-index: 1; }
    thead th .th-inner { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    thead th button.filter-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width: 22px; height: 22px; border-radius: 6px;
      background: rgba(255,255,255,0.12); color: #fff; border: 1px solid rgba(255,255,255,0.28);
    }
    thead th button.filter-btn:hover { background: rgba(255,255,255,0.2); }

    thead th, tbody td { padding: .55rem .65rem; }
    tbody tr:nth-child(odd) { background: #fbfdff; }
    tbody tr:hover { background: #f5f9ff; }

    /* Column widths (helps fit without horizontal scroll) */
    th.col-id,          td.col-id          { width: 70px; }
    th.col-facility,    td.col-facility    { width: 70px; }
    th.col-area,        td.col-area        { width: 120px; }   /* kept for consistency even if hidden in this view */
    th.col-cluster,     td.col-cluster     { width: 140px; }
    th.col-mpoo,        td.col-mpoo        { width: 70px; }
    th.col-facname,     td.col-facname     { width: 140px; }
    th.col-hours,       td.col-hours       { width: 80px; }
    th.col-craft,       td.col-craft       { width: 100px; }
    th.col-ldc,         td.col-ldc         { width: 100px; }
    th.col-opnum,       td.col-opnum       { width: 100px; }
    th.col-just,        td.col-just        { width: 260px; }
    th.col-start,       td.col-start       { width: 100px; }
    th.col-end,         td.col-end         { width: 100px; }
    th.col-userid,      td.col-userid      { width: 100px; }
    /* th.col-username,    td.col-username    { width: 170px; } */
    th.col-on,          td.col-on          { width: 140px; }
    th.col-status,      td.col-status      { width: 130px; }
    th.col-comment,     td.col-comment     { width: 200px; }
    th.col-chby,        td.col-chby        { width: 100px; }
    th.col-chdt,        td.col-chdt        { width: 140px; }
    th.col-actions,     td.col-actions     { width: 150px; }

    .cell-ellipsis { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Status chips */
    .chip { display:inline-block; padding: .2rem .5rem; border-radius: 999px; font-size: .75rem; font-weight: 600; }
    .chip-pending { background:#dbeafe; color:#1e3a8a; }
    .chip-approved{ background:#dcfce7; color:#14532d; }
    .chip-declined{ background:#fee2e2; color:#7f1d1d; }
    .chip-modify  { background:#fef3c7; color:#92400e; }
    .chip-default { background:#f3f4f6; color:#111827; }

    /* Excel-style filter popover */
    .filter-pop {
      position: absolute; z-index: 60;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
      width: 260px; padding: 12px;
      animation: pop .12s ease;
    }
    .filter-pop h4 { font-size: 12px; font-weight: 700; margin: 2px 0 8px; color: #374151; letter-spacing:.02em; }
    .filter-pop .row { display:flex; gap:8px; margin-top:10px; }
    @keyframes pop { from { transform: translateY(-3px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    /* Compact & shrink toggles */
    .compact table { font-size: 12px; }
    .shrink { transform: scale(0.93); transform-origin: top left; width: 107.5%; }

    /* Glassy overlay for modal backdrop */
    .glass-overlay {
      background: rgba(0, 0, 0, 0.28);
      backdrop-filter: blur(4px) saturate(120%);
      -webkit-backdrop-filter: blur(4px) saturate(120%);
    }

    /* Themed modal shell that blends with dashboard */
    .modal-card {
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      border: 1px solid #e5e7eb;
    }
    .modal-head {
      background: linear-gradient(135deg, #3B6E8F 0%, #2f5b73 100%);
      color: #fff;
    }
    .modal-head h3 { letter-spacing: .2px; }

    /* Subtle divider tone to match theme */
    .modal-divider {
      border-top: 1px solid rgba(59,110,143,.15);
    }

    /* Approve/Decline bar sticks and blends */
    .modal-actions {
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(2px);
    }

    /* Toast (small success popover) */
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1000;
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      color: #0f172a;
      display: none;
    }
    .toast.show { display: inline-flex; align-items: center; gap: 8px; }
    .toast-success { background: #dcfce7; border: 1px solid #16a34a33; }
    .toast-error   { background: #fee2e2; border: 1px solid #ef444433; }
    .toast-info    { background: #e0f2fe; border: 1px solid #38bdf833; }

    /* Horizontal scroll helpers */
    .hscroll-btn{
      position:absolute; top:50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 9999px;
      background: rgba(255,255,255,0.98);
      border: 1px solid #e5e7eb;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      z-index: 9999;
      cursor: pointer;
    }
    .hscroll-btn.left{ left: 8px; }
    .hscroll-btn.right{ right: 8px; }
    .hscroll-btn:hover{ background:#fff; }
    .hscroll-btn.is-disabled{ opacity:.28; pointer-events:none; }

    .hscroll-fade{
      position:absolute; top:0; bottom:0; width: 36px;
      pointer-events:none; z-index: 9998;
    }
    .hscroll-fade.left{
      left:0;
      background: linear-gradient(to right, rgba(255,255,255,1), rgba(255,255,255,0));
    }
    .hscroll-fade.right{
      right:0;
      background: linear-gradient(to left, rgba(255,255,255,1), rgba(255,255,255,0));
    }

    /* >>> NEW: keep the View/Validate column sticky */
    th.sticky-actions, td.sticky-actions {
      position: sticky;
      right: 0;
      z-index: 3;
      background: #fff;
      box-shadow: -3px 0 6px rgba(0,0,0,.06);
    }
    thead th.sticky-actions {
      z-index: 4;
      background: #3B6E8F;
      color: #fff;
    }

    [v-cloak] {
      display: none;
    }
  </style>
</head>

<body>
  <div id="dashboardApp" class="w-full p-6"  v-cloak>
    <!-- Top Nav -->
    <header>
      <div class="w-full px-14 py-0 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <a href="https://eagnmnwbc1db.usps.gov/" class="flex items-center space-x-2 hover:opacity-80 transition">
            <img src="https://eagnmnwbp161f.usps.gov/rework/assets/EIR_logo_color.png" alt="EIR Logo"
              class="h-16 w-16 object-contain" />
            <span class="text-2xl font-semibold text-gray-700">| Workhour Analytics</span>
          </a>
        </div>
        <div class="flex items-center justify-between space-x-6">
          <a href="/ref/toolbox/flex/index.html"
            class="px-4 py-2 bg-[#3B6E8F] text-white rounded-lg font-semibold shadow hover:bg-blue-500 transition">
            + New Flex Request
          </a>
          <div class="flex items-center space-x-4 text-lg text-gray-700 font-medium">
            {{ userDisplayHeader }}
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 w-full">
      <div class="w-full px-6">

        <!-- Breadcrumb -->
        <nav class="text-gray-600 text-md font-semibold rounded-2xl card p-6 mb-6 -mt-12" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
            <li>
              <a href="https://eagnmnwbp161f.usps.gov/" class="flex items-center hover:text-blue-700 transition">
                <svg class="w-4 h-4 mr-1 text-gray-700" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 12l9-9 9 9M9 21V10h6v11" />
                </svg>
                WEMS Home
              </a>
            </li>
            <li>
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 5l7 7-7 7" />
              </svg>
            </li>
            <li class="text-blue-800 font-semibold">Flex Time Admin Dashboard</li>
          </ol>
        </nav>

        <!-- Info Banner with Facility Popover -->
        <div class="usps-blue text-white rounded-xl shadow-md p-8 mb-6 relative" ref="bannerWrap">
          <h1 class="text-3xl font-bold tracking-tight">Flex Time Request</h1>

          <p class="mt-2 text-base flex flex-wrap items-center gap-2">
            <span class="font-semibold">Office/Facility:</span>
            <span class="font-semibold">{{ officeName || '—' }}</span>

            <!-- Show picker when more than 1 facility -->
            <button v-if="facilities.length > 1" type="button"
              class="ml-2 inline-flex items-center px-2 py-1 text-xs font-semibold rounded bg-white/15 hover:bg-white/25"
              @click.stop="openBannerMenu($event)" title="View all facilities">
              View all ({{ facilities.length }})
            </button>

            <span class="hidden sm:inline">&nbsp;&nbsp;•&nbsp;&nbsp;</span>
            <span class="font-semibold">Fiscal Year:</span> <span class="font-semibold">{{ fiscalYear || '—' }}</span>

            <span class="hidden sm:inline">&nbsp;&nbsp;•&nbsp;&nbsp;</span>
            <span class="font-semibold">Week:</span> <span class="font-semibold">{{ week || '—' }}</span>
          </p>

          <!-- Facilities popover -->
          <div v-if="bannerMenu.open" ref="bannerMenuRef"
            class="absolute z-[100] bg-white text-gray-800 rounded-lg shadow-2xl border border-gray-200 w-80 p-3"
            :style="{ top: bannerMenu.y + 'px', left: bannerMenu.x + 'px' }">
            <div class="text-sm font-semibold text-gray-600 mb-2">Your Facilities</div>
            <ul class="max-h-64 overflow-auto divide-y divide-gray-100">
              <li v-for="f in facilities" :key="f.B_FIN_NBR" class="py-2">
                <button class="w-full text-left hover:bg-gray-50 rounded px-2 py-1" @click="gotoFacility(f)"
                  :title="(f.B_FIN_NAME || '') + ' (' + (f.B_FIN_NBR || '') + ')'">
                  <div class="text-sm font-medium">{{ f.B_FIN_NAME }}</div>
                  <div class="text-xs text-gray-500">FIN: {{ f.B_FIN_NBR }}</div>
                </button>
              </li>
            </ul>
            <div class="mt-2 text-right">
              <button class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200"
                @click="bannerMenu.open=false">Close</button>
            </div>
          </div>
        </div>

        <!-- Summary KPIs -->
        <section class="card p-6 mb-6">
          <h2 class="text-lg font-semibold text-gray-700 mb-4">Summary</h2>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Total Requests</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.TOTAL) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Pending</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.PENDING) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Approved</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.APPROVED) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Request Modification</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.MODIFICATION) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Declined</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.DECLINED) }}</div>
            </div>
          </div>
        </section>

        <!-- Status Chart -->
        <div class="card p-6 mb-8">
          <h2 class="text-xl font-semibold text-blue-800 mb-2">Request Status Chart</h2>
          <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
        </div>

           <!-- Requests Table -->
        <div class="card p-4 mb-8" :class="[{ compact: compactView }, { shrink: shrinkToFit }]">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center justify-between gap-3">
            <h2 class="text-xl font-semibold text-blue-800">Flex-Time Requests</h2>
              <label class="text-sm flex item-center self-end">
                  <b>YEAR:</b>&nbsp;
                  <select v-model.number="flexTimeSelectedYear" class="border rounded text-sm" @change="handleFlexYearChange">
                    <option v-for="opt in flexTimeYears" :key="opt" :value="opt">{{ opt }}</option>
                  </select>
                </label>
              </div>
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" v-model="compactView"/>
                <span>Compact view</span>
              </label>
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" v-model="shrinkToFit"/>
                <span>Shrink to fit</span>
              </label>
              <button @click="exportTableToCSV"
                      class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
                📥 Export to CSV
              </button>
            </div>
          </div>

          <div class="tbl-wrap relative" ref="tblWrap">
            <table>
              <thead>
                <tr style="background:#3B6E8F; color:#fff;">
                  <th class="col-id">
                    <div class="th-inner">
                      <span class="font-semibold">ID</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('REQUESTID', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-facility">
                    <div class="th-inner">
                      <span class="font-semibold">Facility</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('FACILITYID', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-facname">
                    <div class="th-inner">
                      <span class="font-semibold">Facility Name</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('FACILITYNAME', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-hours">
                    <div class="th-inner">
                      <span class="font-semibold">Hours</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('HOURSPERWEEK', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-craft">
                    <div class="th-inner">
                      <span class="font-semibold">Craft</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('CRAFT', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-ldc">
                    <div class="th-inner">
                      <span class="font-semibold">Labor Distribution Code</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('LABOURDISTRIBUTIONCODE', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-opnum">
                    <div class="th-inner">
                      <span class="font-semibold">Operation Number</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('OPERATIONNUMBER', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-start">
                    <div class="th-inner">
                      <span class="font-semibold">Start</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('STARTDATE', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-end">
                    <div class="th-inner">
                      <span class="font-semibold">End</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('ENDDATE', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-userid">
                    <div class="th-inner">
                      <span class="font-semibold">USER ID</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('CREATEDBY', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <!-- <th class="col-username">
                    <div class="th-inner">
                      <span class="font-semibold">User Name</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('USER_NAME', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th> -->

                  <th class="col-on">
                    <div class="th-inner">
                      <span class="font-semibold">On</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('CREATEDON', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-status">
                    <div class="th-inner">
                      <span class="font-semibold">Status</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('STATUS', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <!-- Sticky View/Validate column -->
                  <th class="col-actions sticky-actions"><span class="font-semibold">View Record</span></th>
                </tr>
              </thead>

              <tbody>
                <!-- switched to paginatedRequests -->
                <tr v-for="req in paginatedRequests" :key="req.REQUESTID" class="border-t">
                  <td class="col-id">{{ req.REQUESTID }}</td>
                  <td class="col-facility">{{ req.FACILITYID }}</td>
                  <td class="col-facname cell-ellipsis" :title="req.FACILITYNAME">{{ req.FACILITYNAME }}</td>

                  <!-- removed: Area / Cluster / MPOO / Justification / Comment -->

                  <td class="col-hours">{{ req.HOURSPERWEEK }}</td>
                  <td class="col-craft">{{ req.CRAFT }}</td>
                  <td class="col-ldc">{{ req.LABOURDISTRIBUTIONCODE }}</td>
                  <td class="col-opnum">{{ req.OPERATIONNUMBER }}</td>
                  <td class="col-start">{{ req.STARTDATE }}</td>
                  <td class="col-end">{{ req.ENDDATE }}</td>
                  <td class="col-userid">{{ req.CREATEDBY }}</td>
                  <!-- <td class="col-username">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td> -->
                  <td class="col-on">{{ req.CREATEDON }}</td>
                  <td class="col-status">
                    <span :class="statusClass(req.STATUS)">{{ req.STATUS }}</span>
                  </td>

                  <!-- Sticky action button -->
                  <td class="col-actions sticky-actions">
                    <button
                      @click.prevent="selectRequest(req)"
                      class="px-3 py-1.5 bg-[#17a2b8] text-white text-sm rounded-md shadow hover:bg-blue-500 transition">
                      View / Validate
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination footer -->
            <div class="mt-3 flex flex-wrap items-center justify-between gap-3">
              <!-- Range text -->
              <div class="text-sm text-gray-600">
                Showing <span class="font-semibold">{{ totalRows ? (firstRowIndex + 1) : 0 }}</span>
                –
                <span class="font-semibold">{{ lastRowIndex }}</span>
                of
                <span class="font-semibold">{{ totalRows }}</span>
              </div>

              <!-- Controls -->
              <div class="flex items-center gap-2">
                <label class="text-sm flex items-center gap-1">
                  Rows:
                  <select v-model.number="pageSize" class="border rounded px-2 py-1 text-sm">
                    <option :value="10">10</option>
                    <option :value="25">25</option>
                    <option :value="50">50</option>
                    <option :value="100">100</option>
                  </select>
                </label>

                <button
                  class="px-3 py-1.5 rounded border text-sm disabled:opacity-50"
                  :disabled="currentPage <= 1"
                  @click="prevPage"
                  aria-label="Previous page">
                  ‹ Prev
                </button>

                <div class="text-sm">
                  Page <span class="font-semibold">{{ currentPage }}</span>
                  of <span class="font-semibold">{{ totalPages }}</span>
                </div>

                <button
                  class="px-3 py-1.5 rounded border text-sm disabled:opacity-50"
                  :disabled="currentPage >= totalPages"
                  @click="nextPage"
                  aria-label="Next page">
                  Next ›
                </button>
              </div>
            </div>

            <!-- Excel-style filter popover -->
            <div v-if="filterMenu.open"
                 class="filter-pop"
                 :style="{ left: filterMenu.x + 'px', top: filterMenu.y + 'px' }"
                 ref="filterMenuRef">
              <h4>Filter: {{ filterMenu.field }}</h4>

              <!-- STATUS uses dropdown -->
              <template v-if="filterMenu.field === 'STATUS'">
                <select
                  class="w-full border rounded px-2 py-1 text-sm"
                  :value="filters.STATUS"
                  @change="onStatusChange($event)">
                  <option value="">(All)</option>
                  <option v-for="opt in statusOptions" :key="opt" :value="opt">{{ opt }}</option>
                </select>
              </template>

              <!-- All other columns: contains text -->
              <template v-else>
                <input
                  v-model="filters[filterMenu.field]"
                  class="w-full border rounded px-2 py-1 text-sm"
                  placeholder="Type to filter…">
              </template>

              <div class="row">
                <button class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200"
                        @click.stop="clearFilter(filterMenu.field)">
                  Clear
                </button>
                <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                        @click.stop="filterMenu.open=false">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal (existing functionality preserved) -->
        <transition name="modal">
          <div v-if="showingModal" class="fixed inset-0 glass-overlay flex items-center justify-center z-50">
            <div class="relative modal-card w-full max-w-7xl min-h-[75vh] max-h-[95vh] p-0 transform transition-transform duration-300 scale-100 flex flex-col overflow-hidden">

              <button @click="closeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>

              <div class="modal-head px-12 pt-10 pb-5">
                <h3 class="text-2xl font-semibold">Request #{{ selectedRequest?.REQUESTID }}</h3>
              </div>
              <div class="modal-divider"></div>

              <div class="flex-1 overflow-y-auto px-12 pb-6">
                <div class="mb-4">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" v-model="isEditing" class="rounded">
                    <span>Enable editing of request fields</span>
                  </label>
                </div>

                <!-- Read View -->
                <div v-if="!isEditing" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Facility:</strong> {{ selectedRequest?.FACILITYID }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Facility Name:</strong> {{ selectedRequest?.FACILITYNAME }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Craft:</strong> {{ selectedRequest?.CRAFT }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Hours / Week:</strong> {{ selectedRequest?.HOURSPERWEEK }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>LDC:</strong> {{ selectedRequest?.LABOURDISTRIBUTIONCODE }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Operation #:</strong> {{ selectedRequest?.OPERATIONNUMBER }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm md:col-span-3">
                    <p><strong>Dates:</strong> {{ selectedRequest?.STARTDATE }} → {{ selectedRequest?.ENDDATE }}</p>
                  </div>
                  <div class="md:col-span-3 border rounded-md p-4 bg-white shadow-sm">
                    <p><strong>Justification:</strong></p>
                    <p class="whitespace-pre-line">{{ selectedRequest?.JUSTIFICATION }}</p>
                  </div>
                  <div class="md:col-span-3" v-if="selectedRequest?.ATTACHMENTURL">
                    <p><strong>Attachment:</strong></p>
                    <a :href="selectedRequest.ATTACHMENTURL" target="_blank" class="text-blue-600 underline"
                       :download="selectedRequest.ATTACHMENTNAME || null">
                      Download {{ selectedRequest.ATTACHMENTNAME || 'attachment' }}
                    </a>
                  </div>
                </div>

                <!-- Edit View -->
                <div v-else class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div><label class="font-semibold">Facility</label><input v-model="editForm.facilityID" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">Craft</label>
                    <select v-model="editForm.craft" class="w-full border rounded p-2">
                      <option>clerk</option>
                      <option>mailhandler</option>
                    </select>
                  </div>
                  <div><label class="font-semibold">Hours / Week</label><input type="number" step="0.01" v-model.number="editForm.hoursPerWeek" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">LDC</label><input v-model.number="editForm.ldc" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">Operation #</label><input v-model="editForm.operationNumber" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">Start Date</label><input type="date" v-model="editForm.startDate" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">End Date</label><input type="date" v-model="editForm.endDate" class="w-full border rounded p-2"/></div>
                  <div class="md:col-span-3">
                    <label class="font-semibold">Justification</label>
                    <textarea v-model="editForm.justification" rows="4" class="w-full border rounded p-2"></textarea>
                  </div>
                  <div class="md:col-span-3" v-if="selectedRequest?.ATTACHMENTURL">
                    <strong>Attachment:</strong>
                    <a :href="selectedRequest.ATTACHMENTURL" target="_blank" class="text-blue-600 underline">Download</a>
                  </div>
                </div>

                <!-- Quick Comment -->
                <div class="mb-4">
                  <label class="block font-semibold mb-1">Quick Comment</label>
                  <select class="w-full border rounded p-2" v-model="selectedComment" @change="onQuickCommentChange">
                    <option value="" disabled>— Select a quick comment —</option>
                    <option value="NO SUPPORTING DOCUMENTATION">NO SUPPORTING DOCUMENTATION</option>
                    <option value="MULTIPLE REQUESTS">MULTIPLE REQUESTS</option>
                    <option value="SPACE CONSTRAINTS">SPACE CONSTRAINTS</option>
                    <option value="NOT UNIQUE">NOT UNIQUE</option>
                    <option value="ALREADY COVERED">ALREADY COVERED</option>
                    <option value="SCF/HUB">SCF/HUB</option>
                    <option value="DROP SHIPMENT ISSUES">DROP SHIPMENT ISSUES</option>
                    <option value="LEVEL 18">LEVEL 18</option>
                    <option value="SCHEDULING/ COMPLEMENT ISSUES">SCHEDULING/ COMPLEMENT ISSUES</option>
                    <option value="OTHER">Other (type your own)</option>
                  </select>
                </div>

                <div v-show="selectedComment" class="mb-4">
                  <label class="block font-semibold">Comment</label>
                  <textarea v-model="actionComment" rows="4" ref="otherCommentBox" class="w-full border rounded p-2" placeholder="Type your custom note…"></textarea>
                </div>

                <div v-if="processStatus" class="text-green-600 mt-2">{{ processStatus }}</div>
              </div>

              <div class="sticky bottom-0 bg-white border-t px-12 py-4 flex flex-wrap gap-2 justify-start">
                <button @click="updateStatus('Approved')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Approve</button>
                <button @click="updateStatus('Declined')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Decline</button>
                <button @click="updateStatus('Modify')" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Request Modification</button>
                <button v-if="isEditing" @click="saveFieldEdits" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Changes</button>
              </div>
            </div>
          </div>
        </transition>
      </div>
    </main>
  </div>

  <!-- Lightweight toast -->
  <div id="ft-toast" class="toast toast-success">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
    <span id="ft-toast-text">Saved.</span>
  </div>

  <!-- Page script -->
  <script type="module" src="/ref/toolbox/flex/admin.js"></script>
</body>

</html>




============================================================================================

// /rework/flex_time/admin.js
// NOTE: All behavior preserved; only formatting, comments, and minor structural fixes.
import { createApp } from 'https://unpkg.com/vue@3.5.13/dist/vue.esm-browser.js';

createApp({
  // ---------------------------------------------------------------------------
  // Reactive State
  // ---------------------------------------------------------------------------
  data() {
    return {
      serviceFolder: '/ref/api/v1/toolbox/flex/',

      // Header / banner
      userDisplayHeader: '',
      officeName: '',
      fiscalYear: '',
      week: '',
      facilities: [],                        // facilities user can access
      bannerMenu: { open: false, x: 0, y: 0 },
      userAceid: '',
      isAllowed: false,
      denyReason: '',

      // Metrics + chart
      metrics: { TOTAL: 0, PENDING: 0, APPROVED: 0, MODIFICATION: 0, DECLINED: 0 },
      statusChart: null,

      // Requests and column filters
      flexRequests: [],
      statusOptions: [],
      filters: {
        REQUESTID: '',
        FACILITYID: '',
        AREA: '',
        CLUSTER: '',
        MPOO: '',
        HOURSPERWEEK: '',
        CRAFT: '',
        LABOURDISTRIBUTIONCODE: '',
        OPERATIONNUMBER: '',
        JUSTIFICATION: '',
        STARTDATE: '',
        ENDDATE: '',
        CREATEDBY: '',
        // USER_NAME: '',
        CREATEDON: '',
        STATUS: '',
        COMMENT: '',
        CHANGEDBY: '',
        CHANGEDDATE: ''
      },

      // >>> Pagination defaults (enabled)
      pageSize: 10,
      currentPage: 1,

      // UI toggles
      compactView: true,
      shrinkToFit: false,

      // Modal + inline edits
      showingModal: false,
      selectedRequest: null,
      isEditing: false,
      editForm: {
        requestID: null,
        facilityID: '',
        craft: '',
        ldc: null,
        operationNumber: '',
        hoursPerWeek: null,
        justification: '',
        startDate: '',
        endDate: '',
        status: ''
      },
      selectedComment: '',
      actionComment: '',
      processStatus: '',
      customCommentDraft: '',

      // Filter popover
      filterMenu: { open: false, field: '', x: 0, y: 0 },

      // Year selector
      flexTimeYears: Array.from({length: new Date().getFullYear() - 2024 + 1}, (_, i) => new Date().getFullYear()-i),
      flexTimeSelectedYear: new Date().getFullYear()
    };
  },

  // ---------------------------------------------------------------------------
  // Computed
  // ---------------------------------------------------------------------------
  computed: {
    /**
     * Filtered list based on column filters.
     * NOTE: the table currently renders paginatedRequests (below).
     */
    filteredRequests() {
      const rows = Array.isArray(this.flexRequests) ? this.flexRequests : [];
      const f = this.filters;

      const match = (val, filter) =>
        !filter || String(val ?? '').toLowerCase().includes(String(filter).toLowerCase());

      return rows.filter((r) => {
        if (!r || typeof r !== 'object') return false;
        // const userName = `${r.USER_FNAME || ''} ${r.USER_LNAME || ''}`.trim();

        return (
          match(r.REQUESTID,               f.REQUESTID) &&
          match(r.FACILITYID,              f.FACILITYID) &&
          match(r.HOURSPERWEEK,            f.HOURSPERWEEK) &&
          match(r.AREA,                    f.AREA) &&
          match(r.CLUSTER,                 f.CLUSTER) &&
          match(r.MPOO,                    f.MPOO) &&
          match(r.CRAFT,                   f.CRAFT) &&
          match(r.LABOURDISTRIBUTIONCODE,  f.LABOURDISTRIBUTIONCODE) &&
          match(r.OPERATIONNUMBER,         f.OPERATIONNUMBER) &&
          match(r.JUSTIFICATION,           f.JUSTIFICATION) &&
          match(r.STARTDATE,               f.STARTDATE) &&
          match(r.ENDDATE,                 f.ENDDATE) &&
          match(r.CREATEDBY,               f.CREATEDBY) &&
          // match(userName,                  f.USER_NAME) &&
          match(r.CREATEDON,               f.CREATEDON) &&
          (!f.STATUS || String(r.STATUS || '').toLowerCase() === f.STATUS.toLowerCase()) &&
          match(r.COMMENT,                 f.COMMENT) &&
          match(r.CHANGEDBY,               f.CHANGEDBY) &&
          match(r.CHANGEDDATE,             f.CHANGEDDATE)
        );
      });
    },

    // Pagination helpers
    totalRows() {
      return Array.isArray(this.filteredRequests) ? this.filteredRequests.length : 0;
    },
    totalPages() {
      return Math.max(1, Math.ceil(this.totalRows / this.pageSize));
    },
    firstRowIndex() {
      return (this.currentPage - 1) * this.pageSize;
    },
    lastRowIndex() {
      return Math.min(this.firstRowIndex + this.pageSize, this.totalRows);
    },
    paginatedRequests() {
      return this.filteredRequests.slice(this.firstRowIndex, this.lastRowIndex);
    }
  },

  // ---------------------------------------------------------------------------
  // Methods
  // ---------------------------------------------------------------------------
  methods: {
    /** Auth + gate admin access (hard-coded allow-list). */
    async authenticate() {
      try {
        const res = await axios.get('/ref/api/v1/authenticate.cfc?method=getUserAuth');
        if (res.data) {
          const aceid = (res.data.aceid || '').toUpperCase();
          const allowedAdmins = ['DG4QJ0', 'TR28H0', 'BR5TBB', 'KWC2RJ'];

          if (!allowedAdmins.includes(aceid)) {
            alert('You are not authorized to access this page.');
            window.location.href = `/ref/toolbox/flex/dashboard.html`;
            return;
          }

          this.userDisplayHeader = `${res.data.first} ${res.data.last} (${aceid})`;
          this.userAceid = aceid;

          if (this.userAceid) await this.fetchFacilities();
        }
      } catch (e) {
        console.error('Auth error', e);
        alert('Error during authentication. Access denied.');
      }
    },

    /** Load facilities user can access. */
    async fetchFacilities() {
      try {
        const res = await axios.get(
          `${this.serviceFolder}admin.cfc?method=getMyFacilities&userid=${encodeURIComponent(this.userAceid)}`
        );
        this.facilities = Array.isArray(res.data) ? res.data : [];

        // If header missing name and exactly 1 facility, use it in banner
        if ((!this.officeName || !this.officeName.trim()) && this.facilities.length === 1) {
          const f = this.facilities[0];
          this.officeName = f.B_FIN_NAME || this.officeName;
        }
      } catch (e) {
        console.error('fetchFacilities error', e);
        this.facilities = [];
      }
    },

    /** Small toast helper. */
    showToast(message = 'Saved.', type = 'success') {
      const el = document.getElementById('ft-toast');
      const txt = document.getElementById('ft-toast-text');
      if (!el || !txt) return;
      el.classList.remove('toast-success','toast-error','toast-info');
      el.classList.add(type === 'error' ? 'toast-error' : type === 'info' ? 'toast-info' : 'toast-success');
      txt.textContent = message;
      el.classList.add('show');
      clearTimeout(this.__toastTimer);
      this.__toastTimer = setTimeout(() => { el.classList.remove('show'); }, 2600);
    },

    /** Close modal, then refresh table + metrics. */
    closeModalAndRefresh() {
      this.closeModal();
      this.fetchFlexRequests();
      this.fetchDashboard();
    },

    /** Header values (office, FY, week). Falls back to client-side compute. */
    async fetchHeaderData() {
      try {
        const res = await axios.get(`${this.serviceFolder}admin.cfc?method=getHeaderData&userid=${encodeURIComponent(this.userAceid)}`);
        this.officeName = res.data.officeName || this.officeName || '';
        this.fiscalYear = res.data.fiscalYear || '';
        this.week       = res.data.week || '';

        if (!this.fiscalYear || !this.week) {
          const x = this.computeClientFYWeek();
          if (!this.fiscalYear) this.fiscalYear = x.fy;
          if (!this.week)       this.week       = x.week;
        }
      } catch (e) {
        console.error('Header load error', e);
        const x = this.computeClientFYWeek();
        if (!this.fiscalYear) this.fiscalYear = x.fy;
        if (!this.week)       this.week       = x.week;
      }
    },

    /** Open banner facility popover (positioned relative to banner). */
    openBannerMenu(evt) {
      const wrap = this.$refs.bannerWrap;
      if (!wrap) return;
      const b = evt.currentTarget.getBoundingClientRect();
      const w = wrap.getBoundingClientRect();
      this.bannerMenu.x = (b.left - w.left);
      this.bannerMenu.y = (b.bottom - w.top) + 6;
      this.bannerMenu.open = true;
      evt.stopPropagation();
    },

    /** Choose a facility from banner menu. */
    gotoFacility(f) {
      if (!f) return;
      this.officeName = f.B_FIN_NAME || this.officeName;
      if (this.filters && Object.prototype.hasOwnProperty.call(this.filters, 'FACILITYID')) {
        this.filters.FACILITYID = String(f.B_FIN_NBR || '');
      }
      this.bannerMenu.open = false;
    },

    /** Close banner popover on outside click. */
    _onDocClickBanner(e) {
      if (!this.bannerMenu.open) return;
      const pop = this.$refs.bannerMenuRef;
      if (pop && pop.contains(e.target)) return;
      if (e.target && e.target.closest && e.target.closest('[title="View all facilities"]')) return;
      this.bannerMenu.open = false;
    },

    /** Client-side FY/week computation (Saturday fiscal week alignment). */
    computeClientFYWeek() {
      const today = new Date();
      const y = today.getFullYear();

      const sept30 = new Date(y, 8, 30);     // Sep 30
      const dow = sept30.getDay();           // 0..6
      const backDays = (dow === 6 ? 0 : (dow + 1));
      const lastSat = new Date(sept30); lastSat.setDate(sept30.getDate() - backDays);

      let fyStart = lastSat;
      if (today < lastSat) {
        const prevSept30 = new Date(y - 1, 8, 30);
        const prevDow = prevSept30.getDay();
        const prevBack = (prevDow === 6 ? 0 : (prevDow + 1));
        fyStart = new Date(prevSept30); fyStart.setDate(prevSept30.getDate() - prevBack);
      }

      const fy = fyStart.getFullYear() + 1;

      const startUTC = Date.UTC(fyStart.getFullYear(), fyStart.getMonth(), fyStart.getDate());
      const todayUTC = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
      const days = Math.floor((todayUTC - startUTC) / (1000 * 60 * 60 * 24));
      const week = 1 + Math.floor(days / 7);

      return { fy, week };
    },

    /** Load KPI metrics + render chart. */
    async fetchDashboard() {
      try {
        const res = await axios.get(`${this.serviceFolder}admin.cfc?method=getDashboardData`);
        if (res?.data) {
          const d = res.data;
          this.metrics = {
            TOTAL:        Number(d.TOTAL || d.total || 0),
            PENDING:      Number(d.PENDING || d.pending || 0),
            APPROVED:     Number(d.APPROVED || d.approved || 0),
            MODIFICATION: Number(d.MODIFICATION || d.modified || 0),
            DECLINED:     Number(d.DECLINED || d.declined || 0)
          };
          this.renderChart();
        }
      } catch (e) {
        console.error('Dashboard load error', e);
      }
    },

    /** Load all flex requests + build status filter options. */
    async fetchFlexRequests() {
      try {
        const res = await axios.get(`${this.serviceFolder}admin.cfc?method=getFlexRequests&userid=${encodeURIComponent(this.userAceid)}&year=${this.flexTimeSelectedYear}`);
        const rows = Array.isArray(res.data) ? res.data : [];
        this.flexRequests = rows.filter(r => r && typeof r === 'object');

        this.statusOptions = Array.from(new Set(this.flexRequests.map(r => r.STATUS).filter(Boolean))).sort();
      } catch (e) {
        console.error('Error loading request', e);
        this.flexRequests = [];
        this.statusOptions = [];
        this.clampPage();
      }
    },

    /** Dismiss filter menu when scrolling/resizing. */
    onContainerScroll() { if (this.filterMenu.open) this.filterMenu.open = false; },
    onWinResize()       { if (this.filterMenu.open) this.filterMenu.open = false; },

    /** Render the status chart. */
    renderChart() {
      const el = document.getElementById('trendChart');
      if (!el) return;
      const ctx = el.getContext('2d');
      if (this.statusChart) { this.statusChart.destroy(); this.statusChart = null; }

      const { TOTAL, PENDING, APPROVED, MODIFICATION, DECLINED } = this.metrics;

      this.statusChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['TOTAL', 'PENDING', 'APPROVED', 'MODIFY', 'DECLINED'],
          datasets: [{
            label: 'Number of Requests',
            data: [TOTAL, PENDING, APPROVED, MODIFICATION, DECLINED],
            backgroundColor: [
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 99, 132, 0.8)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1,
            borderRadius: 8,
            barPercentage: 0.6,
            categoryPercentage: 0.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Request Trend', font: { size: 18, weight: '500' } },
            legend: { display: false }
          },
          scales: {
            x: { grid: { display: false }, ticks: { font: { size: 13 } } },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)', borderDash: [3, 3] },
              ticks: { stepSize: 10, font: { size: 12 } }
            }
          }
        }
      });
    },

    /** Status → chip class. */
    statusClass(status) {
      switch ((status || '').toString()) {
        case 'Approved': return 'bg-green-100 text-green-800';
        case 'Pending':  return 'bg-blue-100 text-blue-800';
        case 'Declined': return 'bg-red-100 text-red-800';
        case 'Modify':   return 'bg-yellow-100 text-yellow-800';
        default:         return 'bg-gray-100 text-gray-800';
      }
    },

    /** Open modal and seed edit form. */
    selectRequest(req) {
      if (!req) return;
      this.selectedRequest = req;
      this.actionComment   = '';
      this.processStatus   = '';
      this.isEditing       = false;
      this.showingModal    = true;

      this.editForm = {
        requestID:       req.REQUESTID,
        facilityID:      req.FACILITYID,
        craft:           req.CRAFT,
        ldc:             Number(req.LABOURDISTRIBUTIONCODE),
        operationNumber: req.OPERATIONNUMBER,
        hoursPerWeek:    Number(req.HOURSPERWEEK),
        justification:   req.JUSTIFICATION,
        startDate:       req.STARTDATE,
        endDate:         req.ENDDATE,
        status:          req.STATUS
      };
    },

    /** Persist inline field edits for the selected request. */
    async saveFieldEdits() {
      try {
        const reqId = this.editForm.requestID;
        if (!reqId) { this.processStatus = 'Missing RequestID.'; return; }

        const toISO = (v) => (v ? new Date(v).toISOString().slice(0, 10) : '');

        const fd = new FormData();
        fd.append('requestId', reqId);
        if (this.editForm.facilityID)            fd.append('facility', this.editForm.facilityID);
        if (this.editForm.craft)                 fd.append('craft', this.editForm.craft);
        if (this.editForm.ldc != null)           fd.append('ldc', this.editForm.ldc);
        if (this.editForm.operationNumber)       fd.append('operationNumber', this.editForm.operationNumber);
        if (this.editForm.hoursPerWeek != null)  fd.append('hours', this.editForm.hoursPerWeek);
        if (this.editForm.justification)         fd.append('justification', this.editForm.justification);
        if (this.editForm.startDate)             fd.append('startDate', toISO(this.editForm.startDate));
        if (this.editForm.endDate)               fd.append('endDate', toISO(this.editForm.endDate));
        if (this.editForm.status)                fd.append('status', this.editForm.status);

        const res = await axios.post(
          `${this.serviceFolder}admin.cfc?method=updateRequestFields&returnformat=json&userid=${encodeURIComponent(this.userAceid)}`,
          fd,
          { validateStatus: () => true }
        );

        if (res.status === 200 && res.data && res.data.SUCCESS) {
          const idx = this.flexRequests.findIndex(r => r.REQUESTID === reqId);
          if (idx >= 0) {
            this.flexRequests[idx] = {
              ...this.flexRequests[idx],
              FACILITYID:             this.editForm.facilityID      ?? this.flexRequests[idx].FACILITYID,
              CRAFT:                  this.editForm.craft           ?? this.flexRequests[idx].CRAFT,
              LABOURDISTRIBUTIONCODE: this.editForm.ldc             ?? this.flexRequests[idx].LABOURDISTRIBUTIONCODE,
              OPERATIONNUMBER:        this.editForm.operationNumber ?? this.flexRequests[idx].OPERATIONNUMBER,
              HOURSPERWEEK:           this.editForm.hoursPerWeek    ?? this.flexRequests[idx].HOURSPERWEEK,
              JUSTIFICATION:          this.editForm.justification   ?? this.flexRequests[idx].JUSTIFICATION,
              STARTDATE:              this.editForm.startDate       || this.flexRequests[idx].STARTDATE,
              ENDDATE:                this.editForm.endDate         || this.flexRequests[idx].ENDDATE,
              STATUS:                 this.editForm.status          || this.flexRequests[idx].STATUS
            };
          }
          this.processStatus = 'Changes saved.';
          this.selectedRequest =  this.flexRequests[idx];
          this.isEditing = false;
        } else {
          console.error('Server error body:', res.data);
          this.processStatus = (res.data && res.data.MESSAGE)
            ? res.data.MESSAGE
            : `Save failed (HTTP ${res.status})`;
        }
      } catch (err) {
        console.error('saveFieldEdits error', err);
        this.processStatus = 'Error saving changes';
      }
    },

    /** Update request status with optional comment + toast feedback. */
    async updateStatus(newStatus) {
      if (!this.selectedRequest) return;

      try {
        const res = await axios.post(
          `${this.serviceFolder}admin.cfc?method=updateRequest&userid=${encodeURIComponent(this.userAceid)}`,
          {
            requestID: this.selectedRequest.REQUESTID,
            status: newStatus,
            comment: this.actionComment
          }
        );

        const ok = res && res.status === 200 &&
                   (res.data?.SUCCESS === true ||
                    String(res.data?.MESSAGE || '').toLowerCase().includes('status updated'));

        if (ok) {
          let msg = 'Updated';
          let type = 'success';
          if (newStatus === 'Approved')      { msg = 'Request Approved';           type = 'success'; }
          else if (newStatus === 'Declined') { msg = 'Request Declined';           type = 'error'; }
          else if (newStatus === 'Modify')   { msg = 'Modification Requested';     type = 'info'; }

          this.showToast(msg, type);
          this.closeModalAndRefresh();
        } else {
          console.error('Server response:', res?.data);
          this.showToast('Update failed', 'error');
          this.processStatus = 'Error updating request';
        }
      } catch (err) {
        console.error(err);
        this.showToast('Network error', 'error');
        this.processStatus = 'Error updating request';
      }
    },

    /** Close modal without refresh. */
    closeModal() {
      this.showingModal = false;
      this.selectedRequest = null;
      this.processStatus = '';
    },

    /** Handle quick comment selection. */
    onQuickCommentChange() {
      if (this.selectedComment === 'OTHER') {
        this.actionComment = this.customCommentDraft || '';
        this.$nextTick(() => { this.$refs.otherCommentBox?.focus(); });
      } else if (this.selectedComment) {
        if (this.customCommentDraft !== this.actionComment && this.actionComment?.length) {
          this.customCommentDraft = this.actionComment;
        }
        this.actionComment = this.selectedComment;
      } else {
        this.actionComment = '';
      }
    },

    /** Simple number formatter. */
    fmt(n) {
      const v = Number(n || 0);
      return new Intl.NumberFormat('en-US').format(v);
    },

    // ------------------- Excel-style filter popover -------------------
    openFilterMenu(field, evt) {
      const btn = evt.currentTarget;
      const container = this.$refs.tblWrap;
      if (!btn || !container) return;

      const b = btn.getBoundingClientRect();
      const c = container.getBoundingClientRect();

      // If "shrink to fit" applies transform: scale(), adjust coordinates.
      const scaleX = (c.width  / container.clientWidth)  || 1;
      const scaleY = (c.height / container.clientHeight) || 1;

      // Position inside container coords
      const leftInContainer = (b.left   - c.left) / scaleX + container.scrollLeft;
      const topInContainer  = (b.bottom - c.top)  / scaleY + container.scrollTop + 6;

      // Clamp horizontally (menu width 260px)
      const menuWidth = 260;
      const maxX = container.scrollLeft + container.clientWidth - menuWidth - 8;
      let x = leftInContainer;
      if (x > maxX) x = Math.max(container.scrollLeft, maxX);

      this.filterMenu.field = field;
      this.filterMenu.x = x;
      this.filterMenu.y = topInContainer;
      this.filterMenu.open = true;

      evt.stopPropagation();
    },

    onDocClick(e) {
      const pop = this.$refs.filterMenuRef;
      if (!pop) { this.filterMenu.open = false; return; }
      if (!pop.contains(e.target)) { this.filterMenu.open = false; }
    },

    onStatusChange(e) {
      const val = (e && e.target) ? e.target.value : '';
      this.filters.STATUS = String(val || '');
      this.filterMenu.open = false;
    },

    clearFilter(field) {
      this.filters[field] = '';
      this.filterMenu.open = false;
    },

    /** Export current filtered table to CSV (unchanged, full columns). */
    exportTableToCSV() {
      const headers = [
        'ID','Facility','FacilityName','Area','Cluster','Mpoo','Hours','Craft','LDC','Operation',
        'Justification','Start','End','By','On','Status','Comment','ChangedBy','ChangedDate','UserFName','UserLName'
      ];

      const rows = (Array.isArray(this.filteredRequests) ? this.filteredRequests : []).map(req => [
        req.REQUESTID,
        req.FACILITYID,
        req.FACILITYNAME,
        req.AREA,
        req.CLUSTER,
        req.MPOO,
        req.HOURSPERWEEK,
        req.CRAFT,
        req.LABOURDISTRIBUTIONCODE,
        req.OPERATIONNUMBER,
        req.JUSTIFICATION,
        req.STARTDATE,
        req.ENDDATE,
        req.CREATEDBY,
        req.CREATEDON,
        req.STATUS,
        req.COMMENT,
        req.CHANGEDBY,
        req.CHANGEDDATE,
        req.USER_FNAME,
        req.USER_LNAME
      ]);

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => {
          const text = String(cell ?? '').replace(/"/g, '""');
          return `"${text}"`;
        }).join(','))
      ].join('\r\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.setAttribute('download', 'flex-time-requests.csv');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    },

    // ------------------- Pagination helpers -------------------
    setPage(n) {
      const page = Number(n) || 1;
      this.currentPage = Math.min(Math.max(1, page), this.totalPages);
    },
    nextPage() { if (this.currentPage < this.totalPages) this.currentPage += 1; },
    prevPage() { if (this.currentPage > 1) this.currentPage -= 1; },
    clampPage() {
      if (this.currentPage > this.totalPages) this.currentPage = this.totalPages;
      if (this.currentPage < 1) this.currentPage = 1;
    },
    handleFlexYearChange(e) {
      const newYear = e.target.value;
      if(newYear === this.flexTimeSelectedYear) return

      this.flexRequests = []

      this.fetchFlexRequests()

    }
  },

  // ---------------------------------------------------------------------------
  // Watchers
  // ---------------------------------------------------------------------------
  watch: {
    // Keep draft "Other" comment text preserved
    actionComment(newVal) {
      if (this.selectedComment === 'OTHER') {
        this.customCommentDraft = newVal;
      }
    },

    // If filtered dataset changes, keep page in range
    filteredRequests() {
      this.currentPage = 1;
      this.clampPage();
    }
  },

  // ---------------------------------------------------------------------------
  // Lifecycle
  // ---------------------------------------------------------------------------
  mounted() {
    // Global click handlers (filters & banner)
    document.addEventListener('click', this.onDocClick);
    document.addEventListener('click', this._onDocClickBanner);

    // Initial loads
    this.authenticate().then( () => {
 this.fetchHeaderData();
    this.fetchDashboard();
    this.fetchFlexRequests();
    });
   

    // Keep filter popover sane on scroll/resize
    const cont = this.$refs.tblWrap;
    if (cont) cont.addEventListener('scroll', this.onContainerScroll, { passive: true });
    window.addEventListener('resize', this.onWinResize, { passive: true });
  },

  beforeUnmount() {
    document.removeEventListener('click', this.onDocClick);
    document.removeEventListener('click', this._onDocClickBanner);
    const cont = this.$refs.tblWrap;
    if (cont) cont.removeEventListener('scroll', this.onContainerScroll);
    window.removeEventListener('resize', this.onWinResize);
  }
}).mount('#dashboardApp');




=======================================================================================

















