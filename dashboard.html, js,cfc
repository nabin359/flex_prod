


dashboard.cfc





component {

  /**
   * Summary metrics used by the cards and chart (user scope).
   */
  remote any function getDashboardData()
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    /** filter condition change (user-scoped) **/
    var q = queryExecute(
      "
      SELECT
        COUNT(*) AS total,
        SUM(CASE WHEN Status='Pending'  THEN 1 ELSE 0 END) AS pending,
        SUM(CASE WHEN Status='Approved' THEN 1 ELSE 0 END) AS approved,
        SUM(CASE WHEN Status='Modify'   THEN 1 ELSE 0 END) AS Modified,
        SUM(CASE WHEN Status='Declined' THEN 1 ELSE 0 END) AS declined
      FROM PCSV_dw.dbo.FlexTimeRequests
      WHERE CreatedBy = :uid
      ",
      { uid: { value: session.userACE, cfsqltype: "cf_sql_varchar" } },
      { datasource: "pcsv_dw" }
    );

    return {
      TOTAL        : q.total,
      PENDING      : q.Pending,
      APPROVED     : q.Approved,
      MODIFICATION : q.Modified,
      DECLINED     : q.Declined
    };
  }


  /**
   * Header values for banner: facility name, current FY and week (user scope).
   */
  remote any function getHeaderData()
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var hdr = {};

    // Facility name for the current user (based on any of their requests)
    var qFac = queryExecute(
      "
      SELECT TOP 1
             cp.user_id,
             vb.B_FIN_NAME AS officeName
        FROM PCSV_csaw.dbo.csaw_pw cp
        JOIN PCSV_dw.dbo.FlexTimeRequests ftr
          ON cp.user_id = ftr.CreatedBy
        JOIN PCSV_dw.dbo.var_base vb
          ON ftr.FacilityID = vb.B_FIN_NBR
       WHERE cp.user_id = :uid
       ORDER BY ftr.CreatedDate DESC
      ",
      { uid: { value: session.userACE, cfsqltype: "cf_sql_varchar" } },
      { datasource: "pcsv_dw" }
    );

    hdr.officeName = qFac.recordCount ? qFac.officeName[1] : "Unknown Facility";

    // Current FY/week from master calendar
    var qWeek = queryExecute(
      "
      SELECT TOP 1
             cal_fy_long AS fiscalYear,
             cal_fy_wk   AS week
        FROM PCSV_dw.dbo.Master_Calendar
       WHERE :today BETWEEN cal_date_beg_wk AND cal_date_end_wk
       ORDER BY cal_id DESC
      ",
      { today: { value: now(), cfsqltype: "cf_sql_timestamp" } },
      { datasource: "pcsv_dw" }
    );

    if ( qWeek.recordCount ) {
      hdr.fiscalYear = qWeek.fiscalYear[1];
      hdr.week       = qWeek.week[1];
    } else {
      hdr.fiscalYear = "";
      hdr.week       = "";
    }

    return hdr;
  }


  /**
   * Returns rows for the userâ€™s table (only their requests).
   * Dynamically pulls AREA/MPOO-like columns if present on var_base.
   */
  remote any function getFlexRequests()
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    // --- Detect optional Area / MPOO columns on var_base safely ---
    var areaCandidates = "AREA,AREA_NAME,AREA_DESC,AREA_NM,AREANAME";
    var mpooCandidates = "MPOO,MPOO_GROUP,MPOO_GRP,MPOO_DESC,MPOO_NAME";
    var quoted = listQualify(areaCandidates & "," & mpooCandidates, "'", ",");
    var cols = queryExecute(
      "
      SELECT UPPER(COLUMN_NAME) AS COL
        FROM INFORMATION_SCHEMA.COLUMNS
       WHERE TABLE_SCHEMA = 'dbo'
         AND TABLE_NAME   = 'var_base'
         AND COLUMN_NAME IN (#quoted#)
      ",
      {},
      { datasource: "pcsv_dw" }
    );

    var areaCol = "NULL";
    var mpooCol = "NULL";
    for ( var r = 1; r <= cols.recordCount; r++ ) {
      var c = cols.COL[r];
      if ( areaCol EQ "NULL" AND listFindNoCase(areaCandidates, c) ) areaCol = "vb." & c;
      if ( mpooCol  EQ "NULL" AND listFindNoCase(mpooCandidates, c) ) mpooCol = "vb." & c;
    }

    var areaExpr = areaCol;
    var mpooExpr = mpooCol;

    var raw = queryExecute(
      "
      SELECT
        ftr.RequestID,
        ftr.FacilityID,
        ftr.Craft,
        ftr.LabourDistributionCode,
        ftr.OperationNumber,
        ftr.HoursPerWeek,
        ftr.Justification,
        ftr.Status,
        ftr.ModifiedBy,
        CONVERT(VARCHAR(10), ftr.StartDate, 23) AS StartDate,
        CONVERT(VARCHAR(10), ftr.EndDate,   23) AS EndDate,
        ftr.CreatedBy,
        cp.user_fname,
        cp.user_lname,
        CONVERT(VARCHAR(19), ftr.CreatedDate, 120) AS CreatedOn,

        vb.B_FIN_NAME AS FacilityName,
        #areaExpr#    AS AreaName,
        #mpooExpr#    AS MPOOGroup,

        -- Latest audit comment (optional)
        fta.Comment     AS LatestComment,
        fta.ChangedBy   AS LatestChangedBy,
        CONVERT(VARCHAR(19), fta.ChangedDate, 120) AS LatestChangedDate,

        CASE
          WHEN ISNULL(ftr.Status,'Pending') = 'Modify'                THEN 0
          WHEN ISNULL(ftr.Status,'Pending') <> 'Pending'              THEN 1
          WHEN ftr.ModifiedBy IS NOT NULL                             THEN 1
          WHEN EXISTS (SELECT 1 FROM PCSV_dw.dbo.FlexTimeAudit a
                        WHERE a.RequestID = ftr.RequestID)            THEN 1
          ELSE 0
        END AS IsLocked

      FROM pcsv_dw.dbo.FlexTimeRequests ftr
      INNER JOIN PCSV_csaw.dbo.csaw_pw cp
              ON ftr.CreatedBy = cp.user_id
      LEFT  JOIN PCSV_dw.dbo.var_base vb
              ON vb.B_FIN_NBR  = ftr.FacilityID

      -- Latest comment per request
      LEFT JOIN (
        SELECT x.RequestID, x.Comment, x.ChangedBy, x.ChangedDate
          FROM (
            SELECT
              a.RequestID, a.Comment, a.ChangedBy, a.ChangedDate,
              ROW_NUMBER() OVER (PARTITION BY a.RequestID ORDER BY a.ChangedDate DESC) AS rn
            FROM PCSV_dw.dbo.FlexTimeAudit a
          ) x
         WHERE x.rn = 1
      ) fta ON fta.RequestID = ftr.RequestID

      WHERE ftr.CreatedBy = :currentUserAce
      ORDER BY CreatedOn DESC
      ",
      { currentUserAce: { value: session.userACE, cfsqltype: "cf_sql_varchar" } },
      { datasource: "pcsv_dw" }
    );

    var out = [];
    for ( var i = 1; i <= raw.recordCount; i++ ) {
      arrayAppend(out, {
        REQUESTID              : raw["RequestID"][i],
        FACILITYID             : raw["FacilityID"][i],
        FACILITYNAME           : raw["FacilityName"][i],
        AREA                   : raw["AreaName"][i],
        MPOO                   : raw["MPOOGroup"][i],
        CRAFT                  : raw["Craft"][i],
        LABOURDISTRIBUTIONCODE : raw["LabourDistributionCode"][i],
        OPERATIONNUMBER        : raw["OperationNumber"][i],
        HOURSPERWEEK           : raw["HoursPerWeek"][i],
        JUSTIFICATION          : raw["Justification"][i],
        STATUS                 : raw["Status"][i],
        STARTDATE              : raw["StartDate"][i],
        ENDDATE                : raw["EndDate"][i],
        CREATEDBY              : raw["CreatedBy"][i],
        USER_FNAME             : raw["user_fname"][i],
        USER_LNAME             : raw["user_lname"][i],
        CREATEDON              : raw["CreatedOn"][i],
        LOCKED                 : raw["IsLocked"][i],  // 0 or 1
        COMMENT                : raw["LatestComment"][i],
        CHANGEDBY              : raw["LatestChangedBy"][i],
        CHANGEDDATE            : raw["LatestChangedDate"][i]
      });
    }

    return out;
  }


  /**
   * Returns counts by status for each of the last 15 days.
   */
  remote any function getTrendData15Days()
    returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var q = queryExecute(
      "
      SELECT
        CONVERT(VARCHAR(10), CreatedDate, 23) AS DayDate,  -- YYYY-MM-DD
        COUNT(*) AS Total,
        SUM(CASE WHEN Status='Pending'  THEN 1 ELSE 0 END) AS Pending,
        SUM(CASE WHEN Status='Approved' THEN 1 ELSE 0 END) AS Approved,
        SUM(CASE WHEN Status='Declined' THEN 1 ELSE 0 END) AS Declined
      FROM PCSV_dw.dbo.FlexTimeRequests
      WHERE CreatedDate >= DATEADD(day, -14, GETDATE())
      GROUP BY CONVERT(VARCHAR(10), CreatedDate, 23)
      ORDER BY DayDate
      ",
      [],
      { datasource: "pcsv_dw" }
    );

    var out = [];
    for ( var i = 1; i <= q.recordCount; i++ ) {
      arrayAppend(out, {
        DayDate  : q.DayDate[i],
        Total    : q.Total[i],
        Pending  : q.Pending[i],
        Approved : q.Approved[i],
        Declined : q.Declined[i]
      });
    }

    return out;
  }


  /**
   * Allow the requester (non-admin) to edit their own Pending request,
   * only if the request has NOT been touched by admin.
   *
   * Accepts form/multipart or application/json.
   */
  remote any function updateUserRequest(
    numeric requestId = 0,
    any     hours     = "",     // optional
    string  justification = "", // optional
    string  startDate = "",     // optional, YYYY-MM-DD
    string  endDate   = ""      // optional, YYYY-MM-DD
  ) returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    // Merge JSON body if present
    var http = getHTTPRequestData();
    var ct   = lcase( toString( http.headers["Content-Type"] ?: http.headers["content-type"] ?: "" ) );
    if ( findNoCase("application/json", ct) AND len(trim(http.content)) ) {
      try {
        var j = deserializeJSON(http.content);
        if ( structKeyExists(j,"requestId") )    arguments.requestId    = val(j.requestId);
        if ( structKeyExists(j,"hours") )        arguments.hours        = j.hours;
        if ( structKeyExists(j,"justification") )arguments.justification= toString(j.justification);
        if ( structKeyExists(j,"startDate") )    arguments.startDate    = toString(j.startDate);
        if ( structKeyExists(j,"endDate") )      arguments.endDate      = toString(j.endDate);
      } catch ( any __e ) { /* ignore parse errors */ }
    }

    var rid = val(arguments.requestId);
    if ( rid LTE 0 ) return { SUCCESS:false, MESSAGE:"requestId is required." };

    // Verify ownership + lock condition
    var row = queryExecute(
      "
      SELECT TOP 1
             CreatedBy,
             ISNULL(Status,'Pending') AS CurrStatus,
             CASE
               WHEN ISNULL(Status,'Pending') = 'Modify' THEN 0
               WHEN ISNULL(Status,'Pending') <> 'Pending' THEN 1
               WHEN ModifiedBy IS NOT NULL THEN 1
               WHEN EXISTS (SELECT 1 FROM PCSV_dw.dbo.FlexTimeAudit a WHERE a.RequestID = :rid) THEN 1
               ELSE 0
             END AS IsLocked
        FROM PCSV_dw.dbo.FlexTimeRequests
       WHERE RequestID = :rid
      ",
      { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
      { datasource: "pcsv_dw" }
    );

    if ( !row.recordCount )                     return { SUCCESS:false, MESSAGE:"Request not found." };
    if ( row.CreatedBy[1] NEQ session.userACE ) return { SUCCESS:false, MESSAGE:"Not your request." };
    if ( row.IsLocked[1] )                      return { SUCCESS:false, MESSAGE:"Request is locked by admin; cannot modify." };

    // Build dynamic SET clause
    var sets   = [];
    var params = { rid: { value: rid, cfsqltype: "cf_sql_integer" } };

    if ( structKeyExists(arguments,"hours") AND isNumeric(arguments.hours) ) {
      arrayAppend(sets, "HoursPerWeek = :hours");
      params.hours = { value: arguments.hours, cfsqltype: "cf_sql_numeric" };
    }
    if ( len(arguments.justification) ) {
      arrayAppend(sets, "Justification = :justification");
      params.justification = { value: arguments.justification, cfsqltype: "cf_sql_varchar" };
    }
    if ( len(arguments.startDate) ) {
      arrayAppend(sets, "StartDate = :sd");
      params.sd = { value: arguments.startDate, cfsqltype: "cf_sql_date" };
    }
    if ( len(arguments.endDate) ) {
      arrayAppend(sets, "EndDate = :ed");
      params.ed = { value: arguments.endDate, cfsqltype: "cf_sql_date" };
    }

    if ( arrayLen(sets) EQ 0 ) return { SUCCESS:false, MESSAGE:"No updatable fields provided." };

    try {
      queryExecute(
        "UPDATE PCSV_dw.dbo.FlexTimeRequests SET #arrayToList(sets, ', ')# WHERE RequestID = :rid",
        params,
        { datasource: "pcsv_dw" }
      );

      // Flip back to Pending if previous status was Modify
      if ( compareNoCase(row.CurrStatus[1], "Modify") EQ 0 ) {
        queryExecute(
          "
          UPDATE PCSV_dw.dbo.FlexTimeRequests
             SET Status = 'Pending',
                 ModifiedBy = NULL,
                 ModifiedDate = GETDATE()
           WHERE RequestID = :rid
          ",
          { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
          { datasource: "pcsv_dw" }
        );
      }

      var q = queryExecute(
        "
        SELECT
          RequestID, FacilityID, Craft, LabourDistributionCode, OperationNumber,
          HoursPerWeek, Justification, Status,
          CONVERT(VARCHAR(10), StartDate, 23) AS StartDate,
          CONVERT(VARCHAR(10), EndDate,   23) AS EndDate,
          CreatedBy, CONVERT(VARCHAR(19), CreatedDate, 120) AS CreatedOn
        FROM PCSV_dw.dbo.FlexTimeRequests
        WHERE RequestID = :rid
        ",
        { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
        { datasource: "pcsv_dw" }
      );

      if ( !q.recordCount ) return { SUCCESS:false, MESSAGE:"Reload failed." };

      var data = {
        REQUESTID              : q.RequestID[1],
        FACILITYID             : q.FacilityID[1],
        CRAFT                  : q.Craft[1],
        LABOURDISTRIBUTIONCODE : q.LabourDistributionCode[1],
        OPERATIONNUMBER        : q.OperationNumber[1],
        HOURSPERWEEK           : q.HoursPerWeek[1],
        JUSTIFICATION          : q.Justification[1],
        STATUS                 : q.Status[1],
        STARTDATE              : q.StartDate[1],
        ENDDATE                : q.EndDate[1],
        CREATEDBY              : q.CreatedBy[1],
        CREATEDON              : q.CreatedOn[1]
      };

      // --- EMAIL: confirm user edit (non-blocking) ---
      try {
        var createdByAce = ( row.recordCount ? toString(row.CreatedBy[1]) : "" );
        var toEmail = "";
        var uname   = "";

        if ( len(createdByAce) ) {
          var mailQ = queryExecute(
            "
            SELECT TOP 1
                   NULLIF(LTRIM(RTRIM(COALESCE(user_email, email, mail))), '') AS userEmail,
                   LTRIM(RTRIM(COALESCE(user_fname,'') + ' ' + COALESCE(user_lname,''))) AS userName
              FROM PCSV_csaw.dbo.csaw_pw
             WHERE user_id = :uid
            ",
            { uid: { value: createdByAce, cfsqltype: "cf_sql_varchar" } },
            { datasource: "pcsv_dw" }
          );
          if ( mailQ.recordCount ) {
            toEmail = trim(mailQ.userEmail[1] ?: "");
            uname   = trim(mailQ.userName[1]  ?: "");
          }
        }

        if ( len(toEmail) ) {
          var mailer = new ref.api.v1.toolbox.flex.flexmail();
          var reqForEmail = {
            requestId       : q.RequestID[1],
            facilityId      : q.FacilityID[1],
            craft           : q.Craft[1],
            ldc             : q.LabourDistributionCode[1],
            operationNumber : q.OperationNumber[1],
            hours           : q.HoursPerWeek[1],
            justification   : q.Justification[1],
            startDate       : q.StartDate[1],
            endDate         : q.EndDate[1],
            attachmentSaved : false,
            submitterName   : uname
          };
          mailer.sendFlexUserEdited( toEmail = toEmail, req = reqForEmail );
        }
      } catch ( any __mailErr ) {
        writeLog(file="application", text="dashboardservice.updateUserRequest mail error: #__mailErr.message# :: #__mailErr.detail#");
      }

      return { SUCCESS:true, MESSAGE:"Updated.", DATA:data };

    } catch ( any e ) {
      writeLog(file="application", text="updateUserRequest error: " & e.message & " :: " & e.detail);
      return { SUCCESS:false, MESSAGE:e.message, DETAILS:e.detail };
    }
  }


  /**
   * Allow the requester to delete their own Pending request,
   * only if the request has NOT been touched by admin.
   */
  remote any function deleteUserRequest(
    numeric requestId = 0
  ) returnFormat="JSON" produces="application/json" output="false" {

    cfheader(name="Content-Type", value="application/json;charset=UTF-8");

    var rid = val(arguments.requestId);

    // Support JSON body as well
    var http = getHTTPRequestData();
    var ct   = lcase( toString( http.headers["Content-Type"] ?: http.headers["content-type"] ?: "" ) );
    if ( findNoCase("application/json", ct) AND len(trim(http.content)) ) {
      try {
        var j = deserializeJSON(http.content);
        if ( structKeyExists(j,"requestId") ) rid = val(j.requestId);
      } catch ( any __e ) { /* ignore */ }
    }

    if ( rid LTE 0 ) return { SUCCESS:false, MESSAGE:"requestId is required." };

    var row = queryExecute(
      "
      SELECT TOP 1
             CreatedBy,
             ISNULL(Status,'Pending') AS CurrStatus,
             CASE
               WHEN ISNULL(Status,'Pending') = 'Modify' THEN 0
               WHEN ISNULL(Status,'Pending') <> 'Pending' THEN 1
               WHEN ModifiedBy IS NOT NULL THEN 1
               WHEN EXISTS (SELECT 1 FROM PCSV_dw.dbo.FlexTimeAudit a WHERE a.RequestID = :rid) THEN 1
               ELSE 0
             END AS IsLocked
        FROM PCSV_dw.dbo.FlexTimeRequests
       WHERE RequestID = :rid
      ",
      { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
      { datasource: "pcsv_dw" }
    );

    if ( !row.recordCount )                    return { SUCCESS:false, MESSAGE:"Request not found." };
    if ( row.CreatedBy[1] NEQ session.userACE )return { SUCCESS:false, MESSAGE:"Not your request." };
    if ( row.IsLocked[1] )                     return { SUCCESS:false, MESSAGE:"Request is locked by admin; cannot delete." };

    // Prefetch minimal row to include in email
    var prev = queryExecute(
      "
      SELECT TOP 1
             RequestID, FacilityID, Craft, LabourDistributionCode, OperationNumber,
             HoursPerWeek, CONVERT(VARCHAR(10), StartDate, 23) AS StartDate,
             CONVERT(VARCHAR(10), EndDate,   23) AS EndDate, CreatedBy, Justification
        FROM PCSV_dw.dbo.FlexTimeRequests
       WHERE RequestID = :rid
      ",
      { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
      { datasource: "pcsv_dw" }
    );

    try {
      transaction {
        queryExecute(
          "DELETE FROM PCSV_dw.dbo.FlexTimeFileStorage WHERE RequestID = :rid",
          { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
          { datasource: "pcsv_dw" }
        );

        queryExecute(
          "DELETE FROM PCSV_dw.dbo.FlexTimeRequests WHERE RequestID = :rid",
          { rid: { value: rid, cfsqltype: "cf_sql_integer" } },
          { datasource: "pcsv_dw" }
        );
      }

      // --- EMAIL: confirm user delete (non-blocking) ---
      try {
        var createdByAce = ( prev.recordCount ? toString(prev.CreatedBy[1]) : "" );
        var toEmail = "";
        var uname   = "";

        if ( len(createdByAce) ) {
          var mailQ = queryExecute(
            "
            SELECT TOP 1
                   NULLIF(LTRIM(RTRIM(COALESCE(user_email, email, mail))), '') AS userEmail,
                   LTRIM(RTRIM(COALESCE(user_fname,'') + ' ' + COALESCE(user_lname,''))) AS userName
              FROM PCSV_csaw.dbo.csaw_pw
             WHERE user_id = :uid
            ",
            { uid: { value: createdByAce, cfsqltype: "cf_sql_varchar" } },
            { datasource: "pcsv_dw" }
          );
          if ( mailQ.recordCount ) {
            toEmail = trim(mailQ.userEmail[1] ?: "");
            uname   = trim(mailQ.userName[1]  ?: "");
          }
        }

        if ( len(toEmail) ) {
          var mailer = new ref.api.v1.toolbox.flex.flexmail();
          var reqForEmail = {
            requestId       : prev.RequestID[1],
            facilityId      : prev.FacilityID[1],
            craft           : prev.Craft[1],
            ldc             : prev.LabourDistributionCode[1],
            operationNumber : prev.OperationNumber[1],
            hours           : prev.HoursPerWeek[1],
            justification   : prev.Justification[1],
            startDate       : prev.StartDate[1],
            endDate         : prev.EndDate[1],
            submitterName   : uname,
            submitterId     : createdByAce
          };
          mailer.sendFlexUserEdited( toEmail = toEmail, req = reqForEmail );
        }
      } catch ( any __mailErr ) {
        writeLog(file="application", text="dashboardservice.deleteUserRequest mail error: #__mailErr.message# :: #__mailErr.detail#");
      }

      return { SUCCESS:true, MESSAGE:"Deleted." };

    } catch ( any e ) {
      writeLog(file="application", text="deleteUserRequest error: " & e.message & " :: " & e.detail);
      return { SUCCESS:false, MESSAGE:e.message, DETAILS:e.detail };
    }
  }

}




                 dashboard.index





                 <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flex Time Dashboard</title>

  <!-- Tailwind JIT -->
  <script src="/ref/packages/tailwindcss.browser.4.min.js"></script>
  <!-- Flowbite -->
  <link href="/ref/styles/flowbite.min.css" rel="stylesheet" />
  <script src="/ref/packages/flowbite.min.js"></script>

  <!-- Axios, Moment, Numeral -->
  <script src="/ref/packages/axios.min.js"></script>
  <script src="/ref/packages/moment.min.js" crossorigin="anonymous"></script>
  <script src="/ref/packages/numeral.min.js" crossorigin="anonymous"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js" crossorigin="anonymous"></script> -->

  <link rel="stylesheet" href="/ref/styles/global.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      background: #f1f5f9;
      /* font-family: sans-serif; */
    }

    /* #dashboardApp {

      width: 100%;
      max-width: 100%;
      margin-left: 0;
      margin-right:0;

    } */
    /* Fixed header bar */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      z-index: 50;
    }

    /* Card look */
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }

    /* Chart height compact so Summary + Chart are visible together */
    .chart-wrap { height: 14rem; }

    /* Ensure main content sits below header */
    main {
      padding-top: 5rem;
    }

    /* USPS brand color */
    .usps-blue {
      background-color: #3B6E8F;
    }

    /* Hover on table rows */
    table tbody tr:hover {
      background: #f9fafb;
    }



/* ===== Admin-style table & filter UI ===== */
.tbl-wrap { overflow: auto; position: relative }
table { width:100%; border-collapse: separate; border-spacing: 0; }
thead th { position: sticky; top: 0; z-index: 1; }
thead th .th-inner { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
thead th button.filter-btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:22px; height:22px; border-radius:6px;
  background: rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.28);
}
thead th button.filter-btn:hover{ background: rgba(255,255,255,0.2); }

thead th, tbody td { padding:.55rem .65rem; }
tbody tr:nth-child(odd){ background:#fbfdff; }
tbody tr:hover{ background:#f5f9ff; }

/* Column widths (match admin so headers fit) */
th.col-id,          td.col-id          { width: 70px; }
th.col-facility,    td.col-facility    { width: 110px; }
th.col-facname,     td.col-facname     { width: 220px; }
th.col-hours,       td.col-hours       { width: 90px; }
th.col-craft,       td.col-craft       { width: 120px; }
th.col-ldc,         td.col-ldc         { width: 130px; }
th.col-opnum,       td.col-opnum       { width: 140px; }
th.col-just,        td.col-just        { width: 260px; }
th.col-start,       td.col-start       { width: 120px; }
th.col-end,         td.col-end         { width: 120px; }
th.col-userid,      td.col-userid      { width: 140px; }
th.col-username,    td.col-username    { width: 170px; }
th.col-on,          td.col-on          { width: 160px; }
th.col-status,      td.col-status      { width: 130px; }
th.col-comment,     td.col-comment     { width: 260px; }
th.col-actions,     td.col-actions     { width: 150px; }

.cell-ellipsis{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Status chips (same look as admin) */
.chip { display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; font-weight:600; }
.chip-pending { background:#dbeafe; color:#1e3a8a; }
.chip-approved{ background:#dcfce7; color:#14532d; }
.chip-declined{ background:#fee2e2; color:#7f1d1d; }
.chip-modify  { background:#fef3c7; color:#92400e; }
.chip-default { background:#f3f4f6; color:#111827; }

/* Filter popover */
.filter-pop{
  position:absolute; z-index:60;
  background:#fff; border:1px solid #e5e7eb; border-radius:10px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
  width:260px; padding:12px; animation:pop .12s ease;
}
.filter-pop h4{ font-size:12px; font-weight:700; margin:2px 0 8px; color:#374151; letter-spacing:.02em; }
.filter-pop .row{ display:flex; gap:8px; margin-top:10px; }
@keyframes pop{ from{ transform:translateY(-3px); opacity:0; } to{ transform:translateY(0); opacity:1; } }

/* Compact/Shrink */
.compact table { font-size:12px; }
.shrink { transform:scale(0.93); transform-origin:top left; width:107.5%; }







  </style>
</head>

<body>
  <div id="dashboardApp" class="w-full p-6 border-gray-300 rounded-lg">

    <!-- Top Nav -->
    <header>
      <div class="w-full px-14 py-0 flex items-center justify-between">
        <!-- Left: Logo + Title -->
        <div class="flex items-center space-x-2">
          <a href="https://eagnmnwbp161f.usps.gov/" class="flex items-center space-x-2 hover:opacity-80 transition">
            <img src="https://eagnmnwbp161f.usps.gov/rework/assets/EIR_logo_color.png" alt="EIR Logo"
              class="h-16 w-16 object-contain">
            <span class="text-2xl font-semibold text-gray-700">| Workhour Analytics</span>
          </a>
        </div>

        <!-- Right: New Request + User -->
        <div class="flex items-center justify-between space-x-6">
          <a href="/ref/toolbox/flex/index.html"
            class="px-4 py-2 bg-[#3B6E8F] text-white rounded-lg font-semibold shadow hover:bg-blue-500 transition">
            + New Flex Request
          </a>
          <div v-if="userDisplayHeader" class="flex items-center space-x-4 text-lg text-gray-700 font-medium">
            {{ userDisplayHeader }}
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 w-full">
      <div class="w-full px-6">

        <!-- Breadcrumb -->
        <nav class="text-gray-600 text-md font-semibold rounded-2xl card shadow-md p-6 mb-6 -mt-12" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
            <li>
              <a href="https://eagnmnwbc1db.usps.gov/" class="flex items-center hover:text-blue-700 transition">
                <svg class="w-4 h-4 mr-1 text-gray-700" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 12l9-9 9 9M9 21V10h6v11" />
                </svg>
                WEMS Home
              </a>
            </li>
            <li>
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 5l7 7-7 7" />
              </svg>
            </li>
            <li class="text-blue-800 font-semibold">Flex Time Dashboard</li>
          </ol>
        </nav>

        <!-- Info Banner -->
        <!-- <div class="usps-blue text-white rounded-md shadow-md p-10 mb-6">
          <h1 class="text-3xl font-semibold">Flex Time Request</h1>
          <p class="text-md mt-1" v-if="officeName && fiscalYear && week">
            Office/Facility: {{ officeName }}
            <span class="hidden sm:inline"> - </span>
            Fiscal Year: {{ fiscalYear }}, Week: {{ week }}
          </p>
        </div> -->

        <!-- Info Banner (identical to admin) -->
      <div class="usps-blue text-white rounded-xl shadow-md p-8 mb-6 relative" ref="bannerWrap">
        <h1 class="text-3xl font-bold tracking-tight">Flex Time Request</h1>

        <p class="mt-2 text-base flex flex-wrap items-center gap-2">
          <span class="font-semibold">Office/Facility:</span>
          <span class="font-semibold">{{ officeName || 'â€”' }}</span>

          <!-- Show the picker when user has more than 1 facility -->
          <button
            v-if="facilities.length > 1"
            type="button"
            class="ml-2 inline-flex items-center px-2 py-1 text-xs font-semibold rounded bg-white/15 hover:bg-white/25"
            @click.stop="openBannerMenu($event)"
            title="View all facilities"
          >
            View all ({{ facilities.length }})
          </button>

          <span class="hidden sm:inline">&nbsp;&nbsp;â€¢&nbsp;&nbsp;</span>
          <span class="font-semibold">Fiscal Year:</span> <span class="font-semibold">{{ fiscalYear || 'â€”' }}</span>

          <span class="hidden sm:inline">&nbsp;&nbsp;â€¢&nbsp;&nbsp;</span>
          <span class="font-semibold">Week:</span> <span class="font-semibold">{{ week || 'â€”' }}</span>
        </p>

        <!-- Facilities popover (anchored to the banner) -->
        <div
          v-if="bannerMenu.open"
          ref="bannerMenuRef"
          class="absolute z-[100] bg-white text-gray-800 rounded-lg shadow-2xl border border-gray-200 w-80 p-3"
          :style="{ top: bannerMenu.y + 'px', left: bannerMenu.x + 'px' }"
        >
          <div class="text-sm font-semibold text-gray-600 mb-2">Your Facilities</div>
          <ul class="max-h-64 overflow-auto divide-y divide-gray-100">
            <li v-for="f in facilities" :key="f.B_FIN_NBR" class="py-2">
              <button
                class="w-full text-left hover:bg-gray-50 rounded px-2 py-1"
                @click="gotoFacility(f)"
                :title="(f.B_FIN_NAME || '') + ' (' + (f.B_FIN_NBR || '') + ')'"
              >
                <div class="text-sm font-medium">{{ f.B_FIN_NAME }}</div>
                <div class="text-xs text-gray-500">FIN: {{ f.B_FIN_NBR }}</div>
              </button>
            </li>
          </ul>
          <div class="mt-2 text-right">
            <button class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200" @click="bannerMenu.open=false">Close</button>
          </div>
        </div>
      </div>






        <!-- Summary -->
        <section class="bg-white rounded-2xl shadow-md p-6 mb-6 border-0 border-blue-700">
          <h2 class="text-lg font-semibold text-gray-700 mb-4">Summary</h2>
          <div class="flex flex-wrap justify-between gap-4">
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Total Requests</div>
              <div class="text-2xl font-bold">{{ metrics.TOTAL }}</div>
            </div>
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Pending</div>
              <div class="text-2xl font-bold">{{ metrics.PENDING }}</div>
            </div>
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Approved</div>
              <div class="text-2xl font-bold">{{ metrics.APPROVED }}</div>
            </div>

             <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Request Modification</div>
              <div class="text-2xl font-bold">{{ metrics.MODIFICATION }}</div>
            </div>

            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Declined</div>
              <div class="text-2xl font-bold">{{ metrics.DECLINED }}</div>
            </div>
          </div>
        </section>

     


         <!-- Single Chart -->
        <div class="card p-6 mb-8">
          <h2 class="text-xl font-semibold text-blue-800 mb-2">Request Status Chart</h2>
          <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
        </div>


            <!-- <div class="bg-white rounded-2xl shadow-md p-6">
      <h2 class="text-xl font-semibold text-blue-800 mb-2">Last 7 Days Trend</h2>
      <canvas id="trendChart" height="150"></canvas> -->

            <!-- Trend Data Table -->
            <!-- <table class="min-w-full table-auto mt-4">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-4 py-2 text-left text-sm font-semibold">Date</th>
            <th class="px-4 py-2 text-left text-sm font-semibold">Count</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="item in trendData" :key="item.date" class="border-t hover:bg-gray-50">
              <td class="px-4 py-2">{{ item.date }}</td>
              <td class="px-4 py-2">{{ item.count }}</td>
            </tr>
          </tbody>
        </table>
      </div> -->





              <!-- Requests Table -->
              <!-- <div class="bg-white rounded-2xl shadow-md p-6 overflow-x-auto mb-8">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-xl font-semibold text-blue-800">All Flex-Time Requests</h2>

                  <button @click="exportTableToCSV"
                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                    ðŸ“¥ Export to Excel
                  </button>



                </div>
                <table class="min-w-full table-auto">
                  <thead class="bg-blue-50">
                    <tr>
                      <th class="px-4 py-2 text-left text-sm font-semibold">ID</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Facility</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Hours</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Craft</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Labour Distribution Code</th>
                      
                      <th class="px-4 py-2 text-left text-sm font-semibold">Operation Number</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Justification</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Start</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">End</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">USER ID</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">User Name</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">On</th>
                      
                      <th class="px-4 py-2 text-left text-sm font-semibold">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="req in flexRequests" :key="req.REQUESTID" class="border-t hover:bg-gray-50">
                      <td class="px-4 py-2">{{ req.REQUESTID }}</td>
                      <td class="px-4 py-2">{{ req.FACILITYID }}</td>
                      <td class="px-4 py-2">{{ req.HOURSPERWEEK }}</td>
                      <td class="px-4 py-2">{{ req.CRAFT }}</td>
                      <td class="px-4 py-2">{{ req.LABOURDISTRIBUTIONCODE }}</td>
                      <td class="px-4 py-2">{{ req.OPERATIONNUMBER }}</td>
                      <td class="px-4 py-2">{{ req.JUSTIFICATION }}</td>
                      <td class="px-4 py-2">{{ req.STARTDATE }}</td>
                      <td class="px-4 py-2">{{ req.ENDDATE }}</td>
                      <td class="px-4 py-2">{{ req.CREATEDBY }}</td>
                      <td class="px-4 py-2">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td>
                      <td class="px-4 py-2">{{ req.CREATEDON }}</td>
                      
                      
                    
                      <td class="px-4 py-2">
        <div class="flex items-center gap-2">
          <button
            class="px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed"
            @click.prevent="openEdit(req)"
            :disabled="isLocked(req)"
            title="Edit this request"
          >
            Edit
          </button>

          <button
            class="px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed"
            @click.prevent="confirmDelete(req)"
            :disabled="isLocked(req)"
            title="Delete this request"
          >
            Delete
          </button>
        </div>
        <div v-if="isLocked(req)" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
          Locked by admin
        </div>
      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

            </div>
          </main>

          
          
          


      <div v-if="showEditModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Edit Request #{{ editForm.requestId }}</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
              <label class="font-semibold">Craft</label>
              <select v-model="editForm.craft" class="w-full border rounded p-2">
                <option>clerk</option>
                <option>mailhandler</option>
              </select>
            </div>
            
            <div>
              <label class="font-semibold">LDC</label>
              <input v-model.number="editForm.ldc" class="w-full border rounded p-2" />
            </div>
            <div>
              <label class="font-semibold">Operation #</label>
              <input v-model="editForm.operationNumber" class="w-full border rounded p-2" />
            </div>

            <div>
              <label class="block text-sm font-medium">Hours / Week</label>
              <input type="number" step="0.01" min="0.01" max="100" v-model.number="editForm.hours" class="mt-1 w-full border rounded p-2">
            </div>
            <div>
              <label class="block text-sm font-medium">Start Date</label>
              <input type="date" v-model="editForm.startDate" class="mt-1 w-full border rounded p-2">
            </div>
            <div>
              <label class="block text-sm font-medium">End Date</label>
              <input type="date" v-model="editForm.endDate" class="mt-1 w-full border rounded p-2">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium">Justification</label>
              <textarea rows="4" v-model="editForm.justification" class="mt-1 w-full border rounded p-2"></textarea>
            </div>
          </div>

          <div class="flex items-center justify-end gap-2 mt-6">
            <button class="px-4 py-2 rounded border" @click="showEditModal=false">Cancel</button>
            <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @click="saveEdit">Save</button>
          </div>

          <p v-if="editStatus" class="mt-3 text-sm" :class="editStatusOK ? 'text-green-700':'text-red-700'">
            {{ editStatus }}
          </p>
        </div> -->



<div class="card p-4 mb-8" :class="[{ compact: compactView }, { shrink: shrinkToFit }]">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-xl font-semibold text-blue-800">All Flex-Time Requests</h2>
    <div class="flex items-center gap-3">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="compactView"/>
        <span>Compact view</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="shrinkToFit"/>
        <span>Shrink to fit</span>
      </label>

      <button @click="exportTableToCSV"
              class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
        ðŸ“¥ Export to CSV
      </button>
    </div>
  </div>

  <div class="tbl-wrap relative" ref="tblWrap">
    <table>
      <thead>
        <tr style="background:#3B6E8F; color:#fff;">
          <th class="col-id">
            <div class="th-inner">
              <span class="font-semibold">ID</span>
              <button class="filter-btn" @click.stop="openFilterMenu('REQUESTID', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-facility">
            <div class="th-inner">
              <span class="font-semibold">Facility</span>
              <button class="filter-btn" @click.stop="openFilterMenu('FACILITYID', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <!-- NEW: Facility Name -->
          <th class="col-facname">
            <div class="th-inner">
              <span class="font-semibold">Facility Name</span>
              <button class="filter-btn" @click.stop="openFilterMenu('FACILITYNAME', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <th class="col-hours">
            <div class="th-inner">
              <span class="font-semibold">Hours</span>
              <button class="filter-btn" @click.stop="openFilterMenu('HOURSPERWEEK', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-craft">
            <div class="th-inner">
              <span class="font-semibold">Craft</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CRAFT', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-ldc">
            <div class="th-inner">
              <span class="font-semibold">LDC</span>
              <button class="filter-btn" @click.stop="openFilterMenu('LABOURDISTRIBUTIONCODE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-opnum">
            <div class="th-inner">
              <span class="font-semibold">Operation #</span>
              <button class="filter-btn" @click.stop="openFilterMenu('OPERATIONNUMBER', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-just">
            <div class="th-inner">
              <span class="font-semibold">Justification</span>
              <button class="filter-btn" @click.stop="openFilterMenu('JUSTIFICATION', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-start">
            <div class="th-inner">
              <span class="font-semibold">Start</span>
              <button class="filter-btn" @click.stop="openFilterMenu('STARTDATE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-end">
            <div class="th-inner">
              <span class="font-semibold">End</span>
              <button class="filter-btn" @click.stop="openFilterMenu('ENDDATE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-userid">
            <div class="th-inner">
              <span class="font-semibold">USER ID</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CREATEDBY', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-username">
            <div class="th-inner">
              <span class="font-semibold">User Name</span>
              <button class="filter-btn" @click.stop="openFilterMenu('USER_NAME', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-on">
            <div class="th-inner">
              <span class="font-semibold">On</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CREATEDON', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <!-- NEW: Status & Comment -->
          <th class="col-status">
            <div class="th-inner">
              <span class="font-semibold">Status</span>
              <button class="filter-btn" @click.stop="openFilterMenu('STATUS', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-comment">
            <div class="th-inner">
              <span class="font-semibold">Comment</span>
              <button class="filter-btn" @click.stop="openFilterMenu('COMMENT', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <th class="col-actions"><span class="font-semibold">Actions</span></th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="req in filteredRequests" :key="req.REQUESTID" class="border-top">
          <td class="col-id">{{ req.REQUESTID }}</td>
          <td class="col-facility">{{ req.FACILITYID }}</td>
          <td class="col-facname cell-ellipsis" :title="req.FACILITYNAME">{{ req.FACILITYNAME }}</td>
          <td class="col-hours">{{ req.HOURSPERWEEK }}</td>
          <td class="col-craft">{{ req.CRAFT }}</td>
          <td class="col-ldc">{{ req.LABOURDISTRIBUTIONCODE }}</td>
          <td class="col-opnum">{{ req.OPERATIONNUMBER }}</td>
          <td class="col-just cell-ellipsis" :title="req.JUSTIFICATION">{{ req.JUSTIFICATION }}</td>
          <td class="col-start">{{ req.STARTDATE }}</td>
          <td class="col-end">{{ req.ENDDATE }}</td>
          <td class="col-userid">{{ req.CREATEDBY }}</td>
          <td class="col-username">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td>
          <td class="col-on">{{ req.CREATEDON }}</td>

          <!-- Status chip (admin style) -->
          <td class="col-status">
            <span :class="statusClass(req.STATUS)">{{ req.STATUS }}</span>
          </td>
          <!-- Latest comment (if any) -->
          <td class="col-comment cell-ellipsis" :title="req.COMMENT || ''">{{ req.COMMENT }}</td>

          <td class="col-actions">
            <div class="flex items-center gap-2">
              <button
  type="button"
  class="px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed"
  @click.stop.prevent="onEditClick(req)"
  :disabled="isLocked(req)"
  title="Edit this request"
>
  Edit
</button>

              <button
                class="px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed"
                @click.prevent="confirmDelete(req)"
                :disabled="isLocked(req)"
                title="Delete this request"
              >Delete</button>
            </div>
            <div v-if="isLocked(req)" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
              Locked by admin
            </div>
          </td>
        </tr>
      </tbody>
    </table>




    <!-- Excel-style filter popover -->
    <div v-if="filterMenu.open"
         class="filter-pop"
         :style="{ left: filterMenu.x + 'px', top: filterMenu.y + 'px' }"
         ref="filterMenuRef">
      <h4>Filter: {{ filterMenu.field }}</h4>

      <!-- STATUS gets an exact-match dropdown -->
      <template v-if="filterMenu.field === 'STATUS'">
        <select
          class="w-full border rounded px-2 py-1 text-sm"
          :value="filters.STATUS"
          @change="onStatusChange($event)">
          <option value="">(All)</option>
          <option v-for="opt in statusOptions" :key="opt" :value="opt">{{ opt }}</option>
        </select>
      </template>

      <!-- Others = contains text -->
      <template v-else>
        <input v-model="filters[filterMenu.field]"
               class="w-full border rounded px-2 py-1 text-sm"
               placeholder="Type to filterâ€¦">
      </template>

      <div class="row">
        <button class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200"
                @click.stop="clearFilter(filterMenu.field)">
          Clear
        </button>
        <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                @click.stop="filterMenu.open=false">
          Close
        </button>
      </div>
    </div>
  </div>
</div>


<div v-if="showEditModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
    <h3 class="text-lg font-semibold mb-4">Edit Request #{{ editForm.requestId }}</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium">Hours / Week</label>
        <input type="number" step="0.01" min="0.01" max="100"
               v-model.number="editForm.hours" class="mt-1 w-full border rounded p-2">
      </div>


      <!-- <div>
        <label class="block text-sm font-medium">Start Date</label>
        <input type="date" v-model="editForm.startDate" class="mt-1 w-full border rounded p-2">
      </div>
      <div>
        <label class="block text-sm font-medium">End Date</label>
        <input type="date" v-model="editForm.endDate" class="mt-1 w-full border rounded p-2">
      </div> -->

      <!-- Start Week (Saturday) -->
      <div>
        <label for="wk_start_edit" class="block text-sm font-medium">Start Week</label>
        <select
          id="wk_start_edit"
          v-model="editForm.wk_start"
          @change="onEditStartChange"
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
        >
          <option disabled value="">-------------</option>
          <option v-for="row in weekOptions" :key="row[0]+'-'+row[1]+'-s'"
                  :value="row[2]">Week {{ row[1] }}, {{ row[2] }} (Saturday)</option>
        </select>
      </div>

      <!-- End Week (Friday) -->
    <div>
      <label for="wk_end_edit" class="block text-sm font-medium">End Week</label>
      <select
        id="wk_end_edit"
        v-model="editForm.wk_end"
        @change="onEditEndChange"
        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
      >
        <option disabled value="">-------------</option>
        <option v-for="row in weekOptions" :key="row[0]+'-'+row[1]+'-e'"
                :value="row[3]">Week {{ row[1] }}, {{ row[3] }} (Friday)</option>
      </select>
    </div>

    <!-- Read-only confirmation of the concrete dates that will be saved -->
    <div class="md:col-span-2 text-xs text-gray-600">
      Start: <span class="font-medium">{{ editForm.startDate }}</span>
      &nbsp;â€¢&nbsp;
      End: <span class="font-medium">{{ editForm.endDate }}</span>
    </div>



      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Justification</label>
        <textarea rows="4" v-model="editForm.justification"
                  class="mt-1 w-full border rounded p-2"></textarea>
      </div>
    </div>

    <div class="flex items-center justify-end gap-2 mt-6">
      <button class="px-4 py-2 rounded border" @click="showEditModal=false">Cancel</button>
      <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @click="saveEdit">Save</button>
    </div>

    <p v-if="editStatus" class="mt-3 text-sm"
       :class="editStatusOK ? 'text-green-700':'text-red-700'">
      {{ editStatus }}
    </p>
  </div>
</div>



</div>



  </div>


  

  <!-- Dashboard script -->
  <script type="module" src="/ref/toolbox/flex/dashboard.js"></script>
</body>

</html>











                 dashboard.js


import { createApp } from 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.13/vue.esm-browser.min.js';

createApp({
  data() {
    return {
      serviceFolder: '/ref/api/v1/toolbox/flex/',
      metrics: { TOTAL: 0, PENDING: 0, APPROVED: 0, MODIFICATION: 0, DECLINED: 0 },

      statusChart: null,            // (already used for the bar)
  statusOptions: [],            // dropdown list for STATUS
  filters: {
  REQUESTID: '',
  FACILITYID: '',
  FACILITYNAME: '',
  HOURSPERWEEK: '',
  CRAFT: '',
  LABOURDISTRIBUTIONCODE: '',
  OPERATIONNUMBER: '',
  JUSTIFICATION: '',
  STARTDATE: '',
  ENDDATE: '',
  CREATEDBY: '',
  USER_NAME: '',
  CREATEDON: '',
  STATUS: '',
  COMMENT: ''
},
compactView: true,            // NEW: default like admin
shrinkToFit: false,           // NEW
filterMenu: { open:false, field:'', x:0, y:0 }, // NEW



      facilityData: [],
      trendData: [],
      flexRequests: [],
      userDisplayHeader: '',
      officeName: '',
      fiscalYear: '',
      week:'',

      facilities: [],                       // list of facilities user can access
      bannerMenu: { open:false, x:0, y:0 }, // banner popover placement
      userAceid: '',
      selectedRequest: null,
      weekOptions: [],
showEditModal: false,
editForm: { requestId: null, hours: null, justification: '', startDate: '', endDate: '', wk_start: '', wk_end:'' },
editStatus: '',
editStatusOK: false
    };
  },


computed: {
  filteredRequests() {
    const rows = Array.isArray(this.flexRequests) ? this.flexRequests : [];
    const f = this.filters;
    const match = (val, filter) =>
      !filter || String(val ?? '').toLowerCase().includes(String(filter).toLowerCase());

    return rows.filter((r) => {
      if (!r || typeof r !== 'object') return false;
      const userName = `${r.USER_FNAME || ''} ${r.USER_LNAME || ''}`.trim();

      return (
        match(r.REQUESTID,               f.REQUESTID) &&
        match(r.FACILITYID,              f.FACILITYID) &&
        match(r.FACILITYNAME,            f.FACILITYNAME) &&
        match(r.HOURSPERWEEK,            f.HOURSPERWEEK) &&
        match(r.CRAFT,                   f.CRAFT) &&
        match(r.LABOURDISTRIBUTIONCODE,  f.LABOURDISTRIBUTIONCODE) &&
        match(r.OPERATIONNUMBER,         f.OPERATIONNUMBER) &&
        match(r.JUSTIFICATION,           f.JUSTIFICATION) &&
        match(r.STARTDATE,               f.STARTDATE) &&
        match(r.ENDDATE,                 f.ENDDATE) &&
        match(r.CREATEDBY,               f.CREATEDBY) &&
        match(userName,                  f.USER_NAME) &&
        match(r.CREATEDON,               f.CREATEDON) &&
        (!f.STATUS || String(r.STATUS || '').toLowerCase() === f.STATUS.toLowerCase()) &&
        match(r.COMMENT,                 f.COMMENT)
      );
    });
  }
},





  methods: {
    // Authentication & data fetching (unchanged)
    // async authenticate() {
    //   try {
    //     await axios.get(`/ref/api/v1/authenticate.cfc?method=getUserAuth`).then((res) => {
    //       console.log('response data: ', res.data);
    //       if (res.data) {
    //         this.userDisplayHeader = `${res.data.first} ${
    //           res.data.last
    //         } (${res.data.aceid.toUpperCase()})`;
    //       }
    //     });
    //   } catch (e) {
    //     console.error('Auth error', e);
    //   }
    // },


   
      async authenticate() {
  try {
    const res = await axios.get(`/ref/api/v1/authenticate.cfc?method=getUserAuth`);
    if (res.data) {
      this.userDisplayHeader = `${res.data.first} ${res.data.last} (${res.data.aceid.toUpperCase()})`;
      this.userAceid = res.data.aceid || '';
      if (this.userAceid) await this.getMyFacilities(); // load facilities for banner
    }
  } catch (e) {
    console.error('Auth error', e);
  }
},


async getMyFacilities() {
  try {
    const res = await axios.get(
      `${this.serviceFolder}csaw/access.cfc?method=getMyFacilities&userid=${encodeURIComponent(this.userAceid)}`
    );
    this.facilities = Array.isArray(res.data) ? res.data : [];

    // If server header doesn't give us officeName and there is only one facility, show it
    if ((!this.officeName || !this.officeName.trim()) && this.facilities.length === 1) {
      const f = this.facilities[0];
      this.officeName = f.B_FIN_NAME || this.officeName;
    }
  } catch (e) {
    console.error('Facilities error', e);
    this.facilities = [];
  }
},


async loadWeekOptions() {
  try {
    const res = await axios.get(`${this.serviceFolder}FlexService.cfc?method=getWeekOptions&returnformat=json`);
    if (res.data) {
      const raw = res.data.DATA || res.data.data || [];
      const FMT = [
        'YYYY-MM-DD',
        'YYYY-MM-DD HH:mm',
        'YYYY-MM-DD HH:mm:ss',
        'YYYY-MM-DD HH:mm:ss.SSS',
        'YYYY-MM-DDTHH:mm:ssZ',
        'YYYY-MM-DDTHH:mm:ss.SSSZ',
        'MM/DD/YYYY'
      ];
      const toISO = (v) => {
        if (!v) return '';
        if (typeof v === 'number') {
          const ms = v < 1e12 ? v * 1000 : v;
          return moment(ms).format('YYYY-MM-DD');
        }
        let m = moment(v, FMT, true);
        if (!m.isValid()) m = moment.parseZone(v);
        return m.isValid() ? m.format('YYYY-MM-DD') : '';
      };
      // raw row: [fiscalYear, week, startDate, endDate]
      this.weekOptions = raw.map(row => [row[0], row[1], toISO(row[2]), toISO(row[3])]);
    }
  } catch (e) {
    console.error("Couldn't load weeks", e);
    this.weekOptions = [];
  }
},



asDate(v) {
  if (!v) return null;
  const FMT = [
    'YYYY-MM-DD',
    'YYYY-MM-DD HH:mm',
    'YYYY-MM-DD HH:mm:ss',
    'YYYY-MM-DD HH:mm:ss.SSS',
    'YYYY-MM-DDTHH:mm:ssZ',
    'YYYY-MM-DDTHH:mm:ss.SSSZ'
  ];
  let m = moment(v, FMT, true);
  if (!m.isValid()) m = moment.parseZone(v);
  return m.isValid() ? m.toDate() : null;
},

onEditStartChange() {
  // keep startDate mirrored to wk_start
  this.editForm.startDate = this.editForm.wk_start || '';
  const s = this.asDate(this.editForm.wk_start);
  const e = this.asDate(this.editForm.wk_end);
  if (s && e && e < s) {
    // nudge end up to start
    this.editForm.wk_end   = this.editForm.wk_start;
    this.editForm.endDate  = this.editForm.wk_end;
  }
},

onEditEndChange() {
  // keep endDate mirrored to wk_end
  this.editForm.endDate = this.editForm.wk_end || '';
  const s = this.asDate(this.editForm.wk_start);
  const e = this.asDate(this.editForm.wk_end);
  if (s && e && e < s) {
    // show a quick guard; you can style/message if you want
    this.editForm.wk_end  = this.editForm.wk_start;
    this.editForm.endDate = this.editForm.wk_end;
  }
},



    async fetchDashboard() {
      try {
        const res = await axios.get(
          `${this.serviceFolder}dashboard.cfc?method=getDashboardData`
        );
        this.metrics = res.data;
        this.renderChart();
      } catch (e) {
        console.error('Dashboard load error', e);
      }
    },


    async fetchHeaderData() {
  try {
    const res = await axios.get(
      `${this.serviceFolder}dashboard.cfc?method=getHeaderData`
    );
    this.officeName = res.data.officeName || this.officeName || '';
    this.fiscalYear = res.data.fiscalYear || '';
    this.week       = res.data.week || '';

    // client fallback if needed
    if (!this.fiscalYear || !this.week) {
      const x = this.computeClientFYWeek();
      if (!this.fiscalYear) this.fiscalYear = x.fy;
      if (!this.week)       this.week       = x.week;
    }
  } catch (e) {
    console.error('Header load error', e);
    const x = this.computeClientFYWeek();
    if (!this.fiscalYear) this.fiscalYear = x.fy;
    if (!this.week)       this.week       = x.week;
  }
},


openBannerMenu(evt) {
  const wrap = this.$refs.bannerWrap;
  if (!wrap) return;
  const b = evt.currentTarget.getBoundingClientRect();
  const w = wrap.getBoundingClientRect();
  // position relative to banner
  this.bannerMenu.x = (b.left - w.left);
  this.bannerMenu.y = (b.bottom - w.top) + 6;
  this.bannerMenu.open = true;
  evt.stopPropagation();
},
gotoFacility(f) {
  if (!f) return;

  // update banner text
  this.officeName = f.B_FIN_NAME || this.officeName;
  // optional: if you later add filters on dashboard, set them here
  // e.g., this.filters.FACILITYID = String(f.B_FIN_NBR || '');
  if (this.filters && Object.prototype.hasOwnProperty.call(this.filters, 'FACILITYID')) {
    this.filters.FACILITYID = String(f.B_FIN_NBR || '');
  }
  this.bannerMenu.open = false;
},
_onDocClickBanner(e) {
  if (!this.bannerMenu.open) return;
  const pop = this.$refs.bannerMenuRef;
  if (pop && pop.contains(e.target)) return; // clicks inside popover keep it open
  // ignore clicks on the trigger itself
  if (e.target && e.target.closest && e.target.closest('[title="View all facilities"]')) return;
  this.bannerMenu.open = false;
},



   computeClientFYWeek() {
  const today = new Date();
  const y = today.getFullYear();

  const sept30 = new Date(y, 8, 30); // Sep
  const dow = sept30.getDay();       // 0=Sun..6=Sat
  const backDays = (dow === 6 ? 0 : (dow + 1)); // days since Saturday
  const lastSat = new Date(sept30); lastSat.setDate(sept30.getDate() - backDays);

  let fyStart = lastSat;
  if (today < lastSat) {
    const prevSept30 = new Date(y - 1, 8, 30);
    const prevDow = prevSept30.getDay();
    const prevBack = (prevDow === 6 ? 0 : (prevDow + 1));
    fyStart = new Date(prevSept30); fyStart.setDate(prevSept30.getDate() - prevBack);
  }

  const fy = fyStart.getFullYear() + 1;

  const startUTC = Date.UTC(fyStart.getFullYear(), fyStart.getMonth(), fyStart.getDate());
  const todayUTC = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
  const days = Math.floor((todayUTC - startUTC) / (1000 * 60 * 60 * 24));
  const week = 1 + Math.floor(days / 7);

  return { fy, week };
},


// ADD inside methods:{ ... }
async saveEdit() {
  try {
    const rid = this.editForm.requestId;
    if (!rid) {
      this.editStatusOK = false;
      this.editStatus = 'Missing RequestID.';
      return;
    }

    // Normalize fields only if provided/changed
    const toISO = (v) => (v ? String(v).slice(0, 10) : '');
    const numOrEmpty = (v) => (v === null || v === undefined || v === '' ? '' : String(v));

    const fd = new FormData();
    fd.append('requestId', String(rid));

    // Only append fields the user actually edited; CF won't update missing ones
    if (this.editForm.hours !== null && this.editForm.hours !== undefined && this.editForm.hours !== '') {
      fd.append('hours', numOrEmpty(this.editForm.hours));
    }
    if (this.editForm.justification && this.editForm.justification.trim().length) {
      fd.append('justification', this.editForm.justification.trim());
    }
    if (this.editForm.startDate) {
      fd.append('startDate', toISO(this.editForm.startDate)); // YYYY-MM-DD
    }
    if (this.editForm.endDate) {
      fd.append('endDate', toISO(this.editForm.endDate));     // YYYY-MM-DD
    }

    // Send as multipart/form-data (CF classic path)
    const url = `${this.serviceFolder}dashboard.cfc?method=updateUserRequest&returnformat=json`;
    const res = await axios.post(url, fd, { validateStatus: () => true });

    console.log('updateUserRequest â†’', res.status, res.data);

    // Surface server errors clearly
    if (res.status !== 200 || !res.data || res.data.SUCCESS !== true) {
      const msg = (res.data && (res.data.MESSAGE || res.data.DETAILS)) || `Save failed (HTTP ${res.status})`;
      this.editStatusOK = false;
      this.editStatus = msg;
      alert(msg); // make it obvious in UI
      return;
    }

    // Success â†’ patch the row from the authoritative server payload
    const data = res.data.DATA || {};
    const idx = this.flexRequests.findIndex(r => r.REQUESTID === data.REQUESTID);
    if (idx >= 0) this.flexRequests[idx] = { ...this.flexRequests[idx], ...data };

    this.editStatusOK = true;
    this.editStatus = 'Saved.';
    this.showEditModal = false;
  } catch (e) {
    console.error('saveEdit error', e);
    this.editStatusOK = false;
    this.editStatus = 'Save failed.';
    alert('Save failed. See console for details.');
  }
},

    //New line below
    // async fetchDashboard(){
    //   try {
    //     const res = await axios.get(
    //       `${this.serviceFolder}dashboardservice.cfc?method=getDashboardData`
    //     );

    //     //unpacking everything
    //     const data = res.data;
    //     this.metrics = data.metrics;
    //     this.facilityData = data.facilityData;
    //     this.trendData = data.trendData;

    //     //now draw both charts
    //     this.renderCharts();

    //   }catch (e) {
    //     console.error('Dashboard load error', e);
    //   }

    //   },

    // async fetchFlexRequests() {
    //   try {
    //     const res = await axios.get(
    //       `${this.serviceFolder}dashboardservice.cfc?method=getFlexRequests`
    //     );
    //     console.log('Requests', res.data);
    //     this.flexRequests = res.data;
    //   } catch (e) {
    //     console.error('Error loading request', e);
    //   }
    // },



    async fetchFlexRequests() {
  try {
    const res = await axios.get(`${this.serviceFolder}dashboard.cfc?method=getFlexRequests`);
    const rows = Array.isArray(res.data) ? res.data : [];
    this.flexRequests = rows.filter(r => r && typeof r === 'object');

    // Build status dropdown values
    this.statusOptions = Array.from(
      new Set(this.flexRequests.map(r => r.STATUS).filter(Boolean))
    ).sort();
  } catch (e) {
    console.error('Error loading request', e);
    this.flexRequests = [];
    this.statusOptions = [];
  }
},


    // ---------- chart (includes Modify) ----------
    renderChart() {
      const el = document.getElementById('trendChart');
      if (!el) return;
      const ctx = el.getContext('2d');
      if (this.statusChart) { this.statusChart.destroy(); this.statusChart = null; }

      const { TOTAL, PENDING, APPROVED, MODIFICATION, DECLINED } = this.metrics;

      this.statusChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['TOTAL', 'PENDING', 'APPROVED', 'MODIFY', 'DECLINED'],
          datasets: [{
            label: 'Number of Requests',
            data: [TOTAL, PENDING, APPROVED, MODIFICATION, DECLINED],
            backgroundColor: [
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 99, 132, 0.8)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1,
            borderRadius: 8,
            barPercentage: 0.6,
            categoryPercentage: 0.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Request Trend', font: { size: 18, weight: '500' } },
            legend: { display: false }
          },
          scales: {
            x: { grid: { display: false }, ticks: { font: { size: 13 } } },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)', borderDash: [3, 3] },
              ticks: { stepSize: 10, font: { size: 12 } }
            }
          }
        }
      });
    },



    // Status chip class (same mapping as admin)
statusClass(status) {
  switch ((status || '').toString()) {
    case 'Approved': return 'chip chip-approved';
    case 'Pending':  return 'chip chip-pending';
    case 'Declined': return 'chip chip-declined';
    case 'Modify':   return 'chip chip-modify';
    default:         return 'chip chip-default';
  }
},

// Excel-style filter menu placement (anchor to .tbl-wrap)
openFilterMenu(field, evt) {
  const btn = evt.currentTarget;
  const container = this.$refs.tblWrap;
  if (!btn || !container) return;

  const b = btn.getBoundingClientRect();
  const c = container.getBoundingClientRect();

  // account for shrink scaling
  const scaleX = (c.width  / container.clientWidth)  || 1;
  const scaleY = (c.height / container.clientHeight) || 1;

  let x = (b.left - c.left) / scaleX + container.scrollLeft;
  const y = (b.bottom - c.top) / scaleY + container.scrollTop + 6;

  // keep inside container
  const menuWidth = 260;
  const maxX = container.scrollLeft + container.clientWidth - menuWidth - 8;
  if (x > maxX) x = Math.max(container.scrollLeft, maxX);

  this.filterMenu = { open:true, field, x, y };
  evt.stopPropagation();
},
onStatusChange(e){
  const val = (e && e.target) ? e.target.value : '';
  this.filters.STATUS = String(val || '');
  this.filterMenu.open = false;
},
clearFilter(field){
  this.filters[field] = '';
  this.filterMenu.open = false;
},
onDocClick(e){
  const pop = this.$refs.filterMenuRef;
  if (!pop) { this.filterMenu.open = false; return; }
  if (!pop.contains(e.target)) this.filterMenu.open = false;
},
onContainerScroll(){ if (this.filterMenu.open) this.filterMenu.open = false; },
onWinResize(){ if (this.filterMenu.open) this.filterMenu.open = false; },


/**
 * Fetch 15-day status trends and render the line chart.
 */
// async fetchTrendData15Days() {
//   try {
//     const res = await axios.get(
//       `${this.serviceFolder}dashboardservice.cfc?method=getTrendData15Days`
//     );
//     this.trendData15Days = res.data;
//     this.renderTrendLineChart();
//   } catch (e) {
//     console.error('Trend data load error', e);
//   }
// },


/**
 * Renders a multi-series line chart into #facilityChart
 */
// renderTrendLineChart() {
//   if (!this.trendData15Days.length) return;
//   const labels = this.trendData15Days.map(r => r.DayDate);
//   const totals    = this.trendData15Days.map(r => r.Total);
//   const pending   = this.trendData15Days.map(r => r.Pending);
//   const approved  = this.trendData15Days.map(r => r.Approved);
//   const declined  = this.trendData15Days.map(r => r.Declined);

//   const ctx = document.getElementById('facilityChart').getContext('2d');
//   // destroy old chart if exists
//   if (this.trendLineChart) this.trendLineChart.destroy();

//   this.trendLineChart = new Chart(ctx, {
//     type: 'line',
//     data: {
//       labels,
//       datasets: [
//         {
//           label: 'Total',
//           data: totals,
//           borderWidth: 2,
//           tension: 0.3
//         },
//         {
//           label: 'Pending',
//           data: pending,
//           borderWidth: 2,
//           tension: 0.3
//         },
//         {
//           label: 'Approved',
//           data: approved,
//           borderWidth: 2,
//           tension: 0.3
//         },
//         {
//           label: 'Declined',
//           data: declined,
//           borderWidth: 2,
//           tension: 0.3
//         }
//       ]
//     },
//     options: {
//       responsive: true,
//       plugins: {
//         legend: { position: 'top' },
//         title: {
//           display: false
//         }
//       },
//       scales: {
//         x: {
//           ticks: { maxRotation: 0 },
//           title: { display: true, text: 'Date' }
//         },
//         y: {
//           beginAtZero: true,
//           title: { display: true, text: 'Count' }
//         }
//       }
//     }
//   });
// },


isLocked(req) {
  if (!req) return true;
  // Allow editing while Pending or Modify, regardless of audit history
  if (req.STATUS === 'Pending' || req.STATUS === 'Modify') return false;
  // Otherwise fall back to server-provided lock flag
  return !!(req.LOCKED === 1 || req.LOCKED === true);
},


// openEdit(req) {
//   try {
//     if (!req) return;
//     if (this.isLocked(req)) return;

//     // show the modal first so even if data massaging fails, user sees something
//     this.showEditModal = true;

//     const numOrNull = (v) => (v === null || v === undefined || v === '') ? null : Number(v);
//     const toDate10   = (v) => (v && typeof v === 'string') ? v.slice(0, 10) : (v || '');

//     // keep a reference for Save
//     this.selectedRequest = req;

//     // initialize edit form defensively
//     this.editForm = {
//       requestId:     req.REQUESTID,
//       hours:         numOrNull(req.HOURSPERWEEK) ?? 0,
//       justification: (req.JUSTIFICATION || ''),
//       startDate:     toDate10(req.STARTDATE),
//       endDate:       toDate10(req.ENDDATE)
//     };

//     // clear any old status messages
//     this.editStatus   = '';
//     this.editStatusOK = false;

//     // focus first input after modal mounts (optional)
//     this.$nextTick(() => {
//       const first = document.querySelector('input[type="number"], textarea');
//       if (first) first.focus();
//     });
//   } catch (e) {
//     console.error('openEdit error:', e);
//     this.editStatus   = 'Unable to open editor.';
//     this.editStatusOK = false;
//     // ensure modal is visible even if something threw
//     this.showEditModal = true;
//   }
// },


openEdit(req) {
  try {
    if (!req) return;
    if (this.isLocked(req)) return;

    this.showEditModal = true;

    const numOrNull = (v) => (v === null || v === undefined || v === '') ? null : Number(v);
    const toDate10  = (v) => (v && typeof v === 'string') ? v.slice(0, 10) : (v || '');

    this.selectedRequest = req;

    this.editForm = {
      requestId:     req.REQUESTID,
      hours:         numOrNull(req.HOURSPERWEEK) ?? 0,
      justification: (req.JUSTIFICATION || ''),
      startDate:     toDate10(req.STARTDATE), // existing ISO
      endDate:       toDate10(req.ENDDATE),   // existing ISO
      wk_start:      toDate10(req.STARTDATE), // NEW: seed the selects to match
      wk_end:        toDate10(req.ENDDATE)    // NEW
    };

    this.editStatus   = '';
    this.editStatusOK = false;

    this.$nextTick(() => {
      const first = document.querySelector('input[type="number"], textarea');
      if (first) first.focus();
    });
  } catch (e) {
    console.error('openEdit error:', e);
    this.editStatus   = 'Unable to open editor.';
    this.editStatusOK = false;
    this.showEditModal = true;
  }
},






// onEditClick(req) {
//   // Quick visibility/log to prove the handler is firing
//   try { console.log('Edit clicked:', req?.REQUESTID, 'locked?', this.isLocked(req)); } catch(_) {}

//   // Call your existing logic
//   this.openEdit(req);

//   // Safety net: even if openEdit hit a minor issue, ensure the modal shows
//   if (!this.showEditModal) {
//     this.showEditModal = true;
//   }
// },

async onEditClick(req) {
  try { console.log('Edit clicked:', req?.REQUESTID, 'locked?', this.isLocked(req)); } catch(_){}
  if (!this.weekOptions || !this.weekOptions.length) {
    await this.loadWeekOptions();
  }
  this.openEdit(req);
  if (!this.showEditModal) this.showEditModal = true;
},





confirmDelete(req) {
  if (this.isLocked(req)) return;
  const ok = window.confirm(`Delete request #${req.REQUESTID}? This cannot be undone.`);
  if (!ok) return;
  this.deleteRequest(req);
},

async deleteRequest(req) {
  const fd = new FormData();
  fd.append('requestId', req.REQUESTID);

  try {
    const res = await axios.post(
      `${this.serviceFolder}dashboard.cfc?method=deleteUserRequest&returnformat=json`,
      fd,
      { validateStatus: () => true }
    );

    if (res.status === 200 && res.data && res.data.SUCCESS) {
      this.flexRequests = this.flexRequests.filter(r => r.REQUESTID !== req.REQUESTID);
    } else {
      alert(res.data?.MESSAGE || `Delete failed (HTTP ${res.status})`);
    }
  } catch (err) {
    console.error(err);
    alert('Delete failed.');
  }
},



    exportTableToCSV() {
      // CSV Headers
      const headers = ['ID', 'Facility', 'Hours', 'Start', 'End', 'By', 'On'];

      // Extract data from flexRequests array
      const rows = this.flexRequests.map((req) => [
        req.REQUESTID,
        req.FACILITYID,
        req.HOURSPERWEEK,
        req.STARTDATE,
        req.ENDDATE,
        req.CREATEDBY,
        req.CREATEDON
      ]);

      // Convert to CSV format
      const csvContent = [
        headers.join(','), // header row
        ...rows.map((row) =>
          row
            .map((cell) => {
              const text = String(cell).replace(/"/g, '""');
              return `"${text}"`;
            })
            .join(',')
        )
      ].join('\r\n');

      // Create and trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const downloadLink = document.createElement('a');
      downloadLink.href = url;
      downloadLink.setAttribute('download', 'flex-time-requests.csv');
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
      URL.revokeObjectURL(url);
    }
  },
  mounted() {

    document.addEventListener('click', this._onDocClickBanner);
      document.addEventListener('click', this.onDocClick);  



    this.fetchHeaderData(); // ensure banner shows FY/Week on load

    console.clear();
    this.authenticate();
    this.loadWeekOptions();
    this.fetchDashboard();
    this.fetchFlexRequests();

     // keep popover sane on scroll/resize (NEW)
  const cont = this.$refs.tblWrap;
  if (cont) cont.addEventListener('scroll', this.onContainerScroll, { passive:true });
  window.addEventListener('resize', this.onWinResize, { passive:true });

  window.addEventListener('error', (e) => console.error('GlobalError:', e.error || e.message));
window.addEventListener('unhandledrejection', (e) => console.error('UnhandledRejection:', e.reason));
  },

  beforeUnmount() {
  document.removeEventListener('click', this._onDocClickBanner);

      document.removeEventListener('click', this.onDocClick);
const cont = this.$refs.tblWrap;
if (cont) cont.removeEventListener('scroll', this.onContainerScroll);
window.removeEventListener('resize', this.onWinResize);

},

}).mount('#dashboardApp');


                 


    
