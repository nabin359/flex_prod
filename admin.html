<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flex Time Admin Dashboard</title>

  <!-- Tailwind JIT -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Axios, Vue (ESM), Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Global CSS -->
  <link rel="stylesheet" href="/ref/styles/global.css" />

   <style>
    body { margin: 0; background: #f1f5f9; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* Header bar */
    header {
      position: fixed; top: 0; left: 0; right: 0;
      background: #fff; border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0,0,0,.05); z-index: 50;
    }
    main { padding-top: 5rem; }

    .usps-blue { background-color: #3B6E8F; }

    /* Card look */
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }

    /* Chart height compact so Summary + Chart are visible together */
    .chart-wrap { height: 14rem; }

    /* Table improvements */
    .tbl-wrap { overflow: auto; position: relative }
    table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    thead th { position: sticky; top: 0; z-index: 1; }
    thead th .th-inner { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    thead th button.filter-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width: 22px; height: 22px; border-radius: 6px;
      background: rgba(255,255,255,0.12); color: #fff; border: 1px solid rgba(255,255,255,0.28);
    }
    thead th button.filter-btn:hover { background: rgba(255,255,255,0.2); }

    thead th, tbody td { padding: .55rem .65rem; }
    tbody tr:nth-child(odd) { background: #fbfdff; }
    tbody tr:hover { background: #f5f9ff; }

    /* Column widths (helps fit without horizontal scroll) */
    th.col-id,          td.col-id          { width: 70px; }
    th.col-facility,    td.col-facility    { width: 70px; }
    th.col-area,        td.col-area        { width: 120px; }   /* kept for consistency even if hidden in this view */
    th.col-cluster,     td.col-cluster     { width: 140px; }
    th.col-mpoo,        td.col-mpoo        { width: 70px; }
    th.col-facname,     td.col-facname     { width: 140px; }
    th.col-hours,       td.col-hours       { width: 80px; }
    th.col-craft,       td.col-craft       { width: 100px; }
    th.col-ldc,         td.col-ldc         { width: 100px; }
    th.col-opnum,       td.col-opnum       { width: 100px; }
    th.col-just,        td.col-just        { width: 260px; }
    th.col-start,       td.col-start       { width: 100px; }
    th.col-end,         td.col-end         { width: 100px; }
    th.col-userid,      td.col-userid      { width: 100px; }
    /* th.col-username,    td.col-username    { width: 170px; } */
    th.col-on,          td.col-on          { width: 140px; }
    th.col-status,      td.col-status      { width: 130px; }
    th.col-comment,     td.col-comment     { width: 200px; }
    th.col-chby,        td.col-chby        { width: 100px; }
    th.col-chdt,        td.col-chdt        { width: 140px; }
    th.col-actions,     td.col-actions     { width: 150px; }

    .cell-ellipsis { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Status chips */
    .chip { display:inline-block; padding: .2rem .5rem; border-radius: 999px; font-size: .75rem; font-weight: 600; }
    .chip-pending { background:#dbeafe; color:#1e3a8a; }
    .chip-approved{ background:#dcfce7; color:#14532d; }
    .chip-declined{ background:#fee2e2; color:#7f1d1d; }
    .chip-modify  { background:#fef3c7; color:#92400e; }
    .chip-default { background:#f3f4f6; color:#111827; }

    /* Excel-style filter popover */
    .filter-pop {
      position: absolute; z-index: 60;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
      width: 260px; padding: 12px;
      animation: pop .12s ease;
    }
    .filter-pop h4 { font-size: 12px; font-weight: 700; margin: 2px 0 8px; color: #374151; letter-spacing:.02em; }
    .filter-pop .row { display:flex; gap:8px; margin-top:10px; }
    @keyframes pop { from { transform: translateY(-3px); opacity:0; } to { transform: translateY(0); opacity:1; } }

    /* Compact & shrink toggles */
    .compact table { font-size: 12px; }
    .shrink { transform: scale(0.93); transform-origin: top left; width: 107.5%; }

    /* Glassy overlay for modal backdrop */
    .glass-overlay {
      background: rgba(0, 0, 0, 0.28);
      backdrop-filter: blur(4px) saturate(120%);
      -webkit-backdrop-filter: blur(4px) saturate(120%);
    }

    /* Themed modal shell that blends with dashboard */
    .modal-card {
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      border: 1px solid #e5e7eb;
    }
    .modal-head {
      background: linear-gradient(135deg, #3B6E8F 0%, #2f5b73 100%);
      color: #fff;
    }
    .modal-head h3 { letter-spacing: .2px; }

    /* Subtle divider tone to match theme */
    .modal-divider {
      border-top: 1px solid rgba(59,110,143,.15);
    }

    /* Approve/Decline bar sticks and blends */
    .modal-actions {
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(2px);
    }

    /* Toast (small success popover) */
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1000;
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      color: #0f172a;
      display: none;
    }
    .toast.show { display: inline-flex; align-items: center; gap: 8px; }
    .toast-success { background: #dcfce7; border: 1px solid #16a34a33; }
    .toast-error   { background: #fee2e2; border: 1px solid #ef444433; }
    .toast-info    { background: #e0f2fe; border: 1px solid #38bdf833; }

    /* Horizontal scroll helpers */
    .hscroll-btn{
      position:absolute; top:50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 9999px;
      background: rgba(255,255,255,0.98);
      border: 1px solid #e5e7eb;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      z-index: 9999;
      cursor: pointer;
    }
    .hscroll-btn.left{ left: 8px; }
    .hscroll-btn.right{ right: 8px; }
    .hscroll-btn:hover{ background:#fff; }
    .hscroll-btn.is-disabled{ opacity:.28; pointer-events:none; }

    .hscroll-fade{
      position:absolute; top:0; bottom:0; width: 36px;
      pointer-events:none; z-index: 9998;
    }
    .hscroll-fade.left{
      left:0;
      background: linear-gradient(to right, rgba(255,255,255,1), rgba(255,255,255,0));
    }
    .hscroll-fade.right{
      right:0;
      background: linear-gradient(to left, rgba(255,255,255,1), rgba(255,255,255,0));
    }

    /* >>> NEW: keep the View/Validate column sticky */
    th.sticky-actions, td.sticky-actions {
      position: sticky;
      right: 0;
      z-index: 3;
      background: #fff;
      box-shadow: -3px 0 6px rgba(0,0,0,.06);
    }
    thead th.sticky-actions {
      z-index: 4;
      background: #3B6E8F;
      color: #fff;
    }

    [v-cloak] {
      display: none;
    }
  </style>
</head>

<body>
  <div id="dashboardApp" class="w-full p-6"  v-cloak>
    <!-- Top Nav -->
    <header>
      <div class="w-full px-14 py-0 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <a href="https://eagnmnwbc1db.usps.gov/" class="flex items-center space-x-2 hover:opacity-80 transition">
            <img src="https://eagnmnwbp161f.usps.gov/rework/assets/EIR_logo_color.png" alt="EIR Logo"
              class="h-16 w-16 object-contain" />
            <span class="text-2xl font-semibold text-gray-700">| Workhour Analytics</span>
          </a>
        </div>
        <div class="flex items-center justify-between space-x-6">
          <a href="/ref/toolbox/flex/index.html"
            class="px-4 py-2 bg-[#3B6E8F] text-white rounded-lg font-semibold shadow hover:bg-blue-500 transition">
            + New Flex Request
          </a>
          <div class="flex items-center space-x-4 text-lg text-gray-700 font-medium">
            {{ userDisplayHeader }}
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 w-full">
      <div class="w-full px-6">

        <!-- Breadcrumb -->
        <nav class="text-gray-600 text-md font-semibold rounded-2xl card p-6 mb-6 -mt-12" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
            <li>
              <a href="https://eagnmnwbp161f.usps.gov/" class="flex items-center hover:text-blue-700 transition">
                <svg class="w-4 h-4 mr-1 text-gray-700" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 12l9-9 9 9M9 21V10h6v11" />
                </svg>
                WEMS Home
              </a>
            </li>
            <li>
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 5l7 7-7 7" />
              </svg>
            </li>
            <li class="text-blue-800 font-semibold">Flex Time Admin Dashboard</li>
          </ol>
        </nav>

        <!-- Info Banner with Facility Popover -->
        <div class="usps-blue text-white rounded-xl shadow-md p-8 mb-6 relative" ref="bannerWrap">
          <h1 class="text-3xl font-bold tracking-tight">Flex Time Request</h1>

          <p class="mt-2 text-base flex flex-wrap items-center gap-2">
            <span class="font-semibold">Office/Facility:</span>
            <span class="font-semibold">{{ officeName || 'â€”' }}</span>

            <!-- Show picker when more than 1 facility -->
            <button v-if="facilities.length > 1" type="button"
              class="ml-2 inline-flex items-center px-2 py-1 text-xs font-semibold rounded bg-white/15 hover:bg-white/25"
              @click.stop="openBannerMenu($event)" title="View all facilities">
              View all ({{ facilities.length }})
            </button>

            <span class="hidden sm:inline">&nbsp;&nbsp;â€¢&nbsp;&nbsp;</span>
            <span class="font-semibold">Fiscal Year:</span> <span class="font-semibold">{{ fiscalYear || 'â€”' }}</span>

            <span class="hidden sm:inline">&nbsp;&nbsp;â€¢&nbsp;&nbsp;</span>
            <span class="font-semibold">Week:</span> <span class="font-semibold">{{ week || 'â€”' }}</span>
          </p>

          <!-- Facilities popover -->
          <div v-if="bannerMenu.open" ref="bannerMenuRef"
            class="absolute z-[100] bg-white text-gray-800 rounded-lg shadow-2xl border border-gray-200 w-80 p-3"
            :style="{ top: bannerMenu.y + 'px', left: bannerMenu.x + 'px' }">
            <div class="text-sm font-semibold text-gray-600 mb-2">Your Facilities</div>
            <ul class="max-h-64 overflow-auto divide-y divide-gray-100">
              <li v-for="f in facilities" :key="f.B_FIN_NBR" class="py-2">
                <button class="w-full text-left hover:bg-gray-50 rounded px-2 py-1" @click="gotoFacility(f)"
                  :title="(f.B_FIN_NAME || '') + ' (' + (f.B_FIN_NBR || '') + ')'">
                  <div class="text-sm font-medium">{{ f.B_FIN_NAME }}</div>
                  <div class="text-xs text-gray-500">FIN: {{ f.B_FIN_NBR }}</div>
                </button>
              </li>
            </ul>
            <div class="mt-2 text-right">
              <button class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200"
                @click="bannerMenu.open=false">Close</button>
            </div>
          </div>
        </div>

        <!-- Summary KPIs -->
        <section class="card p-6 mb-6">
          <h2 class="text-lg font-semibold text-gray-700 mb-4">Summary</h2>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Total Requests</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.TOTAL) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Pending</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.PENDING) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Approved</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.APPROVED) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Request Modification</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.MODIFICATION) }}</div>
            </div>
            <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-sm">Declined</div>
              <div class="text-2xl font-bold">{{ fmt(metrics.DECLINED) }}</div>
            </div>
          </div>
        </section>

        <!-- Status Chart -->
        <div class="card p-6 mb-8">
          <h2 class="text-xl font-semibold text-blue-800 mb-2">Request Status Chart</h2>
          <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
        </div>

           <!-- Requests Table -->
        <div class="card p-4 mb-8" :class="[{ compact: compactView }, { shrink: shrinkToFit }]">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center justify-between gap-3">
            <h2 class="text-xl font-semibold text-blue-800">Flex-Time Requests</h2>
              <label class="text-sm flex item-center self-end">
                  <b>YEAR:</b>&nbsp;
                  <select v-model.number="flexTimeSelectedYear" class="border rounded text-sm" @change="handleFlexYearChange">
                    <option v-for="opt in flexTimeYears" :key="opt" :value="opt">{{ opt }}</option>
                  </select>
                </label>
              </div>
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" v-model="compactView"/>
                <span>Compact view</span>
              </label>
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" v-model="shrinkToFit"/>
                <span>Shrink to fit</span>
              </label>
              <button @click="exportTableToCSV"
                      class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
                ðŸ“¥ Export to CSV
              </button>
            </div>
          </div>

          <div class="tbl-wrap relative" ref="tblWrap">
            <table>
              <thead>
                <tr style="background:#3B6E8F; color:#fff;">
                  <th class="col-id">
                    <div class="th-inner">
                      <span class="font-semibold">ID</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('REQUESTID', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-facility">
                    <div class="th-inner">
                      <span class="font-semibold">Facility</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('FACILITYID', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-facname">
                    <div class="th-inner">
                      <span class="font-semibold">Facility Name</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('FACILITYNAME', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-hours">
                    <div class="th-inner">
                      <span class="font-semibold">Hours</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('HOURSPERWEEK', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-craft">
                    <div class="th-inner">
                      <span class="font-semibold">Craft</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('CRAFT', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-ldc">
                    <div class="th-inner">
                      <span class="font-semibold">Labor Distribution Code</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('LABOURDISTRIBUTIONCODE', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-opnum">
                    <div class="th-inner">
                      <span class="font-semibold">Operation Number</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('OPERATIONNUMBER', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-start">
                    <div class="th-inner">
                      <span class="font-semibold">Start</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('STARTDATE', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-end">
                    <div class="th-inner">
                      <span class="font-semibold">End</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('ENDDATE', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-userid">
                    <div class="th-inner">
                      <span class="font-semibold">USER ID</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('CREATEDBY', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <!-- <th class="col-username">
                    <div class="th-inner">
                      <span class="font-semibold">User Name</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('USER_NAME', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th> -->

                  <th class="col-on">
                    <div class="th-inner">
                      <span class="font-semibold">On</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('CREATEDON', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <th class="col-status">
                    <div class="th-inner">
                      <span class="font-semibold">Status</span>
                      <button class="filter-btn" @click.stop="openFilterMenu('STATUS', $event)" title="Filter">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
                      </button>
                    </div>
                  </th>

                  <!-- Sticky View/Validate column -->
                  <th class="col-actions sticky-actions"><span class="font-semibold">View Record</span></th>
                </tr>
              </thead>

              <tbody>
                <!-- switched to paginatedRequests -->
                <tr v-for="req in paginatedRequests" :key="req.REQUESTID" class="border-t">
                  <td class="col-id">{{ req.REQUESTID }}</td>
                  <td class="col-facility">{{ req.FACILITYID }}</td>
                  <td class="col-facname cell-ellipsis" :title="req.FACILITYNAME">{{ req.FACILITYNAME }}</td>

                  <!-- removed: Area / Cluster / MPOO / Justification / Comment -->

                  <td class="col-hours">{{ req.HOURSPERWEEK }}</td>
                  <td class="col-craft">{{ req.CRAFT }}</td>
                  <td class="col-ldc">{{ req.LABOURDISTRIBUTIONCODE }}</td>
                  <td class="col-opnum">{{ req.OPERATIONNUMBER }}</td>
                  <td class="col-start">{{ req.STARTDATE }}</td>
                  <td class="col-end">{{ req.ENDDATE }}</td>
                  <td class="col-userid">{{ req.CREATEDBY }}</td>
                  <!-- <td class="col-username">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td> -->
                  <td class="col-on">{{ req.CREATEDON }}</td>
                  <td class="col-status">
                    <span :class="statusClass(req.STATUS)">{{ req.STATUS }}</span>
                  </td>

                  <!-- Sticky action button -->
                  <td class="col-actions sticky-actions">
                    <button
                      @click.prevent="selectRequest(req)"
                      class="px-3 py-1.5 bg-[#17a2b8] text-white text-sm rounded-md shadow hover:bg-blue-500 transition">
                      View / Validate
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination footer -->
            <div class="mt-3 flex flex-wrap items-center justify-between gap-3">
              <!-- Range text -->
              <div class="text-sm text-gray-600">
                Showing <span class="font-semibold">{{ totalRows ? (firstRowIndex + 1) : 0 }}</span>
                â€“
                <span class="font-semibold">{{ lastRowIndex }}</span>
                of
                <span class="font-semibold">{{ totalRows }}</span>
              </div>

              <!-- Controls -->
              <div class="flex items-center gap-2">
                <label class="text-sm flex items-center gap-1">
                  Rows:
                  <select v-model.number="pageSize" class="border rounded px-2 py-1 text-sm">
                    <option :value="10">10</option>
                    <option :value="25">25</option>
                    <option :value="50">50</option>
                    <option :value="100">100</option>
                  </select>
                </label>

                <button
                  class="px-3 py-1.5 rounded border text-sm disabled:opacity-50"
                  :disabled="currentPage <= 1"
                  @click="prevPage"
                  aria-label="Previous page">
                  â€¹ Prev
                </button>

                <div class="text-sm">
                  Page <span class="font-semibold">{{ currentPage }}</span>
                  of <span class="font-semibold">{{ totalPages }}</span>
                </div>

                <button
                  class="px-3 py-1.5 rounded border text-sm disabled:opacity-50"
                  :disabled="currentPage >= totalPages"
                  @click="nextPage"
                  aria-label="Next page">
                  Next â€º
                </button>
              </div>
            </div>

            <!-- Excel-style filter popover -->
            <div v-if="filterMenu.open"
                 class="filter-pop"
                 :style="{ left: filterMenu.x + 'px', top: filterMenu.y + 'px' }"
                 ref="filterMenuRef">
              <h4>Filter: {{ filterMenu.field }}</h4>

              <!-- STATUS uses dropdown -->
              <template v-if="filterMenu.field === 'STATUS'">
                <select
                  class="w-full border rounded px-2 py-1 text-sm"
                  :value="filters.STATUS"
                  @change="onStatusChange($event)">
                  <option value="">(All)</option>
                  <option v-for="opt in statusOptions" :key="opt" :value="opt">{{ opt }}</option>
                </select>
              </template>

              <!-- All other columns: contains text -->
              <template v-else>
                <input
                  v-model="filters[filterMenu.field]"
                  class="w-full border rounded px-2 py-1 text-sm"
                  placeholder="Type to filterâ€¦">
              </template>

              <div class="row">
                <button class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200"
                        @click.stop="clearFilter(filterMenu.field)">
                  Clear
                </button>
                <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                        @click.stop="filterMenu.open=false">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal (existing functionality preserved) -->
        <transition name="modal">
          <div v-if="showingModal" class="fixed inset-0 glass-overlay flex items-center justify-center z-50">
            <div class="relative modal-card w-full max-w-7xl min-h-[75vh] max-h-[95vh] p-0 transform transition-transform duration-300 scale-100 flex flex-col overflow-hidden">

              <button @click="closeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>

              <div class="modal-head px-12 pt-10 pb-5">
                <h3 class="text-2xl font-semibold">Request #{{ selectedRequest?.REQUESTID }}</h3>
              </div>
              <div class="modal-divider"></div>

              <div class="flex-1 overflow-y-auto px-12 pb-6">
                <div class="mb-4">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" v-model="isEditing" class="rounded">
                    <span>Enable editing of request fields</span>
                  </label>
                </div>

                <!-- Read View -->
                <div v-if="!isEditing" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Facility:</strong> {{ selectedRequest?.FACILITYID }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Facility Name:</strong> {{ selectedRequest?.FACILITYNAME }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Craft:</strong> {{ selectedRequest?.CRAFT }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Hours / Week:</strong> {{ selectedRequest?.HOURSPERWEEK }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>LDC:</strong> {{ selectedRequest?.LABOURDISTRIBUTIONCODE }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm"><p><strong>Operation #:</strong> {{ selectedRequest?.OPERATIONNUMBER }}</p></div>
                  <div class="border rounded-md p-4 bg-white shadow-sm md:col-span-3">
                    <p><strong>Dates:</strong> {{ selectedRequest?.STARTDATE }} â†’ {{ selectedRequest?.ENDDATE }}</p>
                  </div>
                  <div class="md:col-span-3 border rounded-md p-4 bg-white shadow-sm">
                    <p><strong>Justification:</strong></p>
                    <p class="whitespace-pre-line">{{ selectedRequest?.JUSTIFICATION }}</p>
                  </div>
                  <div class="md:col-span-3" v-if="selectedRequest?.ATTACHMENTURL">
                    <p><strong>Attachment:</strong></p>
                    <a :href="selectedRequest.ATTACHMENTURL" target="_blank" class="text-blue-600 underline"
                       :download="selectedRequest.ATTACHMENTNAME || null">
                      Download {{ selectedRequest.ATTACHMENTNAME || 'attachment' }}
                    </a>
                  </div>
                </div>

                <!-- Edit View -->
                <div v-else class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div><label class="font-semibold">Facility</label><input v-model="editForm.facilityID" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">Craft</label>
                    <select v-model="editForm.craft" class="w-full border rounded p-2">
                      <option>clerk</option>
                      <option>mailhandler</option>
                    </select>
                  </div>
                  <div><label class="font-semibold">Hours / Week</label><input type="number" step="0.01" v-model.number="editForm.hoursPerWeek" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">LDC</label><input v-model.number="editForm.ldc" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">Operation #</label><input v-model="editForm.operationNumber" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">Start Date</label><input type="date" v-model="editForm.startDate" class="w-full border rounded p-2"/></div>
                  <div><label class="font-semibold">End Date</label><input type="date" v-model="editForm.endDate" class="w-full border rounded p-2"/></div>
                  <div class="md:col-span-3">
                    <label class="font-semibold">Justification</label>
                    <textarea v-model="editForm.justification" rows="4" class="w-full border rounded p-2"></textarea>
                  </div>
                  <div class="md:col-span-3" v-if="selectedRequest?.ATTACHMENTURL">
                    <strong>Attachment:</strong>
                    <a :href="selectedRequest.ATTACHMENTURL" target="_blank" class="text-blue-600 underline">Download</a>
                  </div>
                </div>

                <!-- Quick Comment -->
                <div class="mb-4">
                  <label class="block font-semibold mb-1">Quick Comment</label>
                  <select class="w-full border rounded p-2" v-model="selectedComment" @change="onQuickCommentChange">
                    <option value="" disabled>â€” Select a quick comment â€”</option>
                    <option value="NO SUPPORTING DOCUMENTATION">NO SUPPORTING DOCUMENTATION</option>
                    <option value="MULTIPLE REQUESTS">MULTIPLE REQUESTS</option>
                    <option value="SPACE CONSTRAINTS">SPACE CONSTRAINTS</option>
                    <option value="NOT UNIQUE">NOT UNIQUE</option>
                    <option value="ALREADY COVERED">ALREADY COVERED</option>
                    <option value="SCF/HUB">SCF/HUB</option>
                    <option value="DROP SHIPMENT ISSUES">DROP SHIPMENT ISSUES</option>
                    <option value="LEVEL 18">LEVEL 18</option>
                    <option value="SCHEDULING/ COMPLEMENT ISSUES">SCHEDULING/ COMPLEMENT ISSUES</option>
                    <option value="OTHER">Other (type your own)</option>
                  </select>
                </div>

                <div v-show="selectedComment" class="mb-4">
                  <label class="block font-semibold">Comment</label>
                  <textarea v-model="actionComment" rows="4" ref="otherCommentBox" class="w-full border rounded p-2" placeholder="Type your custom noteâ€¦"></textarea>
                </div>

                <div v-if="processStatus" class="text-green-600 mt-2">{{ processStatus }}</div>
              </div>

              <div class="sticky bottom-0 bg-white border-t px-12 py-4 flex flex-wrap gap-2 justify-start">
                <button @click="updateStatus('Approved')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Approve</button>
                <button @click="updateStatus('Declined')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Decline</button>
                <button @click="updateStatus('Modify')" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Request Modification</button>
                <button v-if="isEditing" @click="saveFieldEdits" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Changes</button>
              </div>
            </div>
          </div>
        </transition>
      </div>
    </main>
  </div>

  <!-- Lightweight toast -->
  <div id="ft-toast" class="toast toast-success">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
    <span id="ft-toast-text">Saved.</span>
  </div>

  <!-- Page script -->
  <script type="module" src="/ref/toolbox/flex/admin.js"></script>
</body>

</html>
