<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flex Time Dashboard</title>

  <!-- Tailwind JIT -->
  <script src="/ref/packages/tailwindcss.browser.4.min.js"></script>
  <!-- Flowbite -->
  <link href="/ref/styles/flowbite.min.css" rel="stylesheet" />
  <script src="/ref/packages/flowbite.min.js"></script>

  <!-- Axios, Moment, Numeral -->
  <script src="/ref/packages/axios.min.js"></script>
  <script src="/ref/packages/moment.min.js" crossorigin="anonymous"></script>
  <script src="/ref/packages/numeral.min.js" crossorigin="anonymous"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js" crossorigin="anonymous"></script> -->

  <link rel="stylesheet" href="/ref/styles/global.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      background: #f1f5f9;
      /* font-family: sans-serif; */
    }

    /* #dashboardApp {

      width: 100%;
      max-width: 100%;
      margin-left: 0;
      margin-right:0;

    } */
    /* Fixed header bar */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      z-index: 50;
    }

    /* Card look */
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }

    /* Chart height compact so Summary + Chart are visible together */
    .chart-wrap { height: 14rem; }

    /* Ensure main content sits below header */
    main {
      padding-top: 5rem;
    }

    /* USPS brand color */
    .usps-blue {
      background-color: #3B6E8F;
    }

    /* Hover on table rows */
    table tbody tr:hover {
      background: #f9fafb;
    }



/* ===== Admin-style table & filter UI ===== */
.tbl-wrap { overflow: auto; position: relative }
table { width:100%; border-collapse: separate; border-spacing: 0; }
thead th { position: sticky; top: 0; z-index: 1; }
thead th .th-inner { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
thead th button.filter-btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:22px; height:22px; border-radius:6px;
  background: rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.28);
}
thead th button.filter-btn:hover{ background: rgba(255,255,255,0.2); }

thead th, tbody td { padding:.55rem .65rem; }
tbody tr:nth-child(odd){ background:#fbfdff; }
tbody tr:hover{ background:#f5f9ff; }

/* Column widths (match admin so headers fit) */
th.col-id,          td.col-id          { width: 70px; }
th.col-facility,    td.col-facility    { width: 110px; }
th.col-facname,     td.col-facname     { width: 220px; }
th.col-hours,       td.col-hours       { width: 90px; }
th.col-craft,       td.col-craft       { width: 120px; }
th.col-ldc,         td.col-ldc         { width: 130px; }
th.col-opnum,       td.col-opnum       { width: 140px; }
th.col-just,        td.col-just        { width: 260px; }
th.col-start,       td.col-start       { width: 120px; }
th.col-end,         td.col-end         { width: 120px; }
th.col-userid,      td.col-userid      { width: 140px; }
th.col-username,    td.col-username    { width: 170px; }
th.col-on,          td.col-on          { width: 160px; }
th.col-status,      td.col-status      { width: 130px; }
th.col-comment,     td.col-comment     { width: 260px; }
th.col-actions,     td.col-actions     { width: 150px; }

.cell-ellipsis{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Status chips (same look as admin) */
.chip { display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; font-weight:600; }
.chip-pending { background:#dbeafe; color:#1e3a8a; }
.chip-approved{ background:#dcfce7; color:#14532d; }
.chip-declined{ background:#fee2e2; color:#7f1d1d; }
.chip-modify  { background:#fef3c7; color:#92400e; }
.chip-default { background:#f3f4f6; color:#111827; }

/* Filter popover */
.filter-pop{
  position:absolute; z-index:60;
  background:#fff; border:1px solid #e5e7eb; border-radius:10px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
  width:260px; padding:12px; animation:pop .12s ease;
}
.filter-pop h4{ font-size:12px; font-weight:700; margin:2px 0 8px; color:#374151; letter-spacing:.02em; }
.filter-pop .row{ display:flex; gap:8px; margin-top:10px; }
@keyframes pop{ from{ transform:translateY(-3px); opacity:0; } to{ transform:translateY(0); opacity:1; } }

/* Compact/Shrink */
.compact table { font-size:12px; }
.shrink { transform:scale(0.93); transform-origin:top left; width:107.5%; }


 

    [v-cloak] {
      display: none;
    }




  </style>
</head>

<body>
  <div id="dashboardApp" class="w-full p-6 border-gray-300 rounded-lg" v-cloak>

    <!-- Top Nav -->
    <header>
      <div class="w-full px-14 py-0 flex items-center justify-between">
        <!-- Left: Logo + Title -->
        <div class="flex items-center space-x-2">
          <a href="https://eagnmnwbp161f.usps.gov/" class="flex items-center space-x-2 hover:opacity-80 transition">
            <img src="https://eagnmnwbp161f.usps.gov/rework/assets/EIR_logo_color.png" alt="EIR Logo"
              class="h-16 w-16 object-contain">
            <span class="text-2xl font-semibold text-gray-700">| Workhour Analytics</span>
          </a>
        </div>

        <!-- Right: New Request + User -->
        <div class="flex items-center justify-between space-x-6">
          <a href="/ref/toolbox/flex/index.html"
            class="px-4 py-2 bg-[#3B6E8F] text-white rounded-lg font-semibold shadow hover:bg-blue-500 transition">
            + New Flex Request
          </a>
          <div v-if="userDisplayHeader" class="flex items-center space-x-4 text-lg text-gray-700 font-medium">
            {{ userDisplayHeader }}
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 w-full">
      <div class="w-full px-6">

        <!-- Breadcrumb -->
        <nav class="text-gray-600 text-md font-semibold rounded-2xl card shadow-md p-6 mb-6 -mt-12" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
            <li>
              <a href="https://eagnmnwbp161f.usps.gov/" class="flex items-center hover:text-blue-700 transition">
                <svg class="w-4 h-4 mr-1 text-gray-700" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 12l9-9 9 9M9 21V10h6v11" />
                </svg>
                WEMS Home
              </a>
            </li>
            <li>
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 5l7 7-7 7" />
              </svg>
            </li>
            <li class="text-blue-800 font-semibold">Flex Time Dashboard</li>
          </ol>
        </nav>

        <!-- Info Banner -->
        <!-- <div class="usps-blue text-white rounded-md shadow-md p-10 mb-6">
          <h1 class="text-3xl font-semibold">Flex Time Request</h1>
          <p class="text-md mt-1" v-if="officeName && fiscalYear && week">
            Office/Facility: {{ officeName }}
            <span class="hidden sm:inline"> - </span>
            Fiscal Year: {{ fiscalYear }}, Week: {{ week }}
          </p>
        </div> -->

        <!-- Info Banner (identical to admin) -->
      <div class="usps-blue text-white rounded-xl shadow-md p-8 mb-6 relative" ref="bannerWrap">
        <h1 class="text-3xl font-bold tracking-tight">Flex Time Request</h1>

        <p class="mt-2 text-base flex flex-wrap items-center gap-2">
          <span class="font-semibold">Office/Facility:</span>
          <span class="font-semibold">{{ officeName || 'â€”' }}</span>

          <!-- Show the picker when user has more than 1 facility -->
          <button
            v-if="facilities.length > 1"
            type="button"
            class="ml-2 inline-flex items-center px-2 py-1 text-xs font-semibold rounded bg-white/15 hover:bg-white/25"
            @click.stop="openBannerMenu($event)"
            title="View all facilities"
          >
            View all ({{ facilities.length }})
          </button>

          <span class="hidden sm:inline">&nbsp;&nbsp;â€¢&nbsp;&nbsp;</span>
          <span class="font-semibold">Fiscal Year:</span> <span class="font-semibold">{{ fiscalYear || 'â€”' }}</span>

          <span class="hidden sm:inline">&nbsp;&nbsp;â€¢&nbsp;&nbsp;</span>
          <span class="font-semibold">Week:</span> <span class="font-semibold">{{ week || 'â€”' }}</span>
        </p>

        <!-- Facilities popover (anchored to the banner) -->
        <div
          v-if="bannerMenu.open"
          ref="bannerMenuRef"
          class="absolute z-[100] bg-white text-gray-800 rounded-lg shadow-2xl border border-gray-200 w-80 p-3"
          :style="{ top: bannerMenu.y + 'px', left: bannerMenu.x + 'px' }"
        >
          <div class="text-sm font-semibold text-gray-600 mb-2">Your Facilities</div>
          <ul class="max-h-64 overflow-auto divide-y divide-gray-100">
            <li v-for="f in facilities" :key="f.B_FIN_NBR" class="py-2">
              <button
                class="w-full text-left hover:bg-gray-50 rounded px-2 py-1"
                @click="gotoFacility(f)"
                :title="(f.B_FIN_NAME || '') + ' (' + (f.B_FIN_NBR || '') + ')'"
              >
                <div class="text-sm font-medium">{{ f.B_FIN_NAME }}</div>
                <div class="text-xs text-gray-500">FIN: {{ f.B_FIN_NBR }}</div>
              </button>
            </li>
          </ul>
          <div class="mt-2 text-right">
            <button class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200" @click="bannerMenu.open=false">Close</button>
          </div>
        </div>
      </div>






        <!-- Summary -->
        <section class="bg-white rounded-2xl shadow-md p-6 mb-6 border-0 border-blue-700">
          <h2 class="text-lg font-semibold text-gray-700 mb-4">Summary</h2>
          <div class="flex flex-wrap justify-between gap-4">
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Total Requests</div>
              <div class="text-2xl font-bold">{{ metrics.TOTAL }}</div>
            </div>
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Pending</div>
              <div class="text-2xl font-bold">{{ metrics.PENDING }}</div>
            </div>
            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Approved</div>
              <div class="text-2xl font-bold">{{ metrics.APPROVED }}</div>
            </div>

             <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Request Modification</div>
              <div class="text-2xl font-bold">{{ metrics.MODIFICATION }}</div>
            </div>

            <div class="flex-1 min-w-[120px] text-center bg-slate-50 rounded-lg p-3 border border-slate-100">
              <div class="text-gray-500 text-md">Declined</div>
              <div class="text-2xl font-bold">{{ metrics.DECLINED }}</div>
            </div>
          </div>
        </section>

     


         <!-- Single Chart -->
        <div class="card p-6 mb-8">
          <h2 class="text-xl font-semibold text-blue-800 mb-2">Request Status Chart</h2>
          <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
        </div>


            <!-- <div class="bg-white rounded-2xl shadow-md p-6">
      <h2 class="text-xl font-semibold text-blue-800 mb-2">Last 7 Days Trend</h2>
      <canvas id="trendChart" height="150"></canvas> -->

            <!-- Trend Data Table -->
            <!-- <table class="min-w-full table-auto mt-4">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-4 py-2 text-left text-sm font-semibold">Date</th>
            <th class="px-4 py-2 text-left text-sm font-semibold">Count</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="item in trendData" :key="item.date" class="border-t hover:bg-gray-50">
              <td class="px-4 py-2">{{ item.date }}</td>
              <td class="px-4 py-2">{{ item.count }}</td>
            </tr>
          </tbody>
        </table>
      </div> -->





              <!-- Requests Table -->
              <!-- <div class="bg-white rounded-2xl shadow-md p-6 overflow-x-auto mb-8">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-xl font-semibold text-blue-800">All Flex-Time Requests</h2>

                  <button @click="exportTableToCSV"
                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                    ðŸ“¥ Export to Excel
                  </button>



                </div>
                <table class="min-w-full table-auto">
                  <thead class="bg-blue-50">
                    <tr>
                      <th class="px-4 py-2 text-left text-sm font-semibold">ID</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Facility</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Hours</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Craft</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Labour Distribution Code</th>
                      
                      <th class="px-4 py-2 text-left text-sm font-semibold">Operation Number</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Justification</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">Start</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">End</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">USER ID</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">User Name</th>
                      <th class="px-4 py-2 text-left text-sm font-semibold">On</th>
                      
                      <th class="px-4 py-2 text-left text-sm font-semibold">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="req in flexRequests" :key="req.REQUESTID" class="border-t hover:bg-gray-50">
                      <td class="px-4 py-2">{{ req.REQUESTID }}</td>
                      <td class="px-4 py-2">{{ req.FACILITYID }}</td>
                      <td class="px-4 py-2">{{ req.HOURSPERWEEK }}</td>
                      <td class="px-4 py-2">{{ req.CRAFT }}</td>
                      <td class="px-4 py-2">{{ req.LABOURDISTRIBUTIONCODE }}</td>
                      <td class="px-4 py-2">{{ req.OPERATIONNUMBER }}</td>
                      <td class="px-4 py-2">{{ req.JUSTIFICATION }}</td>
                      <td class="px-4 py-2">{{ req.STARTDATE }}</td>
                      <td class="px-4 py-2">{{ req.ENDDATE }}</td>
                      <td class="px-4 py-2">{{ req.CREATEDBY }}</td>
                      <td class="px-4 py-2">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td>
                      <td class="px-4 py-2">{{ req.CREATEDON }}</td>
                      
                      
                    
                      <td class="px-4 py-2">
        <div class="flex items-center gap-2">
          <button
            class="px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed"
            @click.prevent="openEdit(req)"
            :disabled="isLocked(req)"
            title="Edit this request"
          >
            Edit
          </button>

          <button
            class="px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed"
            @click.prevent="confirmDelete(req)"
            :disabled="isLocked(req)"
            title="Delete this request"
          >
            Delete
          </button>
        </div>
        <div v-if="isLocked(req)" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
          Locked by admin
        </div>
      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

            </div>
          </main>

          
          
          


      <div v-if="showEditModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Edit Request #{{ editForm.requestId }}</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
              <label class="font-semibold">Craft</label>
              <select v-model="editForm.craft" class="w-full border rounded p-2">
                <option>clerk</option>
                <option>mailhandler</option>
              </select>
            </div>
            
            <div>
              <label class="font-semibold">LDC</label>
              <input v-model.number="editForm.ldc" class="w-full border rounded p-2" />
            </div>
            <div>
              <label class="font-semibold">Operation #</label>
              <input v-model="editForm.operationNumber" class="w-full border rounded p-2" />
            </div>

            <div>
              <label class="block text-sm font-medium">Hours / Week</label>
              <input type="number" step="0.01" min="0.01" max="100" v-model.number="editForm.hours" class="mt-1 w-full border rounded p-2">
            </div>
            <div>
              <label class="block text-sm font-medium">Start Date</label>
              <input type="date" v-model="editForm.startDate" class="mt-1 w-full border rounded p-2">
            </div>
            <div>
              <label class="block text-sm font-medium">End Date</label>
              <input type="date" v-model="editForm.endDate" class="mt-1 w-full border rounded p-2">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium">Justification</label>
              <textarea rows="4" v-model="editForm.justification" class="mt-1 w-full border rounded p-2"></textarea>
            </div>
          </div>

          <div class="flex items-center justify-end gap-2 mt-6">
            <button class="px-4 py-2 rounded border" @click="showEditModal=false">Cancel</button>
            <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @click="saveEdit">Save</button>
          </div>

          <p v-if="editStatus" class="mt-3 text-sm" :class="editStatusOK ? 'text-green-700':'text-red-700'">
            {{ editStatus }}
          </p>
        </div> -->



<div class="card p-4 mb-8" :class="[{ compact: compactView }, { shrink: shrinkToFit }]">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-xl font-semibold text-blue-800">All Flex-Time Requests</h2>
    <div class="flex items-center gap-3">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="compactView"/>
        <span>Compact view</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="shrinkToFit"/>
        <span>Shrink to fit</span>
      </label>

      <button @click="exportTableToCSV"
              class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
        ðŸ“¥ Export to CSV
      </button>
    </div>
  </div>

  <div class="tbl-wrap relative" ref="tblWrap">
    <table>
      <thead>
        <tr style="background:#3B6E8F; color:#fff;">
          <th class="col-id">
            <div class="th-inner">
              <span class="font-semibold">ID</span>
              <button class="filter-btn" @click.stop="openFilterMenu('REQUESTID', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-facility">
            <div class="th-inner">
              <span class="font-semibold">Facility</span>
              <button class="filter-btn" @click.stop="openFilterMenu('FACILITYID', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <!-- NEW: Facility Name -->
          <th class="col-facname">
            <div class="th-inner">
              <span class="font-semibold">Facility Name</span>
              <button class="filter-btn" @click.stop="openFilterMenu('FACILITYNAME', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <th class="col-hours">
            <div class="th-inner">
              <span class="font-semibold">Hours</span>
              <button class="filter-btn" @click.stop="openFilterMenu('HOURSPERWEEK', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-craft">
            <div class="th-inner">
              <span class="font-semibold">Craft</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CRAFT', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-ldc">
            <div class="th-inner">
              <span class="font-semibold">LDC</span>
              <button class="filter-btn" @click.stop="openFilterMenu('LABOURDISTRIBUTIONCODE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-opnum">
            <div class="th-inner">
              <span class="font-semibold">Operation #</span>
              <button class="filter-btn" @click.stop="openFilterMenu('OPERATIONNUMBER', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-just">
            <div class="th-inner">
              <span class="font-semibold">Justification</span>
              <button class="filter-btn" @click.stop="openFilterMenu('JUSTIFICATION', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-start">
            <div class="th-inner">
              <span class="font-semibold">Start</span>
              <button class="filter-btn" @click.stop="openFilterMenu('STARTDATE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-end">
            <div class="th-inner">
              <span class="font-semibold">End</span>
              <button class="filter-btn" @click.stop="openFilterMenu('ENDDATE', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-userid">
            <div class="th-inner">
              <span class="font-semibold">USER ID</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CREATEDBY', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-username">
            <div class="th-inner">
              <span class="font-semibold">User Name</span>
              <button class="filter-btn" @click.stop="openFilterMenu('USER_NAME', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-on">
            <div class="th-inner">
              <span class="font-semibold">On</span>
              <button class="filter-btn" @click.stop="openFilterMenu('CREATEDON', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <!-- NEW: Status & Comment -->
          <th class="col-status">
            <div class="th-inner">
              <span class="font-semibold">Status</span>
              <button class="filter-btn" @click.stop="openFilterMenu('STATUS', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>
          <th class="col-comment">
            <div class="th-inner">
              <span class="font-semibold">Comment</span>
              <button class="filter-btn" @click.stop="openFilterMenu('COMMENT', $event)" title="Filter">
                <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
              </button>
            </div>
          </th>

          <th class="col-actions"><span class="font-semibold">Actions</span></th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="req in filteredRequests" :key="req.REQUESTID" class="border-top">
          <td class="col-id">{{ req.REQUESTID }}</td>
          <td class="col-facility">{{ req.FACILITYID }}</td>
          <td class="col-facname cell-ellipsis" :title="req.FACILITYNAME">{{ req.FACILITYNAME }}</td>
          <td class="col-hours">{{ req.HOURSPERWEEK }}</td>
          <td class="col-craft">{{ req.CRAFT }}</td>
          <td class="col-ldc">{{ req.LABOURDISTRIBUTIONCODE }}</td>
          <td class="col-opnum">{{ req.OPERATIONNUMBER }}</td>
          <td class="col-just cell-ellipsis" :title="req.JUSTIFICATION">{{ req.JUSTIFICATION }}</td>
          <td class="col-start">{{ req.STARTDATE }}</td>
          <td class="col-end">{{ req.ENDDATE }}</td>
          <td class="col-userid">{{ req.CREATEDBY }}</td>
          <td class="col-username">{{ req.USER_FNAME }} {{ req.USER_LNAME }}</td>
          <td class="col-on">{{ req.CREATEDON }}</td>

          <!-- Status chip (admin style) -->
          <td class="col-status">
            <span :class="statusClass(req.STATUS)">{{ req.STATUS }}</span>
          </td>
          <!-- Latest comment (if any) -->
          <td class="col-comment cell-ellipsis" :title="req.COMMENT || ''">{{ req.COMMENT }}</td>

          <td class="col-actions">
            <div class="flex items-center gap-2">
              <button
  type="button"
  class="px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed"
  @click.stop.prevent="onEditClick(req)"
  :disabled="isLocked(req)"
  title="Edit this request"
>
  Edit
</button>

              <button
                class="px-3 py-1 rounded bg-red-600 text-white text-sm hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed"
                @click.prevent="confirmDelete(req)"
                :disabled="isLocked(req)"
                title="Delete this request"
              >Delete</button>
            </div>
            <div v-if="isLocked(req)" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-2V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
              Locked by admin
            </div>
          </td>
        </tr>
      </tbody>
    </table>




    <!-- Excel-style filter popover -->
    <div v-if="filterMenu.open"
         class="filter-pop"
         :style="{ left: filterMenu.x + 'px', top: filterMenu.y + 'px' }"
         ref="filterMenuRef">
      <h4>Filter: {{ filterMenu.field }}</h4>

      <!-- STATUS gets an exact-match dropdown -->
      <template v-if="filterMenu.field === 'STATUS'">
        <select
          class="w-full border rounded px-2 py-1 text-sm"
          :value="filters.STATUS"
          @change="onStatusChange($event)">
          <option value="">(All)</option>
          <option v-for="opt in statusOptions" :key="opt" :value="opt">{{ opt }}</option>
        </select>
      </template>

      <!-- Others = contains text -->
      <template v-else>
        <input v-model="filters[filterMenu.field]"
               class="w-full border rounded px-2 py-1 text-sm"
               placeholder="Type to filterâ€¦">
      </template>

      <div class="row">
        <button class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200"
                @click.stop="clearFilter(filterMenu.field)">
          Clear
        </button>
        <button class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                @click.stop="filterMenu.open=false">
          Close
        </button>
      </div>
    </div>
  </div>
</div>


<div v-if="showEditModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
    <h3 class="text-lg font-semibold mb-4">Edit Request #{{ editForm.requestId }}</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium">Hours / Week</label>
        <input type="number" step="0.01" min="0.01" max="100"
               v-model.number="editForm.hours" class="mt-1 w-full border rounded p-2">
      </div>


      <!-- <div>
        <label class="block text-sm font-medium">Start Date</label>
        <input type="date" v-model="editForm.startDate" class="mt-1 w-full border rounded p-2">
      </div>
      <div>
        <label class="block text-sm font-medium">End Date</label>
        <input type="date" v-model="editForm.endDate" class="mt-1 w-full border rounded p-2">
      </div> -->

      <!-- Start Week (Saturday) -->
      <div>
        <label for="wk_start_edit" class="block text-sm font-medium">Start Week</label>
        <select
          id="wk_start_edit"
          v-model="editForm.wk_start"
          @change="onEditStartChange"
          class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
        >
          <option disabled value="">-------------</option>
          <option v-for="row in weekOptions" :key="row[0]+'-'+row[1]+'-s'"
                  :value="row[2]">Week {{ row[1] }}, {{ row[2] }} (Saturday)</option>
        </select>
      </div>

      <!-- End Week (Friday) -->
    <div>
      <label for="wk_end_edit" class="block text-sm font-medium">End Week</label>
      <select
        id="wk_end_edit"
        v-model="editForm.wk_end"
        @change="onEditEndChange"
        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
      >
        <option disabled value="">-------------</option>
        <option v-for="row in weekOptions" :key="row[0]+'-'+row[1]+'-e'"
                :value="row[3]">Week {{ row[1] }}, {{ row[3] }} (Friday)</option>
      </select>
    </div>

    <!-- Read-only confirmation of the concrete dates that will be saved -->
    <div class="md:col-span-2 text-xs text-gray-600">
      Start: <span class="font-medium">{{ editForm.startDate }}</span>
      &nbsp;â€¢&nbsp;
      End: <span class="font-medium">{{ editForm.endDate }}</span>
    </div>



      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Justification</label>
        <textarea rows="4" v-model="editForm.justification"
                  class="mt-1 w-full border rounded p-2"></textarea>
      </div>
    </div>

    <div class="flex items-center justify-end gap-2 mt-6">
      <button class="px-4 py-2 rounded border" @click="showEditModal=false">Cancel</button>
      <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700" @click="saveEdit">Save</button>
    </div>

    <p v-if="editStatus" class="mt-3 text-sm"
       :class="editStatusOK ? 'text-green-700':'text-red-700'">
      {{ editStatus }}
    </p>
  </div>
</div>



</div>



  </div>


  

  <!-- Dashboard script -->
  <script type="module" src="/ref/toolbox/flex/dashboard.js"></script>
</body>

</html>
